<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…ãƒ‘ãƒãƒ« - modoku-w</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #121212; color: #e0e0e0; }
        .container { max-width: 1000px; margin: auto; background: #1e1e1e; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
        h1, h2 { color: #ffffff; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .admin-section { margin-top: 40px; padding: 15px; border: 1px solid #333; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #252525; font-size: 0.9em; }
        th, td { border: 1px solid #383838; padding: 10px; text-align: left; }
        th { background: #333; color: #3498db; }
        .del-btn { background: #c0392b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .refresh-btn { float: right; padding: 8px 15px; background: #2980b9; color: white; border: none; border-radius: 4px; cursor: pointer; }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        input, textarea, select { padding: 10px; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        textarea { width: 100%; height: 80px; margin-top: 10px; }
        .post-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px; width: 100%; }
        .post-btn:hover { background: #2ecc71; }
        
        #loginSection { text-align: center; margin-top: 100px; }
        .thread-select { width: 100%; margin-top: 10px; }

        /* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨ */
        .flex-row { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px; }
        .flex-item { flex: 1; min-width: 200px; background: #252525; padding: 15px; border-radius: 6px; }
        .log-viewer { background: #000; color: #00ff00; padding: 10px; height: 150px; overflow-y: scroll; font-family: monospace; font-size: 12px; margin-top: 10px; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginSection">
        <h1>Admin Authentication</h1>
        <input type="password" id="adminInput" placeholder="Password">
        <button onclick="adminAuth()" style="padding: 10px 20px; cursor: pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="adminContent" style="display:none;">
        <button class="refresh-btn" onclick="loadAllData()">å…¨æ›´æ–°</button>
        <h1>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

        <div class="admin-section">
            <h2>ğŸ›¡ï¸ é˜²è¡›è¨­å®š & ãƒ­ã‚°</h2>
            <div class="flex-row">
                <div class="flex-item">
                    <p style="color: #e67e22; font-weight: bold;">NGãƒ¯ãƒ¼ãƒ‰è¿½åŠ </p>
                    <input type="text" id="ngInput" placeholder="ç¦æ­¢ç”¨èª" style="width: 70%;">
                    <button class="post-btn" style="width: 25%; margin:0;" onclick="updateSecurity('add_ng_word')">è¿½åŠ </button>
                    <div id="ngList" style="margin-top:10px; font-size:0.8em; color:#888;"></div>
                </div>
                <div class="flex-item">
                    <p style="color: #e67e22; font-weight: bold;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¦æ­¢(BAN)</p>
                    <input type="text" id="banInput" placeholder="åå‰" style="width: 70%;">
                    <button class="del-btn" style="width: 25%; padding: 10px 0;" onclick="updateSecurity('add_banned_user')">ç¦æ­¢</button>
                    <div id="banList" style="margin-top:10px; font-size:0.8em; color:#888;"></div>
                </div>
            </div>
            <p style="margin-top:15px; color:#3498db;">æ“ä½œå±¥æ­´ï¼ˆæœ€æ–°50ä»¶ï¼‰</p>
            <div id="logViewer" class="log-viewer">ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        </div>

        <div class="admin-section">
            <h2>ğŸ“¢ ãŠçŸ¥ã‚‰ã›ç®¡ç†</h2>
            <div style="background: #252525; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <p style="margin: 0 0 10px 0; color: #3498db; font-weight: bold;">æ–°è¦ãŠçŸ¥ã‚‰ã›æŠ•ç¨¿</p>
                <input type="text" id="newsTitleInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" style="width: 100%;">
                <textarea id="newsContentInput" placeholder="ãŠçŸ¥ã‚‰ã›ã®æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                <button class="post-btn" onclick="postNews()">ãŠçŸ¥ã‚‰ã›ã‚’å…¬é–‹ã™ã‚‹</button>
            </div>
            <p>æŠ•ç¨¿æ¸ˆã¿ãƒªã‚¹ãƒˆ</p>
            <table id="newsTable"><thead><tr><th>æ—¥ä»˜</th><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>æ“ä½œ</th></tr></thead><tbody id="newsListBody"></tbody></table>
        </div>

        <div class="admin-section">
            <h2>ğŸ§µ ã‚¹ãƒ¬ãƒƒãƒ‰æ²ç¤ºæ¿ç®¡ç†</h2>
            <p>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</p>
            <table id="threadTable"><thead><tr><th>ã‚¹ãƒ¬ãƒƒãƒ‰å</th><th>ä½œæˆè€…</th><th>æ“ä½œ</th></tr></thead><tbody id="threadListBody"></tbody></table>
            
            <p style="margin-top:20px;">ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®æŠ•ç¨¿ã‚’ç®¡ç†</p>
            <select id="threadSelector" class="thread-select" onchange="loadThreadPosts()"><option value="">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
            <table id="threadPostTable"><thead><tr><th>åå‰</th><th>æœ¬æ–‡</th><th>æ“ä½œ</th></tr></thead><tbody id="threadPostListBody"></tbody></table>
        </div>

        <div class="admin-section"><h2>ğŸ’¬ ãƒ¡ã‚¤ãƒ³æ²ç¤ºæ¿ç®¡ç†</h2><table id="postTable"><thead><tr><th>æ—¥æ™‚</th><th>åå‰</th><th>æœ¬æ–‡</th><th>æ“ä½œ</th></tr></thead><tbody id="postListBody"></tbody></table></div>
        
        <div class="admin-section"><h2>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2><table id="userTable"><thead><tr><th>ID</th><th>åå‰</th><th>æ“ä½œ</th></tr></thead><tbody id="userListBody"></tbody></table></div>
        
        <div class="admin-section">
            <h2>ğŸ–¼ï¸ ç”»åƒæ²ç¤ºæ¿ç®¡ç†</h2>
            <table id="galleryTable">
                <thead><tr><th>åå‰</th><th>æœ¬æ–‡</th><th>ç”»åƒ</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="galleryListBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // URLè¨­å®š
    const AUTH_GAS_URL    = "https://script.google.com/macros/s/AKfycbzzdPk8BxStCsLa0iyhkHeLp3AGnbcvn5FtMrFjRSIvO2aNXQZMdvlsdC44Mrmn6MZ7/exec";
    const BBS_GAS_URL     = "https://script.google.com/macros/s/AKfycbzOpcoQtkoLBCUhmfd4RPCV6BhQs8ngf9fLiXYE8ALgDmJsr_ic4LnrSyFj5ChgwJoRhQ/exec";
    const NEWS_GAS_URL    = "https://script.google.com/macros/s/AKfycbzOm_RDGEyq_kPsbER9GT4vTwZD68X39dgrZ0-udH1CyTN9sQcjW3_MgRmAd29BwLjIsQ/exec";
    const THREAD_GAS_URL  = "https://script.google.com/macros/s/AKfycbzNRFg-clJykjin35_EbMBiTzcdN73mHkqEuDfIQFaj-1Bf9ZSbwGGxnn4kBV8l25OBmw/exec";
    const GALLERY_GAS_URL = "https://script.google.com/macros/s/AKfycbwg-qyb79tkZq6u8K5NyHXt_7vivvqKgk5vt8lpzkjTM5rpd3G3Tx9jOLFs12i2Wqqp/exec";
    const ADMIN_SEC_URL   = "https://script.google.com/macros/s/AKfycbx5RTv_Lf_Fzs5L7c5Jly9z9KhkeLvjBAGScOK6Algg3hwiDOEL41Xi-en_YR_MryXOyA/exec"; 
    
    let currentAdminPass = "";

    async function adminAuth() {
        const pass = document.getElementById("adminInput").value;
        const res = await fetch(AUTH_GAS_URL, { method: "POST", body: JSON.stringify({ action: "admin_login", password: pass }) });
        const result = await res.json();
        if (result.success) {
            currentAdminPass = pass;
            document.getElementById("loginSection").style.display = "none";
            document.getElementById("adminContent").style.display = "block";
            loadAllData();
        } else { alert("èªè¨¼å¤±æ•—"); }
    }

    // é˜²è¡›è¨­å®šã®èª­ã¿è¾¼ã¿ã¨æ›´æ–°
    async function loadSecurityData() {
        try {
            const res = await fetch(`${ADMIN_SEC_URL}?action=get_security_data`);
            const data = await res.json();
            document.getElementById("ngList").innerText = "ç¾åœ¨: " + data.ngWords.join(", ");
            document.getElementById("banList").innerText = "ç¾åœ¨: " + data.bannedUsers.join(", ");
            document.getElementById("logViewer").innerHTML = data.logs.map(l => `[${l[0]}] ${l[1]}: ${l[2]}`).join("<br>");
        } catch(e) { console.log("Security data load failed"); }
    }

    async function updateSecurity(action) {
        let payload = { adminPass: currentAdminPass, action: action };
        if(action === 'add_ng_word') payload.word = document.getElementById("ngInput").value;
        else payload.userName = document.getElementById("banInput").value;

        const res = await fetch(ADMIN_SEC_URL, { method: "POST", body: JSON.stringify(payload) });
        if((await res.json()).success) {
            alert("æ›´æ–°ã—ã¾ã—ãŸ");
            loadSecurityData();
        }
    }

    async function loadAllData() {
        loadSecurityData(); // é˜²è¡›ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        
        fetch(AUTH_GAS_URL, { method: "POST", body: JSON.stringify({ action: "admin_get_users", adminPass: currentAdminPass }) }).then(r=>r.json()).then(d=>renderTable("userListBody", d.users, u=>`<td>${u.id}</td><td>${u.name}</td><td><button class="del-btn" onclick="deleteItem('${AUTH_GAS_URL}','admin_delete_user','targetId','${u.id}')">å‰Šé™¤</button></td>`));
        fetch(BBS_GAS_URL).then(r=>r.json()).then(d=>renderTable("postListBody", d, p=>`<td>${p.date}</td><td>${p.name}</td><td>${p.message}</td><td><button class="del-btn" onclick="deleteItem('${BBS_GAS_URL}','admin_delete_post','row',${p.row})">å‰Šé™¤</button></td>`));
        fetch(NEWS_GAS_URL).then(r=>r.json()).then(d=>renderTable("newsListBody", d, n=>`<td>${n.date}</td><td>${n.title}</td><td><button class="del-btn" onclick="deleteItem('${NEWS_GAS_URL}','admin_delete_news','row',${n.row})">å‰Šé™¤</button></td>`));

        const threadRes = await fetch(THREAD_GAS_URL);
        const threads = await threadRes.json();
        renderTable("threadListBody", threads, t => `<td>${t.threadName}</td><td>${t.creator}</td><td><button class="del-btn" onclick="deleteItem('${THREAD_GAS_URL}','admin_delete_thread','threadName','${t.threadName}')">ã‚¹ãƒ¬å‰Šé™¤</button></td>`);
        
        const selector = document.getElementById("threadSelector");
        selector.innerHTML = '<option value="">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        threads.forEach(t => selector.innerHTML += `<option value="${t.threadName}">${t.threadName}</option>`);

        fetch(GALLERY_GAS_URL).then(r=>r.json()).then(d=>renderTable("galleryListBody", d, g=>`
            <td>${g.name}</td>
            <td>${g.message.substring(0,15)}...</td>
            <td>${g.imageUrl ? `<a href="${g.imageUrl}" target="_blank">ç”»åƒ</a>` : "ãªã—"}</td>
            <td><button class="del-btn" onclick="deleteItem('${GALLERY_GAS_URL}','admin_delete_post','row',${g.row})">å‰Šé™¤</button></td>
        `));
    }

    // ãŠçŸ¥ã‚‰ã›æŠ•ç¨¿
    async function postNews() {
        const title = document.getElementById("newsTitleInput").value;
        const content = document.getElementById("newsContentInput").value;
        if (!title || !content) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        const res = await fetch(NEWS_GAS_URL, {
            method: "POST",
            body: JSON.stringify({ action: "post_news", title: title, content: content, adminPass: currentAdminPass })
        });
        if ((await res.json()).success) {
            alert("ãŠçŸ¥ã‚‰ã›ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ");
            document.getElementById("newsTitleInput").value = "";
            document.getElementById("newsContentInput").value = "";
            loadAllData();
        }
    }

    async function loadThreadPosts() {
        const threadId = document.getElementById("threadSelector").value;
        if(!threadId) return;
        const res = await fetch(`${THREAD_GAS_URL}?thread=${encodeURIComponent(threadId)}`);
        const posts = await res.json();
        renderTable("threadPostListBody", posts, p => `<td>${p.name}</td><td>${p.message}</td><td><button class="del-btn" onclick="deleteThreadPost('${threadId}', ${p.row})">å‰Šé™¤</button></td>`);
    }

    async function deleteThreadPost(threadId, row) {
        if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const res = await fetch(THREAD_GAS_URL, {
            method: "POST",
            body: JSON.stringify({ action: "admin_delete_thread_post", threadId: threadId, row: row, adminPass: currentAdminPass })
        });
        if((await res.json()).success) loadThreadPosts();
    }

    function renderTable(id, data, htmlFunc) {
        const b = document.getElementById(id); b.innerHTML = "";
        if(data && Array.isArray(data)) data.forEach(item => { const r = document.createElement("tr"); r.innerHTML = htmlFunc(item); b.appendChild(r); });
    }

    async function deleteItem(url, action, keyName, val) {
        if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const body = { action: action, adminPass: currentAdminPass };
        body[keyName] = val;
        const res = await fetch(url, { method: "POST", body: JSON.stringify(body) });
        if((await res.json()).success) loadAllData();
    }
</script>
</body>
</html>
