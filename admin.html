<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…ãƒ‘ãƒãƒ« - modoku-w</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #121212; color: #e0e0e0; }
        .container { max-width: 1000px; margin: auto; background: #1e1e1e; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
        h1, h2 { color: #ffffff; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .admin-section { margin-top: 40px; padding: 15px; border: 1px solid #333; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #252525; font-size: 0.9em; }
        th, td { border: 1px solid #383838; padding: 10px; text-align: left; }
        th { background: #333; color: #3498db; }
        .del-btn { background: #c0392b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .refresh-btn { float: right; padding: 8px 15px; background: #2980b9; color: white; border: none; border-radius: 4px; cursor: pointer; }
        input[type="password"] { padding: 10px; background: #2c2c2c; border: 1px solid #444; color: white; }
        #loginSection { text-align: center; margin-top: 100px; }
        .thread-select { padding: 10px; width: 100%; background: #2c2c2c; color: white; border: 1px solid #444; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginSection">
        <h1>Admin Authentication</h1>
        <input type="password" id="adminInput" placeholder="Password">
        <button onclick="adminAuth()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="adminContent" style="display:none;">
        <button class="refresh-btn" onclick="loadAllData()">å…¨æ›´æ–°</button>
        <h1>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

        <div class="admin-section">
            <h2>ğŸ§µ ã‚¹ãƒ¬ãƒƒãƒ‰æ²ç¤ºæ¿ç®¡ç†</h2>
            <p>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</p>
            <table id="threadTable"><thead><tr><th>ã‚¹ãƒ¬ãƒƒãƒ‰å</th><th>ä½œæˆè€…</th><th>æ“ä½œ</th></tr></thead><tbody id="threadListBody"></tbody></table>
            
            <p style="margin-top:20px;">ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®æŠ•ç¨¿ã‚’ç®¡ç†</p>
            <select id="threadSelector" class="thread-select" onchange="loadThreadPosts()"><option value="">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
            <table id="threadPostTable"><thead><tr><th>åå‰</th><th>æœ¬æ–‡</th><th>æ“ä½œ</th></tr></thead><tbody id="threadPostListBody"></tbody></table>
        </div>

        <div class="admin-section"><h2>æ²ç¤ºæ¿ç®¡ç†</h2><table id="postTable"><thead><tr><th>æ—¥æ™‚</th><th>åå‰</th><th>æœ¬æ–‡</th><th>æ“ä½œ</th></tr></thead><tbody id="postListBody"></tbody></table></div>
        <div class="admin-section"><h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2><table id="userTable"><thead><tr><th>ID</th><th>åå‰</th><th>æ“ä½œ</th></tr></thead><tbody id="userListBody"></tbody></table></div>
        <div class="admin-section"><h2>ãŠçŸ¥ã‚‰ã›ç®¡ç†</h2><table id="newsTable"><thead><tr><th>æ—¥ä»˜</th><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>æ“ä½œ</th></tr></thead><tbody id="newsListBody"></tbody></table></div>
    </div>
</div>

<script>
    const AUTH_GAS_URL   = "https://script.google.com/macros/s/AKfycbzzdPk8BxStCsLa0iyhkHeLp3AGnbcvn5FtMrFjRSIvO2aNXQZMdvlsdC44Mrmn6MZ7/exec";
    const BBS_GAS_URL    = "https://script.google.com/macros/s/AKfycbzOpcoQtkoLBCUhmfd4RPCV6BhQs8ngf9fLiXYE8ALgDmJsr_ic4LnrSyFj5ChgwJoRhQ/exec";
    const NEWS_GAS_URL   = "https://script.google.com/macros/s/AKfycbzOm_RDGEyq_kPsbER9GT4vTwZD68X39dgrZ0-udH1CyTN9sQcjW3_MgRmAd29BwLjIsQ/exec";
    const THREAD_GAS_URL = "https://script.google.com/macros/s/AKfycbzNRFg-clJykjin35_EbMBiTzcdN73mHkqEuDfIQFaj-1Bf9ZSbwGGxnn4kBV8l25OBmw/exec";

    let currentAdminPass = "";

    async function adminAuth() {
        const pass = document.getElementById("adminInput").value;
        const res = await fetch(AUTH_GAS_URL, { method: "POST", body: JSON.stringify({ action: "admin_login", password: pass }) });
        const result = await res.json();
        if (result.success) {
            currentAdminPass = pass;
            document.getElementById("loginSection").style.display = "none";
            document.getElementById("adminContent").style.display = "block";
            loadAllData();
        } else { alert("èªè¨¼å¤±æ•—"); }
    }

    async function loadAllData() {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»æ²ç¤ºæ¿ãƒ»ãŠçŸ¥ã‚‰ã›ã®å–å¾—ï¼ˆä»¥å‰ã¨åŒæ§˜ï¼‰
        fetch(AUTH_GAS_URL, { method: "POST", body: JSON.stringify({ action: "admin_get_users", adminPass: currentAdminPass }) }).then(r=>r.json()).then(d=>renderTable("userListBody", d.users, u=>`<td>${u.id}</td><td>${u.name}</td><td><button class="del-btn" onclick="deleteItem('${AUTH_GAS_URL}','admin_delete_user','targetId','${u.id}')">å‰Šé™¤</button></td>`));
        fetch(BBS_GAS_URL).then(r=>r.json()).then(d=>renderTable("postListBody", d, p=>`<td>${p.date}</td><td>${p.name}</td><td>${p.message}</td><td><button class="del-btn" onclick="deleteItem('${BBS_GAS_URL}','admin_delete_post','row',${p.row})">å‰Šé™¤</button></td>`));
        fetch(NEWS_GAS_URL).then(r=>r.json()).then(d=>renderTable("newsListBody", d, n=>`<td>${n.date}</td><td>${n.title}</td><td><button class="del-btn" onclick="deleteItem('${NEWS_GAS_URL}','admin_delete_news','row',${n.row})">å‰Šé™¤</button></td>`));

        // ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ã®å–å¾—
        const threadRes = await fetch(THREAD_GAS_URL);
        const threads = await threadRes.json();
        renderTable("threadListBody", threads, t => `<td>${t.threadName}</td><td>${t.creator}</td><td><button class="del-btn" onclick="deleteItem('${THREAD_GAS_URL}','admin_delete_thread','threadName','${t.threadName}')">ã‚¹ãƒ¬å‰Šé™¤</button></td>`);
        
        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®æ›´æ–°
        const selector = document.getElementById("threadSelector");
        selector.innerHTML = '<option value="">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        threads.forEach(t => selector.innerHTML += `<option value="${t.threadName}">${t.threadName}</option>`);
    }

    // é¸æŠã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®æŠ•ç¨¿ã‚’è¡¨ç¤º
    async function loadThreadPosts() {
        const threadId = document.getElementById("threadSelector").value;
        if(!threadId) return;
        const res = await fetch(`${THREAD_GAS_URL}?thread=${encodeURIComponent(threadId)}`);
        const posts = await res.json();
        renderTable("threadPostListBody", posts, p => `<td>${p.name}</td><td>${p.message}</td><td><button class="del-btn" onclick="deleteThreadPost('${threadId}', ${p.row})">å‰Šé™¤</button></td>`);
    }

    async function deleteThreadPost(threadId, row) {
        if(!confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const res = await fetch(THREAD_GAS_URL, {
            method: "POST",
            body: JSON.stringify({ action: "admin_delete_thread_post", threadId: threadId, row: row, adminPass: currentAdminPass })
        });
        if((await res.json()).success) loadThreadPosts();
    }

    function renderTable(id, data, htmlFunc) {
        const b = document.getElementById(id); b.innerHTML = "";
        if(data) data.forEach(item => { const r = document.createElement("tr"); r.innerHTML = htmlFunc(item); b.appendChild(r); });
    }

    async function deleteItem(url, action, keyName, val) {
        if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const body = { action: action, adminPass: currentAdminPass };
        body[keyName] = val;
        const res = await fetch(url, { method: "POST", body: JSON.stringify(body) });
        if((await res.json()).success) loadAllData();
    }
</script>
</body>
</html>
