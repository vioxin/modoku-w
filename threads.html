<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER THREADS - modoku-w</title>
    <style>
        /* ===== 0. ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ•°å®šç¾©ï¼ˆã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ä»•æ§˜ï¼‰ ===== */
        :root {
            --main-bg: #050510;           /* æ·±ã„ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ«ãƒ¼ */
            --text-color: #ffffff;        /* ç™½ */
            --primary: #00f3ff;           /* ã‚·ã‚¢ãƒ³ï¼ˆãƒã‚ªãƒ³ï¼‰ */
            --secondary: #bc13fe;         /* ãƒ‘ãƒ¼ãƒ—ãƒ«ï¼ˆãƒã‚ªãƒ³ï¼‰ */
            --accent-color: var(--secondary);
            --glass-bg: rgba(255, 255, 255, 0.03); /* ã‚¬ãƒ©ã‚¹é¢¨èƒŒæ™¯ */
            --border-color: rgba(0, 243, 255, 0.3);
            --font-main: "Helvetica Neue", Arial, sans-serif;
        }

        /* ===== 1. å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« & ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ ===== */
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-main);
            background-color: var(--main-bg);
            color: var(--text-color);
            margin: 0;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* èƒŒæ™¯Canvas (ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«) */
        #canvas-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.6;
        }
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .loader-circle {
            width: 50px; height: 50px; border: 3px solid transparent; border-top-color: var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        .loader-circle:before { content: ""; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px; border-radius: 50%; border: 3px solid transparent; border-top-color: var(--secondary); animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .side-menu {
            height: 100%; width: 0; position: fixed; z-index: 1000; top: 0; left: 0;
            background: rgba(5, 5, 16, 0.95); backdrop-filter: blur(10px);
            border-right: 1px solid var(--primary); overflow-x: hidden; transition: 0.3s;
            padding-top: 60px; overflow-y: auto; padding-bottom: 20px;
        }
        .side-menu.open { box-shadow: 0 0 50px rgba(0, 243, 255, 0.2); }
        .side-menu a {
            padding: 15px 30px; text-decoration: none; font-size: 16px; color: #fff; display: block;
            transition: 0.3s; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .side-menu a:hover { background: var(--primary); color: #000; padding-left: 40px; }
        .side-menu .close-btn { position: absolute; top: 10px; right: 25px; font-size: 36px; cursor: pointer; color: var(--primary); }
        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒœã‚¿ãƒ³ */
        .menu-btn {
            font-size: 30px; cursor: pointer; position: fixed; top: 15px; left: 15px; z-index: 900;
            color: var(--primary); text-shadow: 0 0 10px var(--primary);
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content { padding: 80px 20px 20px; max-width: 900px; margin: 0 auto; position: relative; z-index: 1; }
        
        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 30px;
        }
        h1#page-title {
            font-size: 2rem; margin: 0; text-transform: uppercase; letter-spacing: 2px; color: #fff;
            text-shadow: 0 0 10px var(--primary);
        }

        /* ã‚«ãƒ¼ãƒ‰ãƒ»ã‚¢ã‚¤ãƒ†ãƒ é¡ (3D Tilt & Glassmorphism) */
        .card, .thread-item, .post-card {
            background: var(--glass-bg); padding: 25px; border-radius: 15px;
            margin-bottom: 25px; border: 1px solid var(--border-color);
            backdrop-filter: blur(5px); transition: transform 0.1s, box-shadow 0.3s, background 0.3s;
            transform-style: preserve-3d; position: relative;
        }
        .tilt-effect:hover { box-shadow: 0 0 30px rgba(0, 243, 255, 0.2); border-color: var(--primary); }
        
        .thread-item { cursor: pointer; }
        .thread-item:hover { background: rgba(0, 243, 255, 0.1); }
        .thread-item b { font-size: 1.2rem; color: var(--primary); }

        .card h3 { color: var(--secondary); margin-top: 0; text-transform: uppercase; letter-spacing: 1px; }

        /* æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰ */
        .res-num { color: var(--secondary); font-weight: bold; margin-right: 10px; font-family: monospace; }
        .anchor { color: var(--secondary); text-decoration: none; border-bottom: 1px dashed var(--secondary); }
        .post-card:target { animation: highlight-post 2s ease-out; }
        @keyframes highlight-post {
            0% { background-color: rgba(188, 19, 254, 0.3); box-shadow: 0 0 30px var(--secondary); }
            100% { background-color: var(--glass-bg); }
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ãƒœã‚¿ãƒ³ */
        input, textarea {
            width: 100%; padding: 15px; margin-top: 15px;
            background: rgba(0, 0, 0, 0.5); border: 1px solid var(--border-color);
            color: var(--primary); border-radius: 5px; box-sizing: border-box;
            font-family: monospace; transition: 0.3s;
        }
        input:focus, textarea:focus { outline: none; box-shadow: 0 0 15px var(--primary); border-color: var(--primary); }

        .btn-primary {
            background: linear-gradient(45deg, var(--secondary), var(--primary)); color: white;
            padding: 15px; border: none; border-radius: 50px; width: 100%; cursor: pointer;
            font-weight: bold; margin-top: 20px; transition: 0.3s; font-size: 1.1rem;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 0 30px var(--secondary); }

        .btn-refresh, .back-btn {
            background: transparent; border: 1px solid var(--primary); color: var(--primary);
            padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: 0.3s; font-family: monospace;
        }
        .btn-refresh:hover, .back-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }
        
        .hidden { display: none; }
        .refresh-status { font-size: 0.9em; color: var(--primary); margin-right: 10px; font-family: monospace; }
    </style>
</head>
<body>
    <canvas id="canvas-bg"></canvas>
    <div id="loader"><div class="loader-circle"></div></div>

    <div class="menu-btn" onclick="toggleMenu()">â˜°</div>

    <div id="side-menu" class="side-menu">
        <span class="close-btn" onclick="toggleMenu()">Ã—</span>
        <a href="index.html">ãƒˆãƒƒãƒ—æ²ç¤ºæ¿</a>
        <a href="news.html">ãŠçŸ¥ã‚‰ã›</a>
        <a href="threads.html" style="color: var(--primary); font-weight: bold; text-shadow: 0 0 5px var(--primary);">ã‚¹ãƒ¬ãƒƒãƒ‰æ²ç¤ºæ¿</a>
        <a href="gallery.html">ç”»åƒæ²ç¤ºæ¿</a>
        <a href="admin.html">ç®¡ç†è€…ãƒ‘ãƒãƒ«</a>
    </div>

    <div class="main-content">
        <header>
            <h1 id="page-title">ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h1>
            <div>
                <span id="status-label" class="refresh-status"></span>
                <button class="btn-refresh" onclick="refreshCurrentView()">ğŸ”„ SYSTEM RELOAD</button>
            </div>
        </header>

        <div id="thread-list-view">
            <div class="card tilt-effect">
                <h3>CREATE NEW THREAD (æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ)</h3>
                <input type="text" id="newThreadName" placeholder="THREAD TITLE (ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«)">
                <input type="text" id="creatorName" placeholder="CREATOR NAME (ã‚ãªãŸã®åå‰)">
                <button class="btn-primary" onclick="createThread()">INITIALIZE THREAD</button>
            </div>
            <div id="list-container"></div>
        </div>

        <div id="thread-detail-view" class="hidden">
            <button class="back-btn" onclick="showThreadList()" style="margin-bottom: 20px;">â† RETURN TO LIST</button>
            <div class="card tilt-effect">
                <h3 id="current-thread-label"></h3>
                <input type="text" id="userName" placeholder="ACCESS NAME (åå‰)">
                <textarea id="postMessage" placeholder="DATA INPUT (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ› >>ç•ªå· ã§ã‚¢ãƒ³ã‚«ãƒ¼å¯èƒ½)"></textarea>
                <button class="btn-primary" onclick="postToThread()">TRANSMIT DATA</button>
            </div>
            <div id="posts-container"></div>
        </div>
    </div>

<script>
    // ==========================================
    // 0. è¿½åŠ ï¼šãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨JS
    // ==========================================
    window.addEventListener('load', () => {
        const loader = document.getElementById('loader');
        loader.style.opacity = '0'; setTimeout(() => { loader.style.display = 'none'; }, 500);
    });

    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let particlesArray; let mouse = { x: null, y: null, radius: (canvas.height/80)*(canvas.width/80) }
    window.addEventListener('mousemove', (event) => { mouse.x = event.x; mouse.y = event.y; });
    class Particle {
        constructor(x,y,dx,dy,size,color){this.x=x;this.y=y;this.directionX=dx;this.directionY=dy;this.size=size;this.color=color;}
        draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2,false);ctx.fillStyle='#00f3ff';ctx.fill();}
        update(){
            if(this.x>canvas.width||this.x<0)this.directionX=-this.directionX;
            if(this.y>canvas.height||this.y<0)this.directionY=-this.directionY;
            let dx=mouse.x-this.x;let dy=mouse.y-this.y;let distance=Math.sqrt(dx*dx+dy*dy);
            if(distance<mouse.radius+this.size){
                if(mouse.x<this.x&&this.x<canvas.width-this.size*10)this.x+=10;
                if(mouse.x>this.x&&this.x>this.size*10)this.x-=10;
                if(mouse.y<this.y&&this.y<canvas.height-this.size*10)this.y+=10;
                if(mouse.y>this.y&&this.y>this.size*10)this.y-=10;
            }
            this.x+=this.directionX;this.y+=this.directionY;this.draw();
        }
    }
    function initParticles(){
        particlesArray=[];let numberOfParticles=(canvas.height*canvas.width)/9000;
        for(let i=0;i<numberOfParticles;i++){
            let size=(Math.random()*2)+1;let x=(Math.random()*((innerWidth-size*2)-(size*2))+size*2);
            let y=(Math.random()*((innerHeight-size*2)-(size*2))+size*2);let dx=(Math.random()*2)-1;let dy=(Math.random()*2)-1;
            particlesArray.push(new Particle(x,y,dx,dy,size,'#00f3ff'));
        }
    }
    function animateParticles(){requestAnimationFrame(animateParticles);ctx.clearRect(0,0,innerWidth,innerHeight);for(let i=0;i<particlesArray.length;i++){particlesArray[i].update();}connectParticles();}
    function connectParticles(){
        let opacityValue=1;for(let a=0;a<particlesArray.length;a++){for(let b=a;b<particlesArray.length;b++){
            let distance=((particlesArray[a].x-particlesArray[b].x)*(particlesArray[a].x-particlesArray[b].x))+((particlesArray[a].y-particlesArray[b].y)*(particlesArray[a].y-particlesArray[b].y));
            if(distance<(canvas.width/7)*(canvas.height/7)){opacityValue=1-(distance/20000);ctx.strokeStyle='rgba(188,19,254,'+opacityValue+')';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(particlesArray[a].x,particlesArray[a].y);ctx.lineTo(particlesArray[b].x,particlesArray[b].y);ctx.stroke();}
        }}
    }
    window.addEventListener('resize',()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;mouse.radius=(canvas.height/80)*(canvas.width/80);initParticles();});
    initParticles();animateParticles();

    // 3Dãƒãƒ«ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆé©ç”¨é–¢æ•°
    function applyTiltEffect() {
        document.querySelectorAll('.tilt-effect').forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left; const y = e.clientY - rect.top;
                const centerX = rect.width / 2; const centerY = rect.height / 2;
                const rotateX = ((y - centerY) / centerY) * -5; const rotateY = ((x - centerX) / centerX) * 5;
                card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });
            card.addEventListener('mouseleave', () => { card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg)`; });
        });
    }
    // åˆæœŸè¡¨ç¤ºã®ã‚«ãƒ¼ãƒ‰ã«é©ç”¨
    applyTiltEffect();

    // ==========================================
    // å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—)
    // ==========================================
    const THREAD_GAS_URL = "https://script.google.com/macros/s/AKfycbzNRFg-clJykjin35_EbMBiTzcdN73mHkqEuDfIQFaj-1Bf9ZSbwGGxnn4kBV8l25OBmw/exec"; 
    let currentThreadId = "";

    function toggleMenu() {
        const menu = document.getElementById("side-menu");
        menu.style.width = menu.style.width === "250px" ? "0" : "250px";
    }

    window.onload = () => {
        loadThreads(true);
        loadThreads(false);
    };

    function formatMessage(text) {
        if (!text) return "";
        const escaped = text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return escaped.replace(/&gt;&gt;(\d+)/g, '<a href="#post-$1" class="anchor">>>$1</a>');
    }

    function refreshCurrentView() {
        if (currentThreadId === "") loadThreads(false);
        else loadPosts(false);
    }

    async function loadThreads(useCache = false) {
        const cacheKey = "cached_thread_list";
        if (useCache) {
            const cached = localStorage.getItem(cacheKey);
            if (cached) renderThreads(JSON.parse(cached));
            return;
        }
        const statusLabel = document.getElementById('status-label');
        if(statusLabel) statusLabel.innerText = "SYNCING...";
        try {
            const res = await fetch(THREAD_GAS_URL);
            const threads = await res.json();
            localStorage.setItem(cacheKey, JSON.stringify(threads));
            renderThreads(threads);
            if(statusLabel) statusLabel.innerText = "ONLINE / LATEST";
        } catch (e) {
            if(statusLabel) statusLabel.innerText = "CONNECTION ERROR";
        }
    }

    function renderThreads(threads) {
        const container = document.getElementById('list-container');
        if (!container) return;
        container.innerHTML = '';
        threads.forEach(t => {
            const div = document.createElement('div');
            div.className = 'thread-item tilt-effect'; // tilt-effectã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            div.onclick = () => showThreadDetail(t.threadName);
            div.innerHTML = `<b>${t.threadName}</b><br><small style="color:var(--primary); opacity:0.7;">CREATOR: ${t.creator || 'UNKNOWN'} | ${t.date || ''}</small>`;
            container.appendChild(div);
        });
        applyTiltEffect(); // å‹•çš„ã«è¿½åŠ ã•ã‚ŒãŸè¦ç´ ã«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é©ç”¨
    }

    function showThreadDetail(name) {
        currentThreadId = name;
        document.getElementById('thread-list-view').classList.add('hidden');
        document.getElementById('thread-detail-view').classList.remove('hidden');
        document.getElementById('page-title').innerText = name;
        document.getElementById('current-thread-label').innerText = "POST TO: " + name;
        loadPosts(true);
        loadPosts(false);
    }

    async function loadPosts(useCache = false) {
        const cacheKey = "cached_posts_" + currentThreadId;
        if (useCache) {
            const cached = localStorage.getItem(cacheKey);
            if (cached) renderPosts(JSON.parse(cached));
            return;
        }
        try {
            const res = await fetch(`${THREAD_GAS_URL}?thread=${encodeURIComponent(currentThreadId)}`);
            const posts = await res.json();
            localStorage.setItem(cacheKey, JSON.stringify(posts));
            renderPosts(posts);
        } catch (e) { console.error("Posts fetch error"); }
    }

    function renderPosts(posts) {
        const container = document.getElementById('posts-container');
        if (!container) return;
        container.innerHTML = '';
        posts.forEach(p => {
            const div = document.createElement('div');
            div.className = 'post-card tilt-effect'; // tilt-effectã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            div.id = `post-${p.id}`;
            div.innerHTML = `
                <div style="font-size:0.9em; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">
                    <span class="res-num">#${p.id}</span>
                    <b style="color:var(--primary)">${p.name}</b> <span style="color:#888; margin-left:10px; font-family:monospace;">${p.date}</span>
                </div>
                <div style="white-space:pre-wrap; word-break: break-all; color:#ddd;">${formatMessage(p.message)}</div>
            `;
            container.appendChild(div);
        });
        applyTiltEffect(); // å‹•çš„ã«è¿½åŠ ã•ã‚ŒãŸè¦ç´ ã«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é©ç”¨
    }

    function showThreadList() {
        currentThreadId = "";
        document.getElementById('thread-list-view').classList.remove('hidden');
        document.getElementById('thread-detail-view').classList.add('hidden');
        document.getElementById('page-title').innerText = "ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§";
        loadThreads(true);
    }
    const userId = localStorage.getItem("userId");
    const userName = localStorage.getItem("userName");
    async function createThread() {
        const name = document.getElementById('newThreadName').value;
        const creator = document.getElementById('creatorName').value;
        
        if (!userId) { alert("LOGIN REQUIRED"); return; }
        if(!name || !creator) return alert("INPUT MISSING");
        
        // IPå–å¾—ã®éåŒæœŸå‡¦ç†ã‚’ä¿®æ­£
        let currentIp = 'unknown';
        try {
             const ipRes = await fetch('https://api.ipify.org?format=json');
             const ipData = await ipRes.json();
             currentIp = ipData.ip;
        } catch(e) { console.log("IP fetch failed"); }

        const res = await fetch(THREAD_GAS_URL, {
            method: "POST",
            body: JSON.stringify({ action: "create_thread", threadName: name, creator: creator, userip: currentIp, userid: userId })
        });
        const result = await res.json();
        if(result.success) {
            document.getElementById('newThreadName').value = "";
            loadThreads(false);
            alert("THREAD CREATED");
        } else {
            if (result.errorType === "EMOJI_RESTRICTED") { alert("ğŸš¨ " + result.msg); } else { alert("ERROR: " + result.msg); }
        }
    }

    async function postToThread() {
        const name = document.getElementById('userName').value;
        const msg = document.getElementById('postMessage').value;
        if(!name || !msg) return alert("INPUT MISSING");
        if (!userId) { alert("LOGIN REQUIRED"); return; }

        // IPå–å¾—ã®éåŒæœŸå‡¦ç†ã‚’ä¿®æ­£
        let currentIp = 'unknown';
        try {
             const ipRes = await fetch('https://api.ipify.org?format=json');
             const ipData = await ipRes.json();
             currentIp = ipData.ip;
        } catch(e) { console.log("IP fetch failed"); }

        const res = await fetch(THREAD_GAS_URL, {
            method: "POST",
            body: JSON.stringify({ threadId: currentThreadId, name: name, message: msg, userip: currentIp, userid: userId })
        });
        const result = await res.json();
        if(result.success) {
            document.getElementById('postMessage').value = "";
            loadPosts(false);
            alert("DATA TRANSMITTED");
        } else {
            if (result.errorType === "EMOJI_RESTRICTED") { alert("ğŸš¨ " + result.msg); } else { alert("ERROR: " + result.msg); }
        }
    }
</script>
</body>
</html>
