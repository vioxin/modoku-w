<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒæ²ç¤ºæ¿ - modoku-w</title>
    <link rel="stylesheet" href="style.css"> 
    <style>
        .image-preview { max-width: 100%; height: 200px; border: 2px dashed #333; margin-top: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; color: #888; }
        .image-preview img { max-width: 100%; max-height: 100%; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .post-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .post-item img { width: 100%; border-radius: 5px; margin-top: 10px; cursor: pointer; transition: 0.3s; border: 1px solid #444; }
        .post-item img:hover { opacity: 0.8; transform: scale(1.02); }
        
        /* å†èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .refresh-area { text-align: right; margin-bottom: 10px; }
        .btn-refresh { 
            background: #2980b9; color: white; border: none; padding: 8px 15px; 
            border-radius: 4px; cursor: pointer; font-size: 14px; transition: 0.3s;
        }
        .btn-refresh:hover { background: #3498db; }
        .btn-refresh:disabled { background: #555; cursor: not-allowed; }

        .loading-text { color: #ffcc00; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity:1; } 50% { opacity:0.5; } 100% { opacity:1; } }
    </style>
</head>
<body>

<div class="menu-btn" onclick="toggleMenu()">â˜°</div>
<div class="side-menu" id="side-menu">
    <div class="close-btn" onclick="toggleMenu()">Ã—</div>
    <ul>
        <li><a href="index.html">æ²ç¤ºæ¿ãƒˆãƒƒãƒ—</a></li>
        <li><a href="threads.html">ã‚¹ãƒ¬ãƒƒãƒ‰æ²ç¤ºæ¿</a></li>
        <li><a href="gallery.html">ç”»åƒæ²ç¤ºæ¿</a></li>
        <li><a href="admin.html">ç®¡ç†è€…</a></li>
    </ul>
</div>

<header>
    <h1>ç”»åƒæ²ç¤ºæ¿</h1>
</header>

<section>
    <div class="input-group admin-card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;">
        <h2>ç”»åƒã‚’æŠ•ç¨¿ã™ã‚‹</h2>
        <input type="text" id="userName" placeholder="åå‰">
        <textarea id="userMsg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›"></textarea>
        
        <input type="file" id="imageInput" accept="image/*" onchange="previewImage(this)" style="margin-top:10px;">
        <div class="image-preview" id="previewBox">ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        
        <button id="postBtn" onclick="postImageMessage()">æŠ•ç¨¿ã™ã‚‹</button>
    </div>

    <hr style="border: 0; border-top: 1px solid #333; margin: 30px 0;">

    <div class="refresh-area">
        <span id="loadStatus" class="sync-text" style="margin-right: 10px;"></span>
        <button id="refreshBtn" class="btn-refresh" onclick="loadGallery()">ğŸ”„ æœ€æ–°ã«æ›´æ–°</button>
    </div>

    <div id="messageList" class="gallery-grid">
        <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
</section>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwg-qyb79tkZq6u8K5NyHXt_7vivvqKgk5vt8lpzkjTM5rpd3G3Tx9jOLFs12i2Wqqp/exec";

    // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    function previewImage(input) {
        const box = document.getElementById('previewBox');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                box.innerHTML = `<img src="${e.target.result}">`;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // æŠ•ç¨¿å‡¦ç†
    async function postImageMessage() {
        const name = document.getElementById("userName").value;
        const msg = document.getElementById("userMsg").value;
        const fileInput = document.getElementById("imageInput");
        const btn = document.getElementById("postBtn");

        if (!name || !msg) return alert("åå‰ã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        let base64Image = null;
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if (file.size > 5 * 1024 * 1024) return alert("ç”»åƒãŒå¤§ãã™ãã¾ã™(5MBã¾ã§)");
            
            base64Image = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        }

        btn.disabled = true;
        btn.innerText = "é€ä¿¡ä¸­...";

        try {
            await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ name: name, message: msg, imageFile: base64Image })
            });
            // æŠ•ç¨¿å¾Œã€ãƒªãƒ­ãƒ¼ãƒ‰ã›ãšã«ãƒªã‚¹ãƒˆã ã‘æ›´æ–°ã™ã‚‹
            alert("æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸ");
            document.getElementById("userMsg").value = "";
            document.getElementById("imageInput").value = "";
            document.getElementById("previewBox").innerHTML = "ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼";
            loadGallery(); 
        } catch (e) {
            alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
        } finally {
            btn.disabled = false;
            btn.innerText = "æŠ•ç¨¿ã™ã‚‹";
        }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ãƒ»æç”»ï¼ˆå†èª­ã¿è¾¼ã¿å¯¾å¿œï¼‰
    async function loadGallery() {
        const list = document.getElementById("messageList");
        const status = document.getElementById("loadStatus");
        const refBtn = document.getElementById("refreshBtn");

        status.innerHTML = '<span class="loading-text">æ›´æ–°ä¸­...</span>';
        refBtn.disabled = true;

        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            list.innerHTML = "";

            if (!data || data.length === 0) {
                list.innerHTML = "<p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
            } else {
                data.forEach(item => {
                    const div = document.createElement("div");
                    div.className = "post-item";
                    div.innerHTML = `
                        <div class="post-header">
                            <span class="post-name">${item.name} ã•ã‚“</span>
                        </div>
                        <div class="post-text" style="margin: 10px 0;">${item.message}</div>
                        ${item.imageUrl ? `<a href="${item.imageUrl}" target="_blank"><img src="${item.imageUrl}" loading="lazy"></a>` : ""}
                        <div class="post-date" style="font-size: 11px; color: #888; margin-top:10px;">${item.date}</div>
                    `;
                    list.appendChild(div);
                });
            }
            status.innerText = "æœ€æ–°ã®çŠ¶æ…‹ã§ã™";
        } catch (e) {
            status.innerText = "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
            console.error(e);
        } finally {
            refBtn.disabled = false;
            setTimeout(() => { if(status.innerText === "æœ€æ–°ã®çŠ¶æ…‹ã§ã™") status.innerText = ""; }, 3000);
        }
    }

    window.onload = loadGallery;
    
    function toggleMenu() {
        document.getElementById("side-menu").classList.toggle("open");
    }
</script>
</body>
</html>
