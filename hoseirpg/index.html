<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ã»ã†ã›ã„RPG 3 ã€œå¤§è‡ªç„¶ã¨è³‡æœ¬ä¸»ç¾©ã€œ</title>
<style>
    :root {
        --bg-color: #202020;
        --screen-bg: #e0f0e0;
        --ui-bg: #333;
        --text-color: #fff;
        --accent: #4caf50;
        --danger: #ff5252;
        /* ãƒãƒƒãƒ—ã®1ãƒã‚¹ã®ã‚µã‚¤ã‚º */
        --tile-size: 32px;
    }
    
    * { box-sizing: border-box; touch-action: manipulation; }
    
    body {
        background: var(--bg-color);
        color: var(--text-color);
        font-family: 'Courier New', monospace;
        margin: 0;
        /* dvhã‚’ä½¿ã†ã“ã¨ã§ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã‚’é™¤ã„ãŸé«˜ã•ã‚’å–å¾— */
        height: 100dvh; 
        width: 100vw;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
    }

    /* --- ãƒ¡ã‚¤ãƒ³ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    #game-boy {
        width: 100%;
        max-width: 600px;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: #444;
        border: 2px solid #666;
        padding: 5px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°‘ã—æ¸›ã‚‰ã™ */
    }

    /* ç”»é¢éƒ¨åˆ† (ã“ã“ã‚’ä¼¸ç¸®å¯èƒ½ã«ã™ã‚‹) */
    #screen-area {
        flex: 1; 
        min-height: 0; /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¢ã‚¤ãƒ†ãƒ ãŒç¸®ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹é‡è¦è¨­å®š */
        background: var(--screen-bg);
        border: 4px solid #222;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        color: #000;
        image-rendering: pixelated;
        margin-bottom: 5px;
    }

    #status-bar {
        background: #222;
        color: #fff;
        padding: 4px;
        font-size: 11px;
        display: flex;
        justify-content: space-between;
        z-index: 10;
        border-bottom: 2px solid #000;
        flex-shrink: 0; /* ç¸®ã¾ã›ãªã„ */
    }

    /* ãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    #viewport {
        flex: 1; /* ä½™ã£ãŸã‚¹ãƒšãƒ¼ã‚¹ã‚’åŸ‹ã‚ã‚‹ */
        position: relative;
        overflow: hidden;
        background: #333; /* ãƒãƒƒãƒ—å¤–ã®è‰² */
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* ãƒãƒƒãƒ—ã®å®Ÿä½“ï¼ˆä¸­å¤®é…ç½®ï¼‰ */
    #map-container {
        position: relative;
        /* JSã§ã‚µã‚¤ã‚ºã‚’è¨­å®šã™ã‚‹ */
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    .tile {
        position: absolute;
        width: var(--tile-size);
        height: var(--tile-size);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        line-height: 1;
    }
    
    #player-sprite {
        position: absolute;
        width: var(--tile-size);
        height: var(--tile-size);
        font-size: 24px;
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 1;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚° */
    #log-window {
        height: 70px; /* å°‘ã—é«˜ã•ã‚’æ¸›ã‚‰ã™ */
        background: rgba(0,0,0,0.85);
        color: #fff;
        font-size: 13px;
        padding: 5px;
        overflow-y: auto;
        border-top: 2px solid #fff;
        flex-shrink: 0; /* ç¸®ã¾ã›ãªã„ */
    }
    .log-sys { color: #aaa; }
    .log-warn { color: #ffeb3b; }
    .log-bad { color: #ff5252; }

    /* --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ --- */
    #controls {
        height: auto; /* é«˜ã•ã¯ä¸­èº«ã«åˆã‚ã›ã‚‹ */
        min-height: 180px; /* æœ€ä½é™ã®é«˜ã•ã‚’ç¢ºä¿ */
        background: #444;
        display: grid;
        grid-template-columns: 1fr 1fr;
        padding: 5px;
        gap: 10px;
        flex-shrink: 0; /* ç¸®ã¾ã›ãªã„ */
    }

    .d-pad {
        display: grid;
        grid-template-columns: 50px 50px 50px;
        grid-template-rows: 50px 50px 50px;
        gap: 2px;
        align-self: center;
        justify-self: center;
    }
    
    .btn-pad {
        background: #222;
        border-radius: 6px;
        border: 2px solid #111;
        box-shadow: 0 3px 0 #000;
        cursor: pointer;
        color: #555;
        font-size: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
    }
    .btn-pad:active { transform: translateY(3px); box-shadow: none; background: #333; }
    
    .action-pad {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 8px;
    }

    .menu-btn {
        width: 100%;
        max-width: 140px;
        padding: 10px;
        background: #555;
        color: white;
        border: 2px solid #fff;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        box-shadow: 0 3px 0 #222;
    }
    .menu-btn:active { transform: translateY(3px); box-shadow: none; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
        display: none;
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 100;
        color: white;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
    }
    .modal-header { font-size: 1.4rem; border-bottom: 2px solid var(--accent); margin-bottom: 10px; padding-bottom: 5px; font-weight: bold;}
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 1rem; }
    .skill-item, .job-item { background: #333; border: 1px solid #666; padding: 10px; margin-bottom: 8px; cursor: pointer; border-radius: 5px; }
    .btn-close { margin-top: 15px; padding: 12px; width: 100%; background: var(--danger); border: none; color: white; font-weight: bold; font-size: 1.1rem; border-radius: 6px; }
    .save-area { display: flex; gap: 10px; margin-top: 15px; }
    .save-btn { flex: 1; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 6px; font-weight: bold; }
    .event-btn { width: 100%; padding: 12px; margin-bottom: 8px; background: #eee; color: #000; border: none; border-radius: 5px; font-size: 0.95rem; text-align: left; font-family: monospace; }
</style>
</head>
<body>

<div id="game-boy">
    <div id="screen-area">
        <div id="status-bar">
            <span>LV:<span id="ui-lv">1</span></span>
            <span>HP:<span id="ui-hp">100</span></span>
            <span>Â¥:<span id="ui-money">0</span></span>
            <span><span id="ui-job">ãƒ‹ãƒ¼ãƒˆ</span></span>
        </div>
        <div id="viewport">
            <div id="map-container">
                <div id="map-layer"></div>
                <div id="player-sprite">ğŸ˜</div>
            </div>
        </div>
        <div id="log-window">
            <div>ã‚ˆã†ã“ãã€ã»ã†ã›ã„RPG3ã¸ã€‚</div>
            <div>ã¾ãšã¯ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã‚ˆã†ã€‚</div>
        </div>
    </div>

    <div id="controls">
        <div class="d-pad">
            <div></div><button class="btn-pad" onclick="game.move(0, -1)">â–²</button><div></div>
            <button class="btn-pad" onclick="game.move(-1, 0)">â—€</button>
            <button class="btn-pad" onclick="game.interact()" style="background:#e91e63; color:white; border-color:#c2185b;">A</button>
            <button class="btn-pad" onclick="game.move(1, 0)">â–¶</button>
            <div></div><button class="btn-pad" onclick="game.move(0, 1)">â–¼</button><div></div>
        </div>
        <div class="action-pad">
            <button class="menu-btn" onclick="ui.openMenu()">ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
            <button class="menu-btn" onclick="ui.openSkill()">âš¡ ã‚¹ã‚­ãƒ«</button>
            <button class="menu-btn" style="background:#4caf50; border-color:#388e3c" onclick="game.saveGame()">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
        </div>
    </div>
</div>

<div id="modal-menu" class="modal">
    <div class="modal-header">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
    <div class="stat-grid">
        <div>åå‰: ã»ã†ã›ã„</div>
        <div>è·æ¥­: <span id="st-job">ãƒ‹ãƒ¼ãƒˆ</span></div>
        <div>ãƒ¬ãƒ™ãƒ«: <span id="st-lv">1</span></div>
        <div>çµŒé¨“å€¤: <span id="st-xp">0</span> / <span id="st-next">100</span></div>
        <div>æ‰€æŒé‡‘: <span id="st-money">0</span>å††</div>
        <div>ã‚¹ãƒˆãƒ¬ã‚¹: <span id="st-stress">0</span>%</div>
        <div>ä½“åŠ›: <span id="st-hp">100</span> / <span id="st-maxhp">100</span></div>
        <div>ã‚¹ã‚­ãƒ«P: <span id="st-sp">0</span></div>
        <div>ã‚«ãƒ«ãƒ: <span id="st-karma">0</span></div>
    </div>
    <div class="save-area">
        <button class="save-btn" onclick="game.saveGame()">ã‚»ãƒ¼ãƒ–</button>
        <button class="save-btn" onclick="game.loadGame()" style="background:#ff9800">ãƒ­ãƒ¼ãƒ‰</button>
    </div>
    <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
</div>

<div id="modal-skill" class="modal">
    <div class="modal-header">ã‚¹ã‚­ãƒ«ç¿’å¾— (SP: <span id="sk-sp">0</span>)</div>
    <div id="skill-list"></div>
    <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
</div>

<div id="modal-event" class="modal">
    <div class="modal-header" id="ev-title">ã‚¤ãƒ™ãƒ³ãƒˆ</div>
    <div id="ev-body" style="margin-bottom: 20px; font-size: 1rem; line-height: 1.5;">å†…å®¹</div>
    <div id="ev-actions"></div>
    <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
</div>

<script>
/**
 * ã»ã†ã›ã„RPG 3 Core Logic (Tablet Fixed)
 */

const TILE_SIZE = 32;
const VIEW_W = 15; // æ¨ªã®è¡¨ç¤ºæ•°
const VIEW_H = 9;  // ç¸¦ã®è¡¨ç¤ºæ•°ï¼ˆ11ã‹ã‚‰9ã«æ¸›ã‚‰ã—ã¦é«˜ã•ã‚’ç¢ºä¿ï¼‰
const MAP_W = 40;  
const MAP_H = 40;  

// ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
const mapContainer = document.getElementById('map-container');
mapContainer.style.width = (VIEW_W * TILE_SIZE) + 'px';
mapContainer.style.height = (VIEW_H * TILE_SIZE) + 'px';

// åœ°å½¢ã‚¿ã‚¤ãƒ—
const TERRAIN = {
    GRASS: { id: 0, icon: '', bg: '#8bc34a', name: 'è‰åŸ', walk: true },
    FOREST: { id: 1, icon: 'ğŸŒ²', bg: '#2e7d32', name: 'æ£®', walk: true, cost: 2 },
    WATER:  { id: 2, icon: 'ğŸŒŠ', bg: '#2196f3', name: 'å·', walk: false },
    MOUNTAIN:{ id: 3, icon: 'â›°ï¸', bg: '#795548', name: 'å±±', walk: true, cost: 3 },
    CITY:   { id: 4, icon: '', bg: '#9e9e9e', name: 'å¸‚è¡—åœ°', walk: true },
    WALL:   { id: 5, icon: 'ğŸ§±', bg: '#555', name: 'å£', walk: false },
    HOME:   { id: 10, icon: 'ğŸ ', bg: '#ffeb3b', name: 'å®Ÿå®¶', type: 'spot' },
    WORK:   { id: 11, icon: 'ğŸ¢', bg: '#607d8b', name: 'ãƒãƒ­ãƒ¼ãƒ¯ãƒ¼ã‚¯', type: 'spot' },
    SHOP:   { id: 12, icon: 'ğŸª', bg: '#ff9800', name: 'ã‚³ãƒ³ãƒ“ãƒ‹', type: 'spot' },
    SLUM:   { id: 13, icon: 'ğŸšï¸', bg: '#3e2723', name: 'ã‚¹ãƒ©ãƒ è¡—', type: 'spot' },
    SHRINE: { id: 14, icon: 'â›©ï¸', bg: '#e91e63', name: 'ç¥ç¤¾', type: 'spot' }
};

const JOBS = {
    neet: { name: "ãƒ‹ãƒ¼ãƒˆ", reqLv: 0, skill: null, desc: "åŸºæœ¬è·ã€‚ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§ãŒä½ã„ã€‚" },
    parttime: { name: "ã‚³ãƒ³ãƒ“ãƒ‹åº—å“¡", reqLv: 1, skill: "smile", desc: "ä½è³ƒé‡‘ã ãŒå®‰å®šã€‚" },
    can: { name: "ç©ºãç¼¶æ‹¾ã„", reqLv: 2, skill: "survival", desc: "ä½“åŠ›ã‚’ä½¿ã†ãŒè‡ªç”±ãªä»•äº‹ã€‚" },
    writer: { name: "Webãƒ©ã‚¤ã‚¿ãƒ¼", reqLv: 5, skill: "typing", desc: "ã‚¹ã‚­ãƒ«ã€Œã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã€ãŒå¿…è¦ã€‚" },
    host: { name: "ãƒ›ã‚¹ãƒˆ", reqLv: 8, skill: "charm", desc: "ã‚¹ã‚­ãƒ«ã€Œé­…åŠ›ã€ãŒå¿…è¦ã€‚é«˜åå…¥ã€‚" },
    scammer: { name: "å—ã‘å­", reqLv: 1, skill: "criminal", desc: "ã€é—‡è·ã€‘æ•ã¾ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã€‚" },
};

const SKILLS = {
    survival: { name: "ã‚µãƒã‚¤ãƒãƒ«", cost: 1, max: 5, desc: "æ£®ã‚„å±±ã§ã®ç§»å‹•ã‚³ã‚¹ãƒˆæ¸›ï¼†ã‚¢ã‚¤ãƒ†ãƒ ç™ºè¦‹ç‡UP" },
    smile: { name: "å–¶æ¥­ã‚¹ãƒã‚¤ãƒ«", cost: 1, max: 3, desc: "æ¥å®¢ãƒã‚¤ãƒˆã®åå…¥ãŒå°‘ã—ã‚¢ãƒƒãƒ—" },
    typing: { name: "ã‚¿ã‚¤ãƒ”ãƒ³ã‚°", cost: 2, max: 5, desc: "ãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯è·ã®è§£æ”¾ï¼†åŠ¹ç‡UP" },
    guts: { name: "æ ¹æ€§", cost: 3, max: 5, desc: "æœ€å¤§HPã¨ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§ãŒã‚¢ãƒƒãƒ—" },
    charm: { name: "é­…åŠ›", cost: 3, max: 5, desc: "äººã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’è²°ã„ã‚„ã™ããªã‚‹" },
    negotiation: { name: "äº¤æ¸‰è¡“", cost: 4, max: 3, desc: "å ±é…¬ã®ã¤ã‚Šä¸Šã’ãŒå¯èƒ½" },
    criminal: { name: "è£ã®çŸ¥è­˜", cost: 5, max: 1, desc: "ã‚¹ãƒ©ãƒ è¡—ã§ã®å–å¼•ãŒå¯èƒ½ã«ãªã‚‹" }
};

let state = {
    x: 20, y: 20,
    lv: 1, xp: 0, nextXp: 100, sp: 0,
    hp: 100, maxHp: 100,
    money: 1000,
    stress: 0,
    karma: 0,
    job: 'neet',
    skills: {},
    flags: {},
    mapData: []
};

const game = {
    init: function() {
        this.generateMap();
        this.renderMap();
        ui.update();
        game.log("ã‚²ãƒ¼ãƒ é–‹å§‹ï¼");
    },

    generateMap: function() {
        state.mapData = [];
        for(let y=0; y<MAP_H; y++){
            let row = [];
            for(let x=0; x<MAP_W; x++){
                let noise = Math.sin(x/5) + Math.cos(y/5) + Math.random()*0.5;
                let type = TERRAIN.GRASS.id;
                if (noise > 1.5) type = TERRAIN.MOUNTAIN.id;
                else if (noise > 0.8) type = TERRAIN.FOREST.id;
                else if (noise < -1.0) type = TERRAIN.WATER.id;
                
                let dist = Math.sqrt((x-20)**2 + (y-20)**2);
                if(dist < 8) type = TERRAIN.CITY.id;
                row.push(type);
            }
            state.mapData.push(row);
        }
        this.setTile(20, 20, TERRAIN.HOME.id);
        this.setTile(20, 18, TERRAIN.WORK.id);
        this.setTile(22, 20, TERRAIN.SHOP.id);
        this.setTile(10, 30, TERRAIN.SLUM.id);
        this.setTile(30, 10, TERRAIN.SHRINE.id);
    },

    setTile: function(x, y, id) {
        if(x>=0 && x<MAP_W && y>=0 && y<MAP_H) state.mapData[y][x] = id;
    },

    getTile: function(x, y) {
        if(x<0 || x>=MAP_W || y<0 || y>=MAP_H) return TERRAIN.WALL;
        let id = state.mapData[y][x];
        return Object.values(TERRAIN).find(t => t.id === id) || TERRAIN.GRASS;
    },

    move: function(dx, dy) {
        if(ui.isModalOpen) return;
        let nx = state.x + dx;
        let ny = state.y + dy;
        let tile = this.getTile(nx, ny);
        if(!tile.walk && tile.type !== 'spot') {
            game.log("ãã“ã¯é€šã‚Œãªã„ã€‚", "sys");
            return;
        }
        let cost = tile.cost || 1;
        let survivalLv = state.skills.survival || 0;
        if(tile.id === TERRAIN.FOREST.id || tile.id === TERRAIN.MOUNTAIN.id) {
            cost = Math.max(1, cost - survivalLv);
        }
        state.hp -= cost;
        state.x = nx;
        state.y = ny;
        this.gainXp(1);
        if(Math.random() < 0.05) this.randomEncounter(tile);
        this.renderMap();
        ui.update();
        this.checkGameOver();
    },

    interact: function() {
        if(ui.isModalOpen) return;
        let tile = this.getTile(state.x, state.y);
        if(tile.id === TERRAIN.HOME.id) this.eventHome();
        else if(tile.id === TERRAIN.WORK.id) this.eventHelloWork();
        else if(tile.id === TERRAIN.SHOP.id) this.eventShop();
        else if(tile.id === TERRAIN.SLUM.id) this.eventSlum();
        else if(tile.id === TERRAIN.SHRINE.id) this.eventShrine();
        else game.log("è¶³å…ƒã«ã¯ä½•ã‚‚ãªã„ã€‚");
    },

    gainXp: function(amount) {
        state.xp += amount;
        if(state.xp >= state.nextXp) {
            state.lv++;
            state.xp -= state.nextXp;
            state.nextXp = Math.floor(state.nextXp * 1.2);
            state.sp += 3;
            state.maxHp += 10;
            state.hp = state.maxHp;
            game.log(`ã€ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ã€‘Lv${state.lv}ã«ãªã£ãŸï¼`, "warn");
        }
    },

    checkGameOver: function() {
        if(state.hp <= 0) {
            alert("ã€é‡å‚ã‚Œæ­»ã«ã€‘\nä½“åŠ›ãŒå°½ãã¾ã—ãŸ...");
            state.hp = state.maxHp;
            state.money = Math.floor(state.money / 2);
            state.x = 20; state.y = 20;
            game.log("ç—…é™¢ã§ç›®ãŒè¦šã‚ãŸã€‚æ‰€æŒé‡‘åŠæ¸›ã€‚", "bad");
            this.renderMap();
        }
        if(state.stress >= 100) {
            game.log("ã‚¹ãƒˆãƒ¬ã‚¹ã§ç™ºç‹‚ã—ã€æ•£è²¡ã—ãŸï¼", "bad");
            state.money = Math.max(0, state.money - 30000);
            state.stress = 0;
        }
        this.checkEnding();
    },

    checkEnding: function() {
        if(state.money >= 1000000) {
            alert("ã€GOOD ENDã€‘100ä¸‡å††è²¯ã‚ãŸï¼");
            this.reset();
        } else if(state.skills.survival >= 5 && state.lv >= 30 && state.x < 5 && state.y < 5) {
            alert("ã€TRUE ENDã€‘æ£®ã§è‡ªç”±ã«æš®ã‚‰ã—ãŸã€‚");
            this.reset();
        } else if(state.karma <= -100 && state.money >= 500000) {
            alert("ã€BAD ENDã€‘è£ç¤¾ä¼šã®å¸ç‹ã«ãªã£ãŸã€‚");
            this.reset();
        }
    },

    reset: function() {
        localStorage.removeItem('houseiRPG3_save');
        location.reload();
    },

    renderMap: function() {
        const layer = document.getElementById('map-layer');
        layer.innerHTML = '';
        
        let startX = state.x - Math.floor(VIEW_W/2);
        let startY = state.y - Math.floor(VIEW_H/2);

        for(let y=0; y<VIEW_H; y++) {
            for(let x=0; x<VIEW_W; x++) {
                let mapX = startX + x;
                let mapY = startY + y;
                let tile = this.getTile(mapX, mapY);
                let div = document.createElement('div');
                div.className = 'tile';
                div.style.left = (x * TILE_SIZE) + 'px';
                div.style.top = (y * TILE_SIZE) + 'px';
                div.innerText = tile.icon;
                div.style.backgroundColor = tile.bg;
                layer.appendChild(div);
            }
        }
        
        let face = "ğŸ˜";
        if(state.job === 'host') face = "ğŸ˜";
        if(state.job === 'scammer') face = "ğŸ•¶ï¸";
        if(state.stress > 80) face = "ğŸ˜±";
        if(state.hp < 20) face = "ğŸ¤¢";
        document.getElementById('player-sprite').innerText = face;
        
        const sprite = document.getElementById('player-sprite');
        sprite.style.left = (Math.floor(VIEW_W/2) * TILE_SIZE) + 'px';
        sprite.style.top = (Math.floor(VIEW_H/2) * TILE_SIZE) + 'px';
    },

    log: function(msg, type) {
        const box = document.getElementById('log-window');
        const div = document.createElement('div');
        div.innerText = msg;
        if(type) div.className = 'log-' + type;
        box.insertBefore(div, box.firstChild);
    },

    saveGame: function() {
        localStorage.setItem('houseiRPG3_save', JSON.stringify(state));
        alert("ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼");
    },

    loadGame: function() {
        const data = localStorage.getItem('houseiRPG3_save');
        if(data) {
            state = JSON.parse(data);
            this.renderMap();
            ui.update();
            ui.closeAll();
            alert("ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
        } else {
            alert("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        }
    },

    randomEncounter: function(tile) {
        if(tile.id === TERRAIN.CITY.id) {
            game.log("ã‚­ãƒ£ãƒƒãƒã‚’ç„¡è¦–ã—ãŸã€‚", "sys");
            state.stress += 5;
        } else if(tile.id === TERRAIN.FOREST.id) {
            game.log("èŠ±ã‚’è¦‹ã¦ç™’ã‚„ã•ã‚ŒãŸã€‚", "sys");
            state.stress = Math.max(0, state.stress - 10);
        } else if(tile.id === TERRAIN.SLUM.id) {
            game.log("å°éŠ­ã‚’ç›—ã¾ã‚ŒãŸï¼", "bad");
            state.money = Math.max(0, state.money - 500);
        }
    },

    eventHome: function() {
        ui.showEvent("å®Ÿå®¶", `
            <p>å®‰æ¯ã®åœ°ã€‚</p>
            <button class="event-btn" onclick="ui.doAction('sleep')">ğŸ›Œ å¯ã‚‹ (å›å¾©)</button>
            <button class="event-btn" onclick="ui.doAction('pc')">ğŸ’» ãƒãƒƒãƒˆ (ã‚¹ãƒˆãƒ¬ã‚¹è§£æ¶ˆ)</button>
        `);
    },

    eventHelloWork: function() {
        let html = "<p>è·æ¥­ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>";
        for(let key in JOBS) {
            let j = JOBS[key];
            if(key === 'hero' || key === 'scammer') continue;
            html += `<div class="job-item" onclick="ui.doAction('job', '${key}')">
                <b>${j.name}</b> (Lv${j.reqLv}ã€œ)<br><small>${j.desc}</small>
            </div>`;
        }
        ui.showEvent("ãƒãƒ­ãƒ¼ãƒ¯ãƒ¼ã‚¯", html);
    },

    eventShop: function() {
        ui.showEvent("ã‚³ãƒ³ãƒ“ãƒ‹", `
            <button class="event-btn" onclick="ui.doAction('buy', 'food')">ğŸ± å¼å½“ (300å††/HP+50)</button>
            <button class="event-btn" onclick="ui.doAction('buy', 'drink')">ğŸº é…’ (200å††/ã‚¹ãƒˆãƒ¬ã‚¹-30)</button>
            <button class="event-btn" onclick="ui.doAction('work_parttime')">ğŸ’° ãƒã‚¤ãƒˆ (3æ™‚é–“)</button>
        `);
    },

    eventSlum: function() {
        if(state.skills.criminal >= 1) {
            ui.showEvent("ã‚¹ãƒ©ãƒ ", `
                <button class="event-btn" onclick="ui.doAction('job', 'scammer')">ğŸ˜ˆ é—‡ãƒã‚¤ãƒˆ</button>
            `);
        } else {
            game.log("æ€–ãã¦è¿‘ã¥ã‘ãªã„... (è¦ã‚¹ã‚­ãƒ«)", "sys");
        }
    },
    
    eventShrine: function() {
        ui.showEvent("ç¥ç¤¾", `
            <button class="event-btn" onclick="ui.doAction('pray', 100)">ğŸ™ ç¥ˆã‚‹ (-100å††)</button>
            <button class="event-btn" onclick="ui.doAction('pray', -100)">ğŸ’° ç›—ã‚€ (+500å††/ã‚«ãƒ«ãƒâ†“)</button>
        `);
    }
};

const ui = {
    isModalOpen: false,

    update: function() {
        document.getElementById('ui-lv').innerText = state.lv;
        document.getElementById('ui-hp').innerText = state.hp;
        document.getElementById('ui-money').innerText = state.money;
        document.getElementById('ui-job').innerText = JOBS[state.job].name;
    },

    openMenu: function() {
        this.isModalOpen = true;
        document.getElementById('modal-menu').style.display = 'flex';
        document.getElementById('st-job').innerText = JOBS[state.job].name;
        document.getElementById('st-lv').innerText = state.lv;
        document.getElementById('st-xp').innerText = state.xp;
        document.getElementById('st-next').innerText = state.nextXp;
        document.getElementById('st-money').innerText = state.money;
        document.getElementById('st-stress').innerText = state.stress;
        document.getElementById('st-hp').innerText = state.hp;
        document.getElementById('st-maxhp').innerText = state.maxHp;
        document.getElementById('st-sp').innerText = state.sp;
        document.getElementById('st-karma').innerText = state.karma;
    },

    openSkill: function() {
        this.isModalOpen = true;
        document.getElementById('modal-skill').style.display = 'flex';
        document.getElementById('sk-sp').innerText = state.sp;
        const list = document.getElementById('skill-list');
        list.innerHTML = "";
        for(let key in SKILLS) {
            let s = SKILLS[key];
            let currentLv = state.skills[key] || 0;
            let cls = currentLv > 0 ? "skill-item skill-owned" : "skill-item";
            list.innerHTML += `
                <div class="${cls}" onclick="ui.learnSkill('${key}')">
                    <b>${s.name}</b> (Lv.${currentLv}/${s.max})<br>SP:${s.cost} <small>${s.desc}</small>
                </div>`;
        }
    },

    learnSkill: function(key) {
        let s = SKILLS[key];
        let currentLv = state.skills[key] || 0;
        if(currentLv >= s.max) return alert("æœ€å¤§ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚");
        if(state.sp < s.cost) return alert("SPä¸è¶³ã§ã™ã€‚");
        if(confirm(`ç¿’å¾—ã—ã¾ã™ã‹ï¼Ÿ`)) {
            state.sp -= s.cost;
            state.skills[key] = currentLv + 1;
            game.log(`${s.name}ç¿’å¾—ï¼`, "warn");
            this.openSkill();
        }
    },

    showEvent: function(title, html) {
        this.isModalOpen = true;
        document.getElementById('modal-event').style.display = 'flex';
        document.getElementById('ev-title').innerText = title;
        document.getElementById('ev-body').innerHTML = html;
    },

    closeAll: function() {
        this.isModalOpen = false;
        document.querySelectorAll('.modal').forEach(e => e.style.display = 'none');
    },

    doAction: function(act, param) {
        let success = true;
        if(act === 'sleep') {
            state.hp = state.maxHp;
            state.stress = Math.max(0, state.stress - 20);
            game.log("å¯ãŸã€‚");
        } else if(act === 'pc') {
            state.stress = Math.max(0, state.stress - 40);
            game.log("ãƒ¬ã‚¹ãƒã—ãŸã€‚");
        } else if(act === 'buy') {
            if(param === 'food' && state.money >= 300) {
                state.money -= 300; state.hp = Math.min(state.maxHp, state.hp + 50); game.log("å¼å½“ã‚’é£Ÿã¹ãŸã€‚");
            } else if(param === 'drink' && state.money >= 200) {
                state.money -= 200; state.stress = Math.max(0, state.stress - 30); game.log("é…’ã‚’é£²ã‚“ã ã€‚");
            } else { alert("é‡‘ä¸è¶³ï¼"); success = false; }
        } else if(act === 'job') {
            let j = JOBS[param];
            if(state.lv < j.reqLv) { alert("ãƒ¬ãƒ™ãƒ«ä¸è¶³"); success = false; }
            else if(j.skill && !state.skills[j.skill]) { alert("ã‚¹ã‚­ãƒ«ä¸è¶³"); success = false; }
            else { state.job = param; game.log("è»¢è·ã—ãŸï¼", "warn"); if(param==='scammer') state.karma-=50; }
        } else if(act === 'work_parttime') {
            if(state.job === 'neet') { alert("ãƒ‹ãƒ¼ãƒˆã¯åƒã‘ãªã„"); success = false; }
            else {
                let earn = (state.job==='host'?10000:state.job==='scammer'?50000:1000) + (state.skills.smile?500*state.skills.smile:0);
                if(state.job==='scammer' && Math.random()<0.2) { earn=0; game.log("è­¦å¯Ÿã ï¼é€ƒã’ãŸï¼", "bad"); }
                state.money += earn; state.stress += 10; state.hp -= 20; game.gainXp(10);
                game.log(`${earn}å††ç¨¼ã„ã ã€‚`);
            }
        } else if(act === 'pray') {
            if(param > 0) {
                if(state.money>=100) { state.money-=100; state.karma+=10; game.log("ç¥ˆã£ãŸã€‚"); }
            } else { state.money+=500; state.karma-=20; game.log("ç›—ã‚“ã ï¼", "bad"); }
        }
        if(success) this.closeAll();
        this.update();
        game.checkGameOver();
    }
};

window.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowUp') game.move(0, -1);
    if(e.key === 'ArrowDown') game.move(0, 1);
    if(e.key === 'ArrowLeft') game.move(-1, 0);
    if(e.key === 'ArrowRight') game.move(1, 0);
    if(e.key === 'z' || e.key === 'Enter') game.interact();
});

game.init();
</script>
</body>
</html>
