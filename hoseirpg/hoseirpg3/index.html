<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ã»ã†ã›ã„RPG 3 ã€œå¤§è‡ªç„¶ã¨è³‡æœ¬ä¸»ç¾©ã€œ</title>
<style>
    :root {
        --bg-color: #202020;
        --screen-bg: #e0f0e0; /* ãƒ¬ãƒˆãƒ­æ¶²æ™¶é¢¨ */
        --ui-bg: #333;
        --text-color: #fff;
        --accent: #4caf50;
        --danger: #ff5252;
    }
    
    * { box-sizing: border-box; touch-action: manipulation; }
    
    body {
        background: var(--bg-color);
        color: var(--text-color);
        font-family: 'Courier New', monospace;
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
    }

    /* --- ãƒ¡ã‚¤ãƒ³ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    #game-boy {
        width: 100%;
        max-width: 600px; /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘ã«å°‘ã—å¹…åºƒã« */
        height: 100%;
        display: flex;
        flex-direction: column;
        background: #444;
        border: 2px solid #666;
        padding: 10px;
    }

    /* ç”»é¢éƒ¨åˆ† */
    #screen-area {
        flex: 1; /* å¯å¤‰é«˜ã• */
        background: var(--screen-bg);
        border: 4px solid #222;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        color: #000;
        image-rendering: pixelated;
        min-height: 300px;
    }

    #status-bar {
        background: #222;
        color: #fff;
        padding: 4px;
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        z-index: 10;
        border-bottom: 2px solid #000;
    }

    #viewport {
        flex: 1;
        position: relative;
        overflow: hidden;
        background: #88c070; /* è‰åŸã®è‰² */
    }

    /* ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ« */
    .tile {
        position: absolute;
        width: 32px;
        height: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
    }
    
    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
    #player-sprite {
        position: absolute;
        width: 32px;
        height: 32px;
        font-size: 24px;
        z-index: 5;
        transition: top 0.1s, left 0.1s;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚° */
    #log-window {
        height: 80px;
        background: rgba(0,0,0,0.85);
        color: #fff;
        font-size: 14px;
        padding: 8px;
        overflow-y: auto;
        border-top: 2px solid #fff;
    }
    .log-sys { color: #aaa; }
    .log-warn { color: #ffeb3b; }
    .log-bad { color: #ff5252; }

    /* --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ --- */
    #controls {
        height: 220px; /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆæ“ä½œç”¨ã«åºƒã‚ã« */
        background: #444;
        display: grid;
        grid-template-columns: 1fr 1fr;
        padding: 10px;
        gap: 20px;
    }

    .d-pad {
        display: grid;
        grid-template-columns: 60px 60px 60px;
        grid-template-rows: 60px 60px 60px;
        gap: 5px;
        align-self: center;
        justify-self: center;
    }
    
    .btn-pad {
        background: #222;
        border-radius: 8px;
        border: 2px solid #111;
        box-shadow: 0 4px 0 #000;
        cursor: pointer;
        color: #555;
        font-size: 24px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .btn-pad:active { transform: translateY(4px); box-shadow: none; background: #333; }
    
    .action-pad {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 15px;
    }

    .menu-btn {
        width: 140px;
        padding: 12px;
        background: #555;
        color: white;
        border: 2px solid #fff;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 4px 0 #222;
    }
    .menu-btn:active { transform: translateY(4px); box-shadow: none; }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€åº—) --- */
    .modal {
        display: none;
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 100;
        color: white;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
    }
    
    .modal-header { font-size: 1.5rem; border-bottom: 2px solid var(--accent); margin-bottom: 15px; padding-bottom: 5px; font-weight: bold;}
    
    .stat-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
        font-size: 1.1rem;
    }
    
    .skill-item, .job-item {
        background: #333;
        border: 1px solid #666;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        border-radius: 8px;
    }
    .skill-item:hover, .job-item:hover { background: #555; }
    .skill-owned { border-color: var(--accent); color: var(--accent); }

    .btn-close {
        margin-top: 20px; padding: 15px; width: 100%; background: var(--danger); border: none; color: white; font-weight: bold; font-size: 1.2rem; border-radius: 8px;
    }
    
    .save-area { display: flex; gap: 10px; margin-top: 20px; }
    .save-btn { flex: 1; padding: 15px; background: #2196f3; color: white; border: none; border-radius: 8px; font-weight: bold; }

    /* Event buttons */
    .event-btn {
        width: 100%;
        padding: 15px;
        margin-bottom: 10px;
        background: #eee;
        color: #000;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        text-align: left;
        font-family: monospace;
    }
    .event-btn:active { background: #ccc; }

</style>
</head>
<body>

<div id="game-boy">
    <div id="screen-area">
        <div id="status-bar">
            <span>LV:<span id="ui-lv">1</span></span>
            <span>HP:<span id="ui-hp">100</span></span>
            <span>Â¥:<span id="ui-money">0</span></span>
            <span><span id="ui-job">ãƒ‹ãƒ¼ãƒˆ</span></span>
        </div>
        <div id="viewport">
            <div id="map-layer"></div>
            <div id="player-sprite">ğŸ˜</div>
        </div>
        <div id="log-window">
            <div>ã‚ˆã†ã“ãã€ã»ã†ã›ã„RPG3ã¸ã€‚</div>
            <div>ã¾ãšã¯ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã‚ˆã†ã€‚</div>
        </div>
    </div>

    <div id="controls">
        <div class="d-pad">
            <div></div><button class="btn-pad" onclick="game.move(0, -1)">â–²</button><div></div>
            <button class="btn-pad" onclick="game.move(-1, 0)">â—€</button>
            <button class="btn-pad" onclick="game.interact()" style="background:#e91e63; color:white; border-color:#c2185b;">A</button>
            <button class="btn-pad" onclick="game.move(1, 0)">â–¶</button>
            <div></div><button class="btn-pad" onclick="game.move(0, 1)">â–¼</button><div></div>
        </div>
        <div class="action-pad">
            <button class="menu-btn" onclick="ui.openMenu()">ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
            <button class="menu-btn" onclick="ui.openSkill()">âš¡ ã‚¹ã‚­ãƒ«</button>
            <button class="menu-btn" style="background:#4caf50; border-color:#388e3c" onclick="game.saveGame()">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
        </div>
    </div>
</div>

<div id="modal-menu" class="modal">
    <div class="modal-header">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
    <div class="stat-grid">
        <div>åå‰: ã»ã†ã›ã„</div>
        <div>è·æ¥­: <span id="st-job">ãƒ‹ãƒ¼ãƒˆ</span></div>
        <div>ãƒ¬ãƒ™ãƒ«: <span id="st-lv">1</span></div>
        <div>çµŒé¨“å€¤: <span id="st-xp">0</span> / <span id="st-next">100</span></div>
        <div>æ‰€æŒé‡‘: <span id="st-money">0</span>å††</div>
        <div>ã‚¹ãƒˆãƒ¬ã‚¹: <span id="st-stress">0</span>%</div>
        <div>ä½“åŠ›: <span id="st-hp">100</span> / <span id="st-maxhp">100</span></div>
        <div>ã‚¹ã‚­ãƒ«P: <span id="st-sp">0</span></div>
        <div>ã‚«ãƒ«ãƒ: <span id="st-karma">0</span></div>
    </div>
    <div style="font-size:0.9rem; color:#aaa; margin-bottom:10px;">â€»ã‚«ãƒ«ãƒ(å–„æ‚ªå€¤)ã«ã‚ˆã‚Šã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãŒåˆ†å²ã—ã¾ã™ã€‚</div>
    
    <div class="save-area">
        <button class="save-btn" onclick="game.saveGame()">ã‚»ãƒ¼ãƒ–</button>
        <button class="save-btn" onclick="game.loadGame()" style="background:#ff9800">ãƒ­ãƒ¼ãƒ‰</button>
    </div>
    <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
</div>

<div id="modal-skill" class="modal">
    <div class="modal-header">ã‚¹ã‚­ãƒ«ç¿’å¾— (æ®‹ã‚ŠSP: <span id="sk-sp">0</span>)</div>
    <div id="skill-list"></div>
    <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
</div>

<div id="modal-event" class="modal">
    <div class="modal-header" id="ev-title">ã‚¤ãƒ™ãƒ³ãƒˆ</div>
    <div id="ev-body" style="margin-bottom: 20px; font-size: 1.1rem; line-height: 1.5;">å†…å®¹</div>
    <div id="ev-actions"></div>
    <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
</div>

<script>
/**
 * ã»ã†ã›ã„RPG 3 Core Logic (Tablet Optimized)
 */

// --- å®šæ•°ã¨ãƒ‡ãƒ¼ã‚¿ ---
const TILE_SIZE = 32;
// ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã®åºƒã„ç”»é¢ã«åˆã‚ã›ã¦è¡¨ç¤ºç¯„å›²ã‚’èª¿æ•´
const VIEW_W = 15; 
const VIEW_H = 11; 
const MAP_W = 40;  
const MAP_H = 40;  

// åœ°å½¢ã‚¿ã‚¤ãƒ—
const TERRAIN = {
    GRASS: { id: 0, icon: '', bg: '#8bc34a', name: 'è‰åŸ', walk: true },
    FOREST: { id: 1, icon: 'ğŸŒ²', bg: '#2e7d32', name: 'æ£®', walk: true, cost: 2 },
    WATER:  { id: 2, icon: 'ğŸŒŠ', bg: '#2196f3', name: 'å·', walk: false },
    MOUNTAIN:{ id: 3, icon: 'â›°ï¸', bg: '#795548', name: 'å±±', walk: true, cost: 3 },
    CITY:   { id: 4, icon: '', bg: '#9e9e9e', name: 'å¸‚è¡—åœ°', walk: true },
    WALL:   { id: 5, icon: 'ğŸ§±', bg: '#555', name: 'å£', walk: false },
    HOME:   { id: 10, icon: 'ğŸ ', bg: '#ffeb3b', name: 'å®Ÿå®¶', type: 'spot' },
    WORK:   { id: 11, icon: 'ğŸ¢', bg: '#607d8b', name: 'ãƒãƒ­ãƒ¼ãƒ¯ãƒ¼ã‚¯', type: 'spot' },
    SHOP:   { id: 12, icon: 'ğŸª', bg: '#ff9800', name: 'ã‚³ãƒ³ãƒ“ãƒ‹', type: 'spot' },
    SLUM:   { id: 13, icon: 'ğŸšï¸', bg: '#3e2723', name: 'ã‚¹ãƒ©ãƒ è¡—', type: 'spot' },
    SHRINE: { id: 14, icon: 'â›©ï¸', bg: '#e91e63', name: 'ç¥ç¤¾', type: 'spot' }
};

// è·æ¥­ãƒ‡ãƒ¼ã‚¿
const JOBS = {
    neet: { name: "ãƒ‹ãƒ¼ãƒˆ", reqLv: 0, skill: null, desc: "åŸºæœ¬è·ã€‚ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§ãŒä½ã„ã€‚" },
    parttime: { name: "ã‚³ãƒ³ãƒ“ãƒ‹åº—å“¡", reqLv: 1, skill: "smile", desc: "ä½è³ƒé‡‘ã ãŒå®‰å®šã€‚" },
    can: { name: "ç©ºãç¼¶æ‹¾ã„", reqLv: 2, skill: "survival", desc: "ä½“åŠ›ã‚’ä½¿ã†ãŒè‡ªç”±ãªä»•äº‹ã€‚" },
    writer: { name: "Webãƒ©ã‚¤ã‚¿ãƒ¼", reqLv: 5, skill: "typing", desc: "ã‚¹ã‚­ãƒ«ã€Œã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã€ãŒå¿…è¦ã€‚" },
    host: { name: "ãƒ›ã‚¹ãƒˆ", reqLv: 8, skill: "charm", desc: "ã‚¹ã‚­ãƒ«ã€Œé­…åŠ›ã€ãŒå¿…è¦ã€‚é«˜åå…¥ã€‚" },
    scammer: { name: "å—ã‘å­", reqLv: 1, skill: "criminal", desc: "ã€é—‡è·ã€‘æ•ã¾ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã€‚" },
};

// ã‚¹ã‚­ãƒ«ãƒ‡ãƒ¼ã‚¿
const SKILLS = {
    survival: { name: "ã‚µãƒã‚¤ãƒãƒ«", cost: 1, max: 5, desc: "æ£®ã‚„å±±ã§ã®ç§»å‹•ã‚³ã‚¹ãƒˆæ¸›ï¼†ã‚¢ã‚¤ãƒ†ãƒ ç™ºè¦‹ç‡UP" },
    smile: { name: "å–¶æ¥­ã‚¹ãƒã‚¤ãƒ«", cost: 1, max: 3, desc: "æ¥å®¢ãƒã‚¤ãƒˆã®åå…¥ãŒå°‘ã—ã‚¢ãƒƒãƒ—" },
    typing: { name: "ã‚¿ã‚¤ãƒ”ãƒ³ã‚°", cost: 2, max: 5, desc: "ãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯è·ã®è§£æ”¾ï¼†åŠ¹ç‡UP" },
    guts: { name: "æ ¹æ€§", cost: 3, max: 5, desc: "æœ€å¤§HPã¨ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§ãŒã‚¢ãƒƒãƒ—" },
    charm: { name: "é­…åŠ›", cost: 3, max: 5, desc: "äººã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’è²°ã„ã‚„ã™ããªã‚‹" },
    negotiation: { name: "äº¤æ¸‰è¡“", cost: 4, max: 3, desc: "å ±é…¬ã®ã¤ã‚Šä¸Šã’ãŒå¯èƒ½" },
    criminal: { name: "è£ã®çŸ¥è­˜", cost: 5, max: 1, desc: "ã‚¹ãƒ©ãƒ è¡—ã§ã®å–å¼•ãŒå¯èƒ½ã«ãªã‚‹" }
};

// --- ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆ ---
let state = {
    x: 20, y: 20, // ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®
    lv: 1, xp: 0, nextXp: 100, sp: 0,
    hp: 100, maxHp: 100,
    money: 1000,
    stress: 0,
    karma: 0, // å–„æ‚ªå€¤ (-100 ~ 100)
    job: 'neet',
    skills: {}, // { survival: 1, ... }
    flags: {}, // ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ©ã‚°
    mapData: [] // 2æ¬¡å…ƒé…åˆ—
};

// --- ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ  ---
const game = {
    init: function() {
        this.generateMap();
        this.renderMap();
        ui.update();
        game.log("ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ã¾ãšã¯Aãƒœã‚¿ãƒ³ã§å®Ÿå®¶ã‚’èª¿ã¹ã‚ˆã†ã€‚");
    },

    // ãƒãƒƒãƒ—è‡ªå‹•ç”Ÿæˆ (ç°¡æ˜“çš„ãªåœ°å½¢ç”Ÿæˆ)
    generateMap: function() {
        state.mapData = [];
        for(let y=0; y<MAP_H; y++){
            let row = [];
            for(let x=0; x<MAP_W; x++){
                // åŸºæœ¬åœ°å½¢ï¼šãƒ‘ãƒ¼ãƒªãƒ³ãƒã‚¤ã‚ºã£ã½ãç°¡æ˜“ç”Ÿæˆ
                let noise = Math.sin(x/5) + Math.cos(y/5) + Math.random()*0.5;
                let type = TERRAIN.GRASS.id;
                
                if (noise > 1.5) type = TERRAIN.MOUNTAIN.id;
                else if (noise > 0.8) type = TERRAIN.FOREST.id;
                else if (noise < -1.0) type = TERRAIN.WATER.id;

                // è¡—ã‚¨ãƒªã‚¢ (ä¸­å¤®ä»˜è¿‘)
                let dist = Math.sqrt((x-20)**2 + (y-20)**2);
                if(dist < 8) type = TERRAIN.CITY.id;

                row.push(type);
            }
            state.mapData.push(row);
        }

        // ã‚¹ãƒãƒƒãƒˆé…ç½®
        this.setTile(20, 20, TERRAIN.HOME.id);
        this.setTile(20, 18, TERRAIN.WORK.id);
        this.setTile(22, 20, TERRAIN.SHOP.id);
        this.setTile(10, 30, TERRAIN.SLUM.id); // é ãã®ã‚¹ãƒ©ãƒ 
        this.setTile(30, 10, TERRAIN.SHRINE.id); // å±±å¥¥ã®ç¥ç¤¾
    },

    setTile: function(x, y, id) {
        if(x>=0 && x<MAP_W && y>=0 && y<MAP_H) state.mapData[y][x] = id;
    },

    getTile: function(x, y) {
        if(x<0 || x>=MAP_W || y<0 || y>=MAP_H) return TERRAIN.WALL;
        let id = state.mapData[y][x];
        return Object.values(TERRAIN).find(t => t.id === id) || TERRAIN.GRASS;
    },

    // ç§»å‹•å‡¦ç†
    move: function(dx, dy) {
        if(ui.isModalOpen) return;

        let nx = state.x + dx;
        let ny = state.y + dy;
        let tile = this.getTile(nx, ny);

        if(!tile.walk && tile.type !== 'spot') {
            game.log("ãã“ã¯é€šã‚Œãªã„ã€‚", "sys");
            return;
        }

        // ã‚³ã‚¹ãƒˆè¨ˆç®— (ã‚¹ã‚­ãƒ«ã§è»½æ¸›)
        let cost = tile.cost || 1;
        let survivalLv = state.skills.survival || 0;
        if(tile.id === TERRAIN.FOREST.id || tile.id === TERRAIN.MOUNTAIN.id) {
            cost = Math.max(1, cost - survivalLv);
        }

        state.hp -= cost;
        state.x = nx;
        state.y = ny;

        // çµŒé¨“å€¤ç²å¾— (æ­©ãã ã‘ã§å°‘ã—å…¥ã‚‹)
        this.gainXp(1);

        // ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ
        if(Math.random() < 0.05) this.randomEncounter(tile);

        this.renderMap();
        ui.update();
        this.checkGameOver();
    },

    // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ (Aãƒœã‚¿ãƒ³)
    interact: function() {
        if(ui.isModalOpen) return;
        
        let tile = this.getTile(state.x, state.y);
        
        if(tile.id === TERRAIN.HOME.id) {
            this.eventHome();
        } else if(tile.id === TERRAIN.WORK.id) {
            this.eventHelloWork();
        } else if(tile.id === TERRAIN.SHOP.id) {
            this.eventShop();
        } else if(tile.id === TERRAIN.SLUM.id) {
            this.eventSlum();
        } else if(tile.id === TERRAIN.SHRINE.id) {
            this.eventShrine();
        } else {
            game.log("è¶³å…ƒã«ã¯ä½•ã‚‚ãªã„ã€‚");
        }
    },

    // çµŒé¨“å€¤ã¨ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
    gainXp: function(amount) {
        state.xp += amount;
        if(state.xp >= state.nextXp) {
            state.lv++;
            state.xp -= state.nextXp;
            state.nextXp = Math.floor(state.nextXp * 1.2);
            state.sp += 3; // ã‚¹ã‚­ãƒ«ãƒã‚¤ãƒ³ãƒˆä»˜ä¸
            state.maxHp += 10;
            state.hp = state.maxHp;
            game.log(`ã€ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ã€‘Lv${state.lv}ã«ãªã£ãŸï¼(SP+3)`, "warn");
        }
    },

    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
    checkGameOver: function() {
        if(state.hp <= 0) {
            alert("ã€é‡å‚ã‚Œæ­»ã«ã€‘\nä½“åŠ›ãŒå°½ãã¾ã—ãŸ...");
            state.hp = state.maxHp;
            state.money = Math.floor(state.money / 2);
            state.x = 20; state.y = 20; // å®Ÿå®¶ã¸
            game.log("ç—…é™¢ã§ç›®ãŒè¦šã‚ãŸã€‚æ‰€æŒé‡‘ãŒåŠåˆ†ã«ãªã£ãŸã€‚", "bad");
            this.renderMap();
        }
        if(state.stress >= 100) {
            game.log("ã‚¹ãƒˆãƒ¬ã‚¹ã§ç™ºç‹‚ã—ã€è¡å‹•è²·ã„ã—ã¦ã—ã¾ã£ãŸï¼", "bad");
            state.money = Math.max(0, state.money - 30000);
            state.stress = 0;
        }
        this.checkEnding();
    },

    // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°åˆ¤å®š
    checkEnding: function() {
        if(state.money >= 1000000) {
            alert("ã€GOOD END: å„„ä¸‡é•·è€…ã€‘\n100ä¸‡å††è²¯ã‚ãŸï¼ã»ã†ã›ã„ã¯æŠ•è³‡å®¶ã¨ã—ã¦ãƒ‡ãƒ“ãƒ¥ãƒ¼ã—ãŸã€‚");
            this.reset();
        } else if(state.skills.survival >= 5 && state.lv >= 30 && state.x < 5 && state.y < 5) {
            alert("ã€TRUE END: æ£®ã®è³¢è€…ã€‘\nç¤¾ä¼šã«çµ¶æœ›ã—ã€æ£®ã®å¥¥ã§è‡ªçµ¦è‡ªè¶³ã®ç”Ÿæ´»ã‚’å§‹ã‚ãŸã€‚");
            this.reset();
        } else if(state.karma <= -100 && state.money >= 500000) {
            alert("ã€BAD END: é—‡ã®å¸ç‹ã€‘\nè£ç¤¾ä¼šã®ãƒœã‚¹ã¨ã—ã¦å›è‡¨ã—ãŸã€‚è­¦å¯Ÿã«è¿½ã‚ã‚Œã‚‹æ—¥ã€…ãŒå§‹ã¾ã‚‹ã€‚");
            this.reset();
        }
    },

    reset: function() {
        localStorage.removeItem('houseiRPG3_save');
        location.reload();
    },

    // --- ãƒãƒƒãƒ—æç”» (ã‚«ãƒ¡ãƒ©åˆ¶å¾¡) ---
    renderMap: function() {
        const layer = document.getElementById('map-layer');
        layer.innerHTML = '';
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸­å¿ƒã«æç”»ç¯„å›²ã‚’æ±ºå®š
        let startX = state.x - Math.floor(VIEW_W/2);
        let startY = state.y - Math.floor(VIEW_H/2);

        for(let y=0; y<VIEW_H; y++) {
            for(let x=0; x<VIEW_W; x++) {
                let mapX = startX + x;
                let mapY = startY + y;
                
                let tile = this.getTile(mapX, mapY);
                
                let div = document.createElement('div');
                div.className = 'tile';
                div.style.left = (x * TILE_SIZE) + 'px';
                div.style.top = (y * TILE_SIZE) + 'px';
                div.innerText = tile.icon;
                div.style.backgroundColor = tile.bg;
                
                layer.appendChild(div);
            }
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¡”æ›´æ–°
        let face = "ğŸ˜";
        if(state.job === 'host') face = "ğŸ˜";
        if(state.job === 'scammer') face = "ğŸ•¶ï¸";
        if(state.stress > 80) face = "ğŸ˜±";
        if(state.hp < 20) face = "ğŸ¤¢";
        document.getElementById('player-sprite').innerText = face;
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã‚’ä¸­å¿ƒã«å›ºå®š
        const sprite = document.getElementById('player-sprite');
        sprite.style.left = (Math.floor(VIEW_W/2) * TILE_SIZE) + 'px';
        sprite.style.top = (Math.floor(VIEW_H/2) * TILE_SIZE) + 'px';
    },

    log: function(msg, type) {
        const box = document.getElementById('log-window');
        const div = document.createElement('div');
        div.innerText = msg;
        if(type) div.className = 'log-' + type;
        box.insertBefore(div, box.firstChild);
    },

    saveGame: function() {
        localStorage.setItem('houseiRPG3_save', JSON.stringify(state));
        alert("ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼");
    },

    loadGame: function() {
        const data = localStorage.getItem('houseiRPG3_save');
        if(data) {
            state = JSON.parse(data);
            this.renderMap();
            ui.update();
            ui.closeAll();
            alert("ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
        } else {
            alert("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        }
    },

    // --- ã‚¤ãƒ™ãƒ³ãƒˆç¾¤ ---
    
    randomEncounter: function(tile) {
        if(tile.id === TERRAIN.CITY.id) {
            game.log("ã‚­ãƒ£ãƒƒãƒã«å£°ã‚’ã‹ã‘ã‚‰ã‚ŒãŸ... ç„¡è¦–ã—ãŸã€‚", "sys");
            state.stress += 5;
        } else if(tile.id === TERRAIN.FOREST.id) {
            game.log("ãã‚Œã„ãªèŠ±ã‚’è¦‹ã¤ã‘ãŸã€‚å¿ƒãŒæ´—ã‚ã‚Œã‚‹ã€‚", "sys");
            state.stress = Math.max(0, state.stress - 10);
        } else if(tile.id === TERRAIN.SLUM.id) {
            game.log("å°éŠ­ã‚’ç›—ã¾ã‚ŒãŸï¼", "bad");
            state.money = Math.max(0, state.money - 500);
        }
    },

    eventHome: function() {
        ui.showEvent("å®Ÿå®¶", `
            <p>å®‰æ¯ã®åœ°ã€‚ã©ã†ã™ã‚‹ï¼Ÿ</p>
            <button class="event-btn" onclick="ui.doAction('sleep')">ğŸ›Œ å¯ã‚‹ (HPå›å¾©/ç„¡æ–™)</button>
            <button class="event-btn" onclick="ui.doAction('pc')">ğŸ’» ãƒãƒƒãƒˆã‚µãƒ¼ãƒ•ã‚£ãƒ³ (ã‚¹ãƒˆãƒ¬ã‚¹è§£æ¶ˆ)</button>
        `);
    },

    eventHelloWork: function() {
        let html = "<p>è·æ¥­ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>";
        for(let key in JOBS) {
            let j = JOBS[key];
            if(key === 'hero' || key === 'scammer') continue; // ç‰¹æ®Šè·ã¯é™¤ã
            html += `<div class="job-item" onclick="ui.doAction('job', '${key}')">
                <b>${j.name}</b> (Lv${j.reqLv}ã€œ)<br><small>${j.desc}</small>
            </div>`;
        }
        ui.showEvent("ãƒãƒ­ãƒ¼ãƒ¯ãƒ¼ã‚¯", html);
    },

    eventShop: function() {
        ui.showEvent("ã‚³ãƒ³ãƒ“ãƒ‹", `
            <button class="event-btn" onclick="ui.doAction('buy', 'food')">ğŸ± ãŠå¼å½“ (300å†† / HP+50)</button>
            <button class="event-btn" onclick="ui.doAction('buy', 'drink')">ğŸº ã‚¹ãƒˆã‚¼ãƒ­ (200å†† / ã‚¹ãƒˆãƒ¬ã‚¹-30)</button>
            <button class="event-btn" onclick="ui.doAction('work_parttime')">ğŸ’° ãƒã‚¤ãƒˆã™ã‚‹ (3æ™‚é–“)</button>
        `);
    },

    eventSlum: function() {
        if(state.skills.criminal >= 1) {
            ui.showEvent("ã‚¹ãƒ©ãƒ è¡—ã®è·¯åœ°è£", `
                <p>æ€ªã—ã„ç”·ã€Œä»•äº‹ã‚ã‚‹ãœ...ï¼Ÿã€</p>
                <button class="event-btn" onclick="ui.doAction('job', 'scammer')">ğŸ˜ˆ é—‡ãƒã‚¤ãƒˆ (å—ã‘å­) ã«ãªã‚‹</button>
            `);
        } else {
            game.log("é›°å›²æ°—ãŒæ‚ªãã¦è¿‘ã¥ã‘ãªã„... (ã‚¹ã‚­ãƒ«ã€Œè£ã®çŸ¥è­˜ã€ãŒå¿…è¦)", "sys");
        }
    },
    
    eventShrine: function() {
        ui.showEvent("å¤ã³ãŸç¥ç¤¾", `
            <p>è³½éŠ­ç®±ãŒã‚ã‚‹ã€‚</p>
            <button class="event-btn" onclick="ui.doAction('pray', 100)">ğŸ™ 100å††å…¥ã‚Œã‚‹ (ã‚«ãƒ«ãƒâ†‘)</button>
            <button class="event-btn" onclick="ui.doAction('pray', -100)">ğŸ’° è³½éŠ­ã‚’ç›—ã‚€ (ã‚«ãƒ«ãƒâ†“â†“ åå…¥+)</button>
        `);
    }
};

// --- UIåˆ¶å¾¡ ---
const ui = {
    isModalOpen: false,

    update: function() {
        document.getElementById('ui-lv').innerText = state.lv;
        document.getElementById('ui-hp').innerText = state.hp;
        document.getElementById('ui-money').innerText = state.money;
        document.getElementById('ui-job').innerText = JOBS[state.job].name;
    },

    openMenu: function() {
        this.isModalOpen = true;
        document.getElementById('modal-menu').style.display = 'flex';
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åæ˜ 
        document.getElementById('st-job').innerText = JOBS[state.job].name;
        document.getElementById('st-lv').innerText = state.lv;
        document.getElementById('st-xp').innerText = state.xp;
        document.getElementById('st-next').innerText = state.nextXp;
        document.getElementById('st-money').innerText = state.money;
        document.getElementById('st-stress').innerText = state.stress;
        document.getElementById('st-hp').innerText = state.hp;
        document.getElementById('st-maxhp').innerText = state.maxHp;
        document.getElementById('st-sp').innerText = state.sp;
        document.getElementById('st-karma').innerText = state.karma;
    },

    openSkill: function() {
        this.isModalOpen = true;
        document.getElementById('modal-skill').style.display = 'flex';
        document.getElementById('sk-sp').innerText = state.sp;
        
        const list = document.getElementById('skill-list');
        list.innerHTML = "";
        
        for(let key in SKILLS) {
            let s = SKILLS[key];
            let currentLv = state.skills[key] || 0;
            let cls = currentLv > 0 ? "skill-item skill-owned" : "skill-item";
            
            list.innerHTML += `
                <div class="${cls}" onclick="ui.learnSkill('${key}')">
                    <b>${s.name}</b> (Lv.${currentLv}/${s.max})<br>
                    æ¶ˆè²»SP: ${s.cost} <small>${s.desc}</small>
                </div>
            `;
        }
    },

    learnSkill: function(key) {
        let s = SKILLS[key];
        let currentLv = state.skills[key] || 0;
        
        if(currentLv >= s.max) {
            alert("ã“ã‚Œä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã‚‰ã‚Œã¾ã›ã‚“ã€‚");
            return;
        }
        if(state.sp < s.cost) {
            alert("SPãŒè¶³ã‚Šã¾ã›ã‚“ï¼ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã¦å‡ºç›´ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        
        if(confirm(`${s.name} ã‚’ç¿’å¾—/å¼·åŒ–ã—ã¾ã™ã‹ï¼Ÿ(æ¶ˆè²»SP:${s.cost})`)) {
            state.sp -= s.cost;
            state.skills[key] = currentLv + 1;
            game.log(`${s.name} Lv.${state.skills[key]} ã‚’ç¿’å¾—ï¼`, "warn");
            this.openSkill(); // æ›´æ–°
        }
    },

    showEvent: function(title, html) {
        this.isModalOpen = true;
        document.getElementById('modal-event').style.display = 'flex';
        document.getElementById('ev-title').innerText = title;
        document.getElementById('ev-body').innerHTML = html;
    },

    closeAll: function() {
        this.isModalOpen = false;
        document.querySelectorAll('.modal').forEach(e => e.style.display = 'none');
    },

    doAction: function(act, param) {
        let success = true;
        
        if(act === 'sleep') {
            state.hp = state.maxHp;
            state.stress = Math.max(0, state.stress - 20);
            game.log("ãã£ã™ã‚Šçœ ã£ãŸã€‚");
        }
        else if(act === 'pc') {
            state.stress = Math.max(0, state.stress - 40);
            game.log("ãƒãƒƒãƒˆæ²ç¤ºæ¿ã§ãƒ¬ã‚¹ãƒã—ã¦ã‚¹ãƒƒã‚­ãƒªã—ãŸã€‚");
        }
        else if(act === 'buy') {
            if(param === 'food' && state.money >= 300) {
                state.money -= 300;
                state.hp = Math.min(state.maxHp, state.hp + 50);
                game.log("ã‚³ãƒ³ãƒ“ãƒ‹å¼å½“ã‚’é£Ÿã¹ãŸã€‚");
            } else if(param === 'drink' && state.money >= 200) {
                state.money -= 200;
                state.stress = Math.max(0, state.stress - 30);
                game.log("ã‚¹ãƒˆã‚¼ãƒ­ã‚’ä¸€æ°—é£²ã¿ã—ãŸï¼");
            } else {
                alert("é‡‘ãŒè¶³ã‚Šãªã„ï¼");
                success = false;
            }
        }
        else if(act === 'job') {
            let j = JOBS[param];
            if(state.lv < j.reqLv) {
                alert(`ãƒ¬ãƒ™ãƒ«ãŒè¶³ã‚Šã¾ã›ã‚“ (å¿…è¦Lv: ${j.reqLv})`);
                success = false;
            } else if(j.skill && !state.skills[j.skill]) {
                alert(`ã‚¹ã‚­ãƒ«ã€Œ${SKILLS[j.skill].name}ã€ãŒå¿…è¦ã§ã™ï¼`);
                success = false;
            } else {
                state.job = param;
                game.log(`${j.name} ã«è»¢è·ã—ã¾ã—ãŸï¼`, "warn");
                if(param === 'scammer') {
                    game.log("ã€è­¦å‘Šã€‘ã‚ãªãŸã¯çŠ¯ç½ªã«æ‰‹ã‚’æŸ“ã‚ã¾ã—ãŸã€‚(ã‚«ãƒ«ãƒä½ä¸‹)", "bad");
                    state.karma -= 50;
                }
            }
        }
        else if(act === 'work_parttime') {
            if(state.job === 'neet') {
                alert("ãƒ‹ãƒ¼ãƒˆã¯åƒã‘ã¾ã›ã‚“ã€‚ãƒãƒ­ãƒ¼ãƒ¯ãƒ¼ã‚¯ã§è·ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚");
                success = false;
            } else {
                // åŠ´åƒå‡¦ç†
                let baseIncome = 1000;
                let bonus = 0;
                
                if(state.job === 'host') baseIncome = 10000;
                if(state.job === 'scammer') baseIncome = 50000;

                if(state.skills.smile) bonus += 500 * state.skills.smile;
                if(state.skills.negotiation) bonus += baseIncome * 0.2;

                let earn = baseIncome + bonus;
                let stressDmg = 10;
                if(state.job === 'scammer') {
                    if(Math.random() < 0.2) {
                        earn = 0;
                        game.log("è­¦å¯Ÿã«è¦‹ã¤ã‹ã‚Šã‹ã‘ã€å ±é…¬ç„¡ã—ã§é€ƒã’ãŸï¼", "bad");
                    }
                    stressDmg = 30;
                }

                state.money += earn;
                state.stress += stressDmg;
                state.hp -= 20;
                game.gainXp(10);
                game.log(`${earn}å†† ç¨¼ã„ã ã€‚(ã‚¹ãƒˆãƒ¬ã‚¹+${stressDmg})`);
            }
        }
        else if(act === 'pray') {
            if(param > 0) {
                if(state.money >= 100) {
                    state.money -= 100;
                    state.karma += 10;
                    game.log("å¿ƒãŒæ´—ã‚ã‚ŒãŸæ°—ãŒã™ã‚‹ã€‚(ã‚«ãƒ«ãƒä¸Šæ˜‡)");
                }
            } else {
                state.money += 500;
                state.karma -= 20;
                game.log("è³½éŠ­ã‚’ç›—ã‚“ã ã€‚ãƒãƒãŒå½“ãŸã‚‹ã...(ã‚«ãƒ«ãƒä½ä¸‹)", "bad");
            }
        }

        if(success) this.closeAll();
        this.update();
        game.checkGameOver();
    }
};

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ (ãƒ‡ãƒãƒƒã‚°ç”¨)
window.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowUp') game.move(0, -1);
    if(e.key === 'ArrowDown') game.move(0, 1);
    if(e.key === 'ArrowLeft') game.move(-1, 0);
    if(e.key === 'ArrowRight') game.move(1, 0);
    if(e.key === 'z' || e.key === 'Enter') game.interact();
});

// é–‹å§‹
game.init();

</script>
</body>
</html>
