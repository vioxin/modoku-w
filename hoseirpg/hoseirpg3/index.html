<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ã»ã†ã›ã„RPG 3.5 ã€œç¤¾ä¼šã®è’æ³¢ã€œ</title>
<style>
    :root {
        --bg-color: #202020;
        --screen-bg: #e0f0e0;
        --ui-bg: #333;
        --text-color: #fff;
        --accent: #4caf50;
        --danger: #ff5252;
        --tile-size: 32px;
        /* ç”»é¢ã‚µã‚¤ã‚ºå®šç¾© */
        --view-w: 416px; /* 13 * 32 */
        --view-h: 224px; /* 7 * 32 */
    }
    
    * { box-sizing: border-box; touch-action: manipulation; }
    
    body {
        background: var(--bg-color);
        color: var(--text-color);
        font-family: 'Courier New', monospace;
        margin: 0;
        height: 100dvh; 
        width: 100vw;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    #scaler {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }

    #game-boy {
        width: 100%;
        max-width: 480px; /* å°‘ã—åºƒã’ã¾ã—ãŸ */
        display: flex;
        flex-direction: column;
        background: #444;
        border: 2px solid #666;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    #screen-area {
        background: var(--screen-bg);
        border: 4px solid #222;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
    }

    #status-bar {
        background: #222;
        color: #fff;
        padding: 4px 8px;
        font-size: 11px;
        display: flex;
        justify-content: space-between;
        z-index: 10;
        border-bottom: 2px solid #000;
        flex-shrink: 0;
    }

    /* ã“ã“ã‚’ä¿®æ­£ï¼šé«˜ã•ã‚’å¼·åˆ¶çš„ã«ç¢ºä¿ */
    #viewport {
        position: relative;
        overflow: hidden;
        background: #333;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: var(--view-h); /* é«˜ã•å›ºå®š */
    }

    #map-container {
        position: relative;
        width: var(--view-w);
        height: var(--view-h);
    }

    .tile {
        position: absolute;
        width: var(--tile-size);
        height: var(--tile-size);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        line-height: 1;
    }
    
    #player-sprite {
        position: absolute;
        width: var(--tile-size);
        height: var(--tile-size);
        font-size: 24px;
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 1;
        text-shadow: 0 0 5px white;
        transition: top 0.1s, left 0.1s; /* æ»‘ã‚‰ã‹ç§»å‹• */
    }

    #log-window {
        height: 60px;
        background: rgba(0,0,0,0.85);
        color: #fff;
        font-size: 12px;
        padding: 5px;
        overflow-y: auto;
        border-top: 2px solid #fff;
        flex-shrink: 0;
    }
    .log-sys { color: #aaa; }
    .log-warn { color: #ffeb3b; }
    .log-bad { color: #ff5252; }
    .log-good { color: #69f0ae; }

    #controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        padding: 5px;
        flex-shrink: 0;
    }

    .d-pad {
        display: grid;
        grid-template-columns: 45px 45px 45px;
        grid-template-rows: 45px 45px 45px;
        gap: 2px;
        align-self: center;
        justify-self: center;
    }
    
    .btn-pad {
        background: #222;
        border-radius: 6px;
        border: 2px solid #111;
        box-shadow: 0 3px 0 #000;
        cursor: pointer;
        color: #555;
        font-size: 18px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
    }
    .btn-pad:active { transform: translateY(3px); box-shadow: none; background: #333; }
    
    .action-pad {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 8px;
    }

    .menu-btn {
        width: 100%;
        max-width: 130px;
        padding: 10px;
        background: #555;
        color: white;
        border: 2px solid #fff;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        box-shadow: 0 3px 0 #222;
        -webkit-tap-highlight-color: transparent;
    }
    .menu-btn:active { transform: translateY(3px); box-shadow: none; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 1000;
        color: white;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        width: 100%;
        max-width: 500px;
        background: #333;
        border: 2px solid #fff;
        padding: 15px;
        border-radius: 8px;
    }
    .modal-header { font-size: 1.2rem; border-bottom: 2px solid var(--accent); margin-bottom: 10px; padding-bottom: 5px; font-weight: bold;}
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; font-size: 0.9rem; }
    .skill-item, .job-item { background: #444; border: 1px solid #666; padding: 8px; margin-bottom: 6px; cursor: pointer; border-radius: 5px; font-size: 0.9rem; position: relative; }
    .skill-owned { background: #2e7d32; border-color: #4caf50; }
    .btn-close { margin-top: 10px; padding: 10px; width: 100%; background: var(--danger); border: none; color: white; font-weight: bold; border-radius: 6px; }
    .event-btn { width: 100%; padding: 10px; margin-bottom: 6px; background: #eee; color: #000; border: none; border-radius: 5px; font-size: 0.9rem; text-align: left; cursor: pointer; }
    .event-btn:hover { background: #fff; }
    .important-text { color: #ffeb3b; font-weight: bold; }
</style>
</head>
<body>

<div id="scaler">
    <div id="game-boy">
        <div id="screen-area">
            <div id="status-bar">
                <span>LV:<span id="ui-lv">1</span></span>
                <span>HP:<span id="ui-hp">100</span></span>
                <span>Â¥:<span id="ui-money">0</span></span>
                <span><span id="ui-job">ãƒ‹ãƒ¼ãƒˆ</span></span>
            </div>
            <div id="viewport">
                <div id="map-container">
                    <div id="map-layer"></div>
                    <div id="player-sprite">ğŸ˜</div>
                </div>
            </div>
            <div id="log-window">
                <div>ç¤¾ä¼šã®è’æ³¢ã¸ã‚ˆã†ã“ãã€‚ã¾ãšã¯å®Ÿå®¶ã§è³‡æ ¼å‹‰å¼·ã ã€‚</div>
            </div>
        </div>

        <div id="controls">
            <div class="d-pad">
                <div></div><button class="btn-pad" onclick="game.move(0, -1)">â–²</button><div></div>
                <button class="btn-pad" onclick="game.move(-1, 0)">â—€</button>
                <button class="btn-pad" onclick="game.interact()" style="background:#e91e63; color:white; border-color:#c2185b;">A</button>
                <button class="btn-pad" onclick="game.move(1, 0)">â–¶</button>
                <div></div><button class="btn-pad" onclick="game.move(0, 1)">â–¼</button><div></div>
            </div>
            <div class="action-pad">
                <button class="menu-btn" onclick="ui.openMenu()">ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
                <button class="menu-btn" onclick="ui.openSkill()">âš¡ ã‚¹ã‚­ãƒ«</button>
                <button class="menu-btn" style="background:#4caf50; border-color:#388e3c" onclick="game.saveGame()">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-menu" class="modal">
    <div class="modal-content">
        <div class="modal-header">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
        <div class="stat-grid">
            <div>è·æ¥­: <span id="st-job">ãƒ‹ãƒ¼ãƒˆ</span></div>
            <div>é…å¶è€…: <span id="st-partner">ãªã—</span></div>
            <div>ä½å±…: <span id="st-house">å®Ÿå®¶(å¯„ç”Ÿ)</span></div>
            <div>Lv: <span id="st-lv">1</span></div>
            <div>Exp: <span id="st-xp">0</span> / <span id="st-next">30</span></div>
            <div>æ‰€æŒé‡‘: <span id="st-money">0</span>å††</div>
            <div>ã‚¹ãƒˆãƒ¬ã‚¹: <span id="st-stress">0</span>%</div>
            <div>ä½“åŠ›: <span id="st-hp">100</span> / <span id="st-maxhp">100</span></div>
            <div>ã‚¹ã‚­ãƒ«P: <span id="st-sp">0</span></div>
            <div>ã‚«ãƒ«ãƒ: <span id="st-karma">0</span></div>
        </div>
        <div>æ‰€æŒå“: <span id="st-items">ãªã—</span></div>
        <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
        <button class="save-btn" onclick="game.loadGame()" style="width:100%; margin-top:10px; padding:10px; background:#ff9800; border:none; border-radius:6px; color:white;">ãƒ­ãƒ¼ãƒ‰</button>
    </div>
</div>

<div id="modal-skill" class="modal">
    <div class="modal-content">
        <div class="modal-header">ã‚¹ã‚­ãƒ«ç¿’å¾— (SP: <span id="sk-sp">0</span>)</div>
        <div id="skill-list"></div>
        <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="modal-event" class="modal">
    <div class="modal-content">
        <div class="modal-header" id="ev-title">ã‚¤ãƒ™ãƒ³ãƒˆ</div>
        <div id="ev-body" style="margin-bottom: 15px; font-size: 0.95rem; line-height: 1.4;"></div>
        <div id="ev-actions"></div>
        <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
// --- Config ---
const TILE_SIZE = 32;
const VIEW_W = 13; 
const VIEW_H = 7;
const MAP_W = 40;  
const MAP_H = 40;  

const TERRAIN = {
    GRASS: { id: 0, icon: '', bg: '#8bc34a', walk: true },
    FOREST: { id: 1, icon: 'ğŸŒ²', bg: '#2e7d32', walk: true, cost: 2 },
    WATER:  { id: 2, icon: 'ğŸŒŠ', bg: '#2196f3', walk: false },
    MOUNTAIN:{ id: 3, icon: 'â›°ï¸', bg: '#795548', walk: true, cost: 3 },
    CITY:   { id: 4, icon: '', bg: '#bdbdbd', walk: true },
    WALL:   { id: 5, icon: 'ğŸ§±', bg: '#555', walk: false },
    // Spots
    HOME:   { id: 10, icon: 'ğŸ ', bg: '#ffeb3b', type: 'spot', name: 'å®Ÿå®¶' },
    WORK:   { id: 11, icon: 'ğŸ’¼', bg: '#607d8b', type: 'spot', name: 'ãƒãƒ­ãƒ¯' },
    SHOP:   { id: 12, icon: 'ğŸª', bg: '#ff9800', type: 'spot', name: 'ã‚³ãƒ³ãƒ“ãƒ‹' },
    SLUM:   { id: 13, icon: 'ğŸšï¸', bg: '#3e2723', type: 'spot', name: 'ã‚¹ãƒ©ãƒ ' },
    SHRINE: { id: 14, icon: 'â›©ï¸', bg: '#e91e63', type: 'spot', name: 'ç¥ç¤¾' },
    OFFICE: { id: 15, icon: 'ğŸ¢', bg: '#90caf9', type: 'spot', name: 'ã‚ªãƒ•ã‚£ã‚¹' },
    KOBAN:  { id: 16, icon: 'ğŸ‘®', bg: '#fff', type: 'spot', name: 'äº¤ç•ª' },
    HOUSE:  { id: 17, icon: 'ğŸ˜ï¸', bg: '#a1887f', type: 'spot', name: 'æ°‘å®¶' }
};

const JOBS = {
    neet: { name: "ãƒ‹ãƒ¼ãƒˆ", req: ()=>true, desc: "å…¨ã¦ã®å§‹ã¾ã‚Šã€‚" },
    homeless: { name: "ãƒ›ãƒ¼ãƒ ãƒ¬ã‚¹", req: ()=>true, desc: "å®Ÿå®¶ã‚’è¿½ã„å‡ºã•ã‚ŒãŸå§¿ã€‚ã‚µãƒã‚¤ãƒãƒ«ãƒ»æ ¹æ€§åŠ¹ç‡UPã€‚" },
    parttime: { name: "åº—å“¡", req: (s)=>s.skills.smile>=1, desc: "è¦:å–¶æ¥­ã‚¹ãƒã‚¤ãƒ«Lv1" },
    yamibaito: { name: "é—‡ãƒã‚¤ãƒˆ", req: ()=>true, desc: "ã€å±é™ºã€‘å³æ¡ç”¨ãƒ»é«˜åå…¥ãƒ»é€®æ•æœ‰" },
    apology: { name: "è¬ç½ªä»£è¡Œ", req: (s)=>s.skills.smile>=2 && s.skills.guts>=2, desc: "è¦:ã‚¹ãƒã‚¤ãƒ«2/æ ¹æ€§2ã€‚æ°‘å®¶ã§è¬ç½ªã™ã‚‹ã€‚" },
    fighter: { name: "æˆ¦é—˜å“¡", req: (s)=>s.skills.guts>=3 && s.lv>=5, desc: "è¦:æ ¹æ€§3/Lv5ã€‚é—‡ã®ä¸–ç•Œã®å…µéšŠã€‚" },
    scammer: { name: "å—ã‘å­", req: (s)=>s.skills.criminal>=1 && s.lv>=5, desc: "è¦:è£ã®çŸ¥è­˜/Lv5ã€‚" },
    regular: { name: "æ­£è¦ç¤¾å“¡", req: (s)=>s.skills.society>=3 && s.lv>=10 && s.items.includes('suit'), desc: "è¦:ç¤¾ä¼šäººLv3/Lv10/ã‚¹ãƒ¼ãƒ„ã€‚å®‰å®šã€‚" }
};

const SKILLS = {
    survival: { name: "ã‚µãƒã‚¤ãƒãƒ«", cost: 1, max: 5, desc: "é‡å®¿ãƒ»ç§»å‹•åŠ¹ç‡UP" },
    smile: { name: "å–¶æ¥­ã‚¹ãƒã‚¤ãƒ«", cost: 1, max: 3, desc: "æ¥å®¢ãƒ»è¬ç½ªã«å¿…é ˆ" },
    typing: { name: "ã‚¿ã‚¤ãƒ”ãƒ³ã‚°", cost: 2, max: 5, desc: "äº‹å‹™ä½œæ¥­åŠ¹ç‡UP" },
    guts: { name: "æ ¹æ€§", cost: 3, max: 5, desc: "HP/ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§UP" },
    charm: { name: "é­…åŠ›", cost: 3, max: 5, desc: "äº¤æ¸‰ãƒ»è©æ¬ºæˆåŠŸç‡UP" },
    society: { name: "ç¤¾ä¼šäººã¨ã—ã¦ã®å…¨ã¦", cost: 4, max: 5, desc: "æ­£è¦ç¤¾å“¡ã«å¿…é ˆã€‚ãƒãƒŠãƒ¼ãƒ»å¸¸è­˜ã€‚" },
    mote: { name: "ãƒ¢ãƒ†ã‚‹ãŸã‚ã®å…¨ã¦", cost: 4, max: 5, desc: "çµå©šã«å¿…é ˆã€‚å¤–è¦‹ã¨ãƒˆãƒ¼ã‚¯ã€‚" },
    criminal: { name: "è£ã®çŸ¥è­˜", cost: 5, max: 1, desc: "ã‚¹ãƒ©ãƒ è¡—ã§ä¸Šç´šè·" }
};

// --- State ---
let state = {
    x: 20, y: 20,
    lv: 1, xp: 0, nextXp: 30, sp: 0,
    hp: 100, maxHp: 100,
    money: 1000,
    stress: 0,
    karma: 0,
    job: 'neet',
    skills: {},
    items: [],
    flags: {
        married: false,
        myHome: false, // æŒã¡å®¶
        policeGuard: 0 // è©æ¬ºé˜²æ­¢æœŸé–“
    },
    mapData: []
};

// --- Game Logic ---
const game = {
    init: function() {
        this.generateMap();
        this.renderMap();
        ui.update();
        setTimeout(fitScreen, 100);
    },

    generateMap: function() {
        state.mapData = [];
        for(let y=0; y<MAP_H; y++){
            let row = [];
            for(let x=0; x<MAP_W; x++){
                let type = TERRAIN.GRASS.id;
                let dist = Math.sqrt((x-20)**2 + (y-20)**2);
                
                // è‡ªç„¶
                let noise = Math.sin(x/5) + Math.cos(y/5) + Math.random()*0.5;
                if (noise > 1.5) type = TERRAIN.MOUNTAIN.id;
                else if (noise > 0.8) type = TERRAIN.FOREST.id;
                else if (noise < -1.0) type = TERRAIN.WATER.id;
                
                // è¡—
                if(dist < 10) type = TERRAIN.CITY.id;
                row.push(type);
            }
            state.mapData.push(row);
        }

        // æ–½è¨­é…ç½®
        const set = (x, y, id) => state.mapData[y][x] = id;
        
        set(20, 20, TERRAIN.HOME.id);
        set(20, 19, TERRAIN.WORK.id);
        set(21, 20, TERRAIN.SHOP.id);
        set(22, 19, TERRAIN.OFFICE.id); // ã‚ªãƒ•ã‚£ã‚¹
        set(19, 21, TERRAIN.KOBAN.id);  // äº¤ç•ª

        set(10, 30, TERRAIN.SLUM.id);
        set(30, 10, TERRAIN.SHRINE.id);

        // æ°‘å®¶ã‚’ç‚¹åœ¨ã•ã›ã‚‹
        set(18, 18, TERRAIN.HOUSE.id);
        set(22, 22, TERRAIN.HOUSE.id);
        set(24, 18, TERRAIN.HOUSE.id);
        set(16, 22, TERRAIN.HOUSE.id);
    },

    getTile: function(x, y) {
        if(x<0 || x>=MAP_W || y<0 || y>=MAP_H) return TERRAIN.WALL;
        return Object.values(TERRAIN).find(t => t.id === state.mapData[y][x]) || TERRAIN.GRASS;
    },

    move: function(dx, dy) {
        if(ui.isModalOpen) return;
        let nx = state.x + dx;
        let ny = state.y + dy;
        let tile = this.getTile(nx, ny);
        if(!tile.walk && tile.type !== 'spot') return;
        
        // ç§»å‹•ã‚³ã‚¹ãƒˆ
        let cost = tile.cost || 1;
        if(state.skills.survival) cost = Math.max(1, cost - state.skills.survival);
        state.hp -= cost;
        state.x = nx; state.y = ny;

        // çµŒé¨“å€¤ (ç·©å’Œ)
        this.gainXp(2);
        if(state.job === 'homeless' && tile.id === TERRAIN.FOREST.id) this.gainXp(3); // ãƒ›ãƒ¼ãƒ ãƒ¬ã‚¹ãƒœãƒ¼ãƒŠã‚¹

        // ã‚¤ãƒ™ãƒ³ãƒˆåˆ¤å®š
        this.checkFraudEvent(tile);
        if(Math.random() < 0.05) this.randomEncounter(tile);
        
        if(state.flags.policeGuard > 0) state.flags.policeGuard--;

        this.renderMap();
        ui.update();
        this.checkGameOver();
    },

    interact: function() {
        if(ui.isModalOpen) return;
        let tile = this.getTile(state.x, state.y);
        
        if(tile.id === TERRAIN.HOME.id) this.eventHome();
        else if(tile.id === TERRAIN.WORK.id) this.eventHelloWork();
        else if(tile.id === TERRAIN.SHOP.id) this.eventShop();
        else if(tile.id === TERRAIN.SLUM.id) this.eventSlum();
        else if(tile.id === TERRAIN.SHRINE.id) this.eventShrine();
        else if(tile.id === TERRAIN.OFFICE.id) this.eventOffice();
        else if(tile.id === TERRAIN.KOBAN.id) this.eventKoban();
        else if(tile.id === TERRAIN.HOUSE.id) this.eventGenericHouse();
        else game.log("ç‰¹ã«ä½•ã‚‚ãªã„ã€‚");
    },

    gainXp: function(amount) {
        state.xp += amount;
        if(state.xp >= state.nextXp) {
            state.lv++;
            state.xp -= state.nextXp;
            state.nextXp = Math.floor(state.nextXp * 1.5);
            state.sp += 3;
            state.maxHp += 10;
            state.hp = state.maxHp;
            game.log(`Lv${state.lv}ã«ä¸ŠãŒã£ãŸï¼SP+3`, "good");
        }
    },

    // --- Events ---
    
    // è©æ¬ºã‚¤ãƒ™ãƒ³ãƒˆ
    checkFraudEvent: function(tile) {
        if(tile.id === TERRAIN.CITY.id && state.money >= 100000 && Math.random() < 0.03) {
            // é˜²è¡›åˆ¤å®š
            if(state.flags.policeGuard > 0) {
                game.log("è©æ¬ºå¸«ãŒè¿‘å¯„ã£ã¦ããŸãŒã€è­¦å®˜ã®å§¿ã‚’è¦‹ã¦é€ƒã’ãŸã€‚", "good");
            } else if(state.skills.society >= 3) {
                game.log("è©æ¬ºå¸«ã®å£è»Šã‚’è¦‹æŠœã„ã¦è¿½ã„æ‰•ã£ãŸï¼(ç¤¾ä¼šäººã‚¹ã‚­ãƒ«)", "good");
            } else {
                let loss = Math.floor(state.money * 0.3);
                state.money -= loss;
                state.stress += 50;
                ui.showEvent("è©æ¬ºè¢«å®³ï¼ï¼", `
                    <p class="important-text">ã€Œã‚ªãƒ¬ã‚ªãƒ¬ï¼äº‹æ•…ã£ã¡ã‚ƒã£ã¦â€¦ã€</p>
                    <p>æ°—ã¥ã„ãŸæ™‚ã«ã¯é‡‘ãŒãªã‹ã£ãŸã€‚</p>
                    <p>-${loss}å††</p>
                    <p>äº¤ç•ªã§é˜²çŠ¯ç™»éŒ²ã—ã¦ãŠã‘ã°â€¦</p>
                `);
            }
        }
    },

    eventHome: function() {
        if(state.job === 'homeless' && !state.flags.myHome) {
            ui.showEvent("å®Ÿå®¶", "<p>ã€Œåƒã‹ãªã„ã‚„ã¤ã‚’å…¥ã‚Œã‚‹å®¶ã¯ãªã„ï¼ã€<br>éµãŒå¤‰ãˆã‚‰ã‚Œã¦ã„ã‚‹â€¦</p>");
            return;
        }
        
        let houseName = state.flags.myHome ? "ãƒã‚¤ãƒ›ãƒ¼ãƒ " : "å®Ÿå®¶";
        let html = `<p>${houseName}ã€‚å®‰ã‚‰ãã®å ´æ‰€ã€‚</p>`;
        
        html += `<button class="event-btn" onclick="ui.doAction('sleep')">ğŸ›Œ å¯ã‚‹ (å…¨å›å¾©)</button>`;
        html += `<button class="event-btn" onclick="ui.doAction('study')">ğŸ“š è³‡æ ¼å‹‰å¼· (XP+10)</button>`;
        
        if(state.flags.married) {
            html += `<p>é…å¶è€…ãŒå„ªã—ãå¾®ç¬‘ã‚“ã§ã„ã‚‹ã€‚</p>`;
            html += `<button class="event-btn" onclick="ui.doAction('love')">ğŸ’• æ„›ã‚’è‚²ã‚€ (ã‚¹ãƒˆãƒ¬ã‚¹è¶…å›å¾©)</button>`;
        } else {
            html += `<button class="event-btn" onclick="ui.doAction('pc')">ğŸ’» ãƒãƒƒãƒˆ (ã‚¹ãƒˆãƒ¬ã‚¹-40)</button>`;
        }

        ui.showEvent(houseName, html);
    },

    eventGenericHouse: function() {
        let html = "<p>æ™®é€šã®æ°‘å®¶ã ã€‚</p>";
        
        // è¬ç½ªä»£è¡Œ
        if(state.job === 'apology') {
            html += `<button class="event-btn" onclick="ui.doAction('work_apology')">ğŸ™‡ è¬ç½ªä»£è¡Œã™ã‚‹</button>`;
        }
        // é—‡ãƒã‚¤ãƒˆãƒ»æˆ¦é—˜å“¡
        if(state.job === 'yamibaito' || state.job === 'fighter') {
            html += `<button class="event-btn" onclick="ui.doAction('work_crime')">ğŸ”¨ æŠ¼ã—è¾¼ã¿å¼·ç›—ã™ã‚‹</button>`;
        }
        
        // è¨ªå•è²©å£²(åº—å“¡)
        if(state.job === 'parttime') {
             html += `<button class="event-btn" onclick="ui.doAction('work_sales')">ğŸ“¦ ç½®ãé…ãƒã‚¤ãƒˆ</button>`;
        }

        ui.showEvent("æ°‘å®¶", html);
    },

    eventKoban: function() {
        ui.showEvent("äº¤ç•ª", `
            <p>è¡—ã®å®‰å…¨ã‚’å®ˆã‚‹ã€‚</p>
            <button class="event-btn" onclick="ui.doAction('koban_consult')">ğŸ‘® é˜²çŠ¯ç™»éŒ² (ç„¡æ–™/è©æ¬ºé˜²æ­¢)</button>
            <button class="event-btn" onclick="ui.doAction('koban_lost')">ğŸ˜­ è½ã¨ã—ç‰©å±Š (é‹ãŒè‰¯ã‘ã‚Œã°é‡‘æ‹¾ã†)</button>
        `);
    },

    eventOffice: function() {
        let html = "<p>é«˜å±¤ã‚ªãƒ•ã‚£ã‚¹ãƒ“ãƒ«ã€‚ãƒ“ã‚¸ãƒã‚¹ã®ä¸­å¿ƒã€‚</p>";
        
        if(state.job === 'regular') {
            html += `<button class="event-btn" onclick="ui.doAction('work_office')">ğŸ’¼ å‡ºç¤¾ã—ã¦åƒã (åå…¥å®‰å®š)</button>`;
        }
        
        if(!state.flags.myHome) {
             html += `<button class="event-btn" onclick="ui.doAction('buy_house')">ğŸ  ãƒã‚¤ãƒ›ãƒ¼ãƒ è³¼å…¥ (100ä¸‡å††)</button>`;
        }
        
        ui.showEvent("ã‚ªãƒ•ã‚£ã‚¹", html);
    },

    eventHelloWork: function() {
        let html = "<p>è·æ¥­æ–¡æ—‹æ‰€ã€‚</p>";
        for(let key in JOBS) {
            if(['yamibaito','fighter','scammer','apology'].includes(key)) continue; // è£ç¨¼æ¥­ã¯ã“ã“ã«å‡ºãªã„
            let j = JOBS[key];
            let color = state.job === key ? "#4caf50" : "";
            html += `<div class="job-item" style="border-color:${color}" onclick="ui.doAction('change_job', '${key}')">
                <b>${j.name}</b><br><small>${j.desc}</small>
            </div>`;
        }
        ui.showEvent("ãƒãƒ­ãƒ¼ãƒ¯ãƒ¼ã‚¯", html);
    },

    eventSlum: function() {
        let html = "<p>å±é™ºãªåŒ‚ã„ãŒã™ã‚‹ã‚¨ãƒªã‚¢ã€‚</p>";
        // é—‡è·ã®æ–¡æ—‹
        const darkJobs = ['yamibaito', 'apology', 'scammer', 'fighter'];
        darkJobs.forEach(key => {
            let j = JOBS[key];
            html += `<div class="job-item" style="border-color:#ff5252" onclick="ui.doAction('change_job', '${key}')">
                <b>${j.name}</b><br><small>${j.desc}</small>
            </div>`;
        });
        ui.showEvent("ã‚¹ãƒ©ãƒ è¡—", html);
    },
    
    eventShrine: function() {
        let html = `<p>ç¥è–ãªå ´æ‰€ã€‚</p>
            <button class="event-btn" onclick="ui.doAction('pray', 100)">ğŸ™ ç¥ˆã‚‹ (-100å††/ã‚«ãƒ«ãƒæµ„åŒ–)</button>
            <button class="event-btn" onclick="ui.doAction('pray', -100)">ğŸ’° è³½éŠ­æ³¥æ£’ (å±é™º)</button>`;
            
        // çµå©šã‚¤ãƒ™ãƒ³ãƒˆ
        if(!state.flags.married) {
            html += `<hr><p>ã€ç¸çµã³ã€‘</p>
            <button class="event-btn" onclick="ui.doAction('marry_check')">ğŸ’ ãƒ—ãƒ­ãƒãƒ¼ã‚ºã™ã‚‹ (è¦:30ä¸‡å††/æ­£è¦ç¤¾å“¡)</button>`;
        }
        
        ui.showEvent("ç¥ç¤¾", html);
    },

    eventShop: function() {
        let html = `<p>24æ™‚é–“å–¶æ¥­ã€‚</p>
            <button class="event-btn" onclick="ui.doAction('buy', 'food')">ğŸ± å¼å½“ (300å††)</button>
            <button class="event-btn" onclick="ui.doAction('buy', 'drink')">ğŸº é…’ (200å††)</button>`;
            
        if(!state.items.includes('suit')) {
            html += `<button class="event-btn" onclick="ui.doAction('buy', 'suit')">ğŸ‘” ã‚¹ãƒ¼ãƒ„ã‚’è²·ã† (5ä¸‡å††)</button>`;
        }
        ui.showEvent("ã‚³ãƒ³ãƒ“ãƒ‹", html);
    },

    checkGameOver: function() {
        if(state.hp <= 0) {
            alert("éåŠ´ã§å€’ã‚Œã¾ã—ãŸâ€¦ç—…é™¢é€ã‚Šã§ã™ã€‚");
            state.hp = state.maxHp;
            state.money = Math.floor(state.money / 2);
            state.x = 20; state.y = 20;
            state.job = 'neet'; // ã‚¯ãƒ“
            game.renderMap();
        }
        if(state.stress >= 100) {
            game.log("ã‚¹ãƒˆãƒ¬ã‚¹é™ç•Œï¼ç™ºç‹‚ã—ã¦æ•£è²¡ï¼", "bad");
            state.money = Math.max(0, state.money - 50000);
            state.stress = 0;
            if(state.flags.married) {
                game.log("é…å¶è€…ã«æ„›æƒ³ã‚’å°½ã‹ã•ã‚Œé›¢å©šã—ãŸâ€¦", "bad");
                state.flags.married = false;
            }
        }
    },

    randomEncounter: function(tile) {
        // ç°¡æ˜“ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆ
        if(tile.id === TERRAIN.CITY.id) { 
             game.log("è¡—ã®é¨’éŸ³ã§é ­ãŒç—›ã„ã€‚", "sys"); state.stress+=2;
        }
    },
    
    saveGame: function() {
        localStorage.setItem('houseiRPG35_save', JSON.stringify(state));
        alert("ã‚»ãƒ¼ãƒ–å®Œäº†");
    },
    
    loadGame: function() {
        let d = localStorage.getItem('houseiRPG35_save');
        if(d) { state = JSON.parse(d); game.generateMap(); game.renderMap(); ui.update(); ui.closeAll(); alert("ãƒ­ãƒ¼ãƒ‰å®Œäº†"); }
    },

    renderMap: function() {
        const layer = document.getElementById('map-layer');
        layer.innerHTML = '';
        
        let startX = state.x - Math.floor(VIEW_W/2);
        let startY = state.y - Math.floor(VIEW_H/2);

        for(let y=0; y<VIEW_H; y++) {
            for(let x=0; x<VIEW_W; x++) {
                let mapX = startX + x;
                let mapY = startY + y;
                let tile = this.getTile(mapX, mapY);
                let div = document.createElement('div');
                div.className = 'tile';
                div.style.left = (x * TILE_SIZE) + 'px';
                div.style.top = (y * TILE_SIZE) + 'px';
                div.innerText = tile.icon;
                div.style.backgroundColor = tile.bg;
                layer.appendChild(div);
            }
        }
        
        let face = "ğŸ˜";
        if(state.job === 'host') face = "ğŸ˜";
        if(state.job === 'yamibaito' || state.job === 'scammer' || state.job === 'fighter') face = "ğŸ•¶ï¸";
        if(state.job === 'apology') face = "ğŸ™‡";
        if(state.job === 'regular') face = "ğŸ‘”";
        if(state.stress > 80) face = "ğŸ˜±";
        if(state.hp < 20) face = "ğŸ¤¢";
        if(state.flags.married && state.stress < 20) face = "ğŸ¥°";

        const sprite = document.getElementById('player-sprite');
        sprite.innerText = face;
        sprite.style.left = (Math.floor(VIEW_W/2) * TILE_SIZE) + 'px';
        sprite.style.top = (Math.floor(VIEW_H/2) * TILE_SIZE) + 'px';
    }
};

const ui = {
    isModalOpen: false,

    update: function() {
        document.getElementById('ui-lv').innerText = state.lv;
        document.getElementById('ui-hp').innerText = state.hp;
        document.getElementById('ui-money').innerText = state.money;
        document.getElementById('ui-job').innerText = JOBS[state.job].name;
    },

    openMenu: function() {
        this.isModalOpen = true;
        document.getElementById('modal-menu').style.display = 'flex';
        document.getElementById('st-job').innerText = JOBS[state.job].name;
        document.getElementById('st-partner').innerText = state.flags.married ? "ã‚ã‚Š(ãƒ©ãƒ–ãƒ©ãƒ–)" : "ãªã—";
        document.getElementById('st-house').innerText = state.flags.myHome ? "æŒã¡å®¶" : (state.job==='homeless'?"ãªã—":"å®Ÿå®¶");
        document.getElementById('st-lv').innerText = state.lv;
        document.getElementById('st-xp').innerText = state.xp;
        document.getElementById('st-next').innerText = state.nextXp;
        document.getElementById('st-money').innerText = state.money;
        document.getElementById('st-stress').innerText = state.stress;
        document.getElementById('st-hp').innerText = state.hp + "/" + state.maxHp;
        document.getElementById('st-sp').innerText = state.sp;
        document.getElementById('st-karma').innerText = state.karma;
        
        let items = state.items.map(i => i === 'suit' ? 'ã‚¹ãƒ¼ãƒ„' : i).join(', ');
        document.getElementById('st-items').innerText = items || "ãªã—";
    },

    openSkill: function() {
        this.isModalOpen = true;
        document.getElementById('modal-skill').style.display = 'flex';
        document.getElementById('sk-sp').innerText = state.sp;
        const list = document.getElementById('skill-list');
        list.innerHTML = "";
        for(let key in SKILLS) {
            let s = SKILLS[key];
            let currentLv = state.skills[key] || 0;
            let cls = currentLv > 0 ? "skill-item skill-owned" : "skill-item";
            list.innerHTML += `<div class="${cls}" onclick="ui.learnSkill('${key}')">
                <b>${s.name}</b> (Lv.${currentLv}/${s.max}) SP:${s.cost}<br>
                <small>${s.desc}</small>
            </div>`;
        }
    },

    learnSkill: function(key) {
        let s = SKILLS[key];
        let currentLv = state.skills[key] || 0;
        if(currentLv >= s.max) return alert("æœ€å¤§ãƒ¬ãƒ™ãƒ«ã§ã™");
        if(state.sp < s.cost) return alert("SPãŒè¶³ã‚Šã¾ã›ã‚“");
        if(confirm(`${s.name} ã‚’ç¿’å¾—ã—ã¾ã™ã‹ï¼Ÿ`)) {
            state.sp -= s.cost;
            state.skills[key] = currentLv + 1;
            game.log(`${s.name} Lv${currentLv+1} ç¿’å¾—ï¼`, "good");
            this.openSkill();
        }
    },

    showEvent: function(title, html) {
        this.isModalOpen = true;
        document.getElementById('modal-event').style.display = 'flex';
        document.getElementById('ev-title').innerText = title;
        document.getElementById('ev-body').innerHTML = html;
        document.getElementById('ev-actions').innerHTML = "";
    },

    closeAll: function() {
        this.isModalOpen = false;
        document.querySelectorAll('.modal').forEach(e => e.style.display = 'none');
    },

    doAction: function(act, param) {
        let success = true;
        
        // --- ç”Ÿæ´» ---
        if(act === 'sleep') { state.hp = state.maxHp; state.stress = Math.max(0, state.stress - 20); game.log("ãã£ã™ã‚Šå¯ãŸã€‚"); }
        else if(act === 'study') { state.xp += 10; state.stress += 5; game.gainXp(0); game.log("å‹‰å¼·ã—ãŸ(XP+10)"); }
        else if(act === 'pc') { state.stress = Math.max(0, state.stress - 40); game.log("ãƒãƒƒãƒˆã‚µãƒ¼ãƒ•ã‚£ãƒ³ã—ãŸã€‚"); }
        else if(act === 'love') { state.stress = 0; game.log("å¹¸ã›ãªæ™‚é–“ã‚’éã”ã—ãŸã€‚", "good"); }
        
        // --- è²·ã„ç‰© ---
        else if(act === 'buy') {
            if(param === 'food' && state.money >= 300) { state.money -= 300; state.hp += 50; game.log("å¼å½“ã‚’é£Ÿã¹ãŸã€‚"); }
            else if(param === 'drink' && state.money >= 200) { state.money -= 200; state.stress -= 30; game.log("é…’ã‚’é£²ã‚“ã ã€‚"); }
            else if(param === 'suit') {
                if(state.money < 50000) return alert("é‡‘ãŒè¶³ã‚Šãªã„ï¼");
                state.money -= 50000;
                state.items.push('suit');
                game.log("ã‚¹ãƒ¼ãƒ„ã‚’è³¼å…¥ã—ãŸï¼å°±è·æ´»å‹•ãŒã§ãã‚‹ï¼", "good");
            }
        }
        
        // --- ä»•äº‹ãƒ»è·æ¥­ ---
        else if(act === 'change_job') {
            let j = JOBS[param];
            if(!j.req(state)) { alert("æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“\n" + j.desc); success = false; }
            else { state.job = param; game.log(`${j.name}ã«è»¢è·ã—ãŸï¼`, "good"); }
        }
        else if(act === 'work_office') { // æ­£è¦ç¤¾å“¡ç”¨
            let earn = 15000 + (state.skills.society * 2000) + (state.skills.typing * 1000);
            state.money += earn; state.hp -= 30; state.stress += 20; game.gainXp(20);
            game.log(`å®šæ™‚é€€ç¤¾ã€‚+${earn}å††`, "good");
        }
        else if(act === 'work_apology') { // è¬ç½ªä»£è¡Œ
            let earn = 8000 + (state.skills.smile * 2000);
            state.money += earn; state.hp -= 20; state.stress += 40; game.gainXp(15);
            game.log(`åœŸä¸‹åº§ã—ã¦${earn}å††å¾—ãŸã€‚èƒƒãŒç—›ã„ã€‚`, "warn");
        }
        else if(act === 'work_crime') { // å¼·ç›—
            if(Math.random() < 0.3) {
                state.money = 0; state.job = 'neet'; state.stress=100;
                game.log("è­¦å¯Ÿã ï¼é€®æ•ï¼å…¨ã¦ã‚’å¤±ã£ãŸï¼", "bad");
            } else {
                let earn = 50000 + (Math.random()*50000);
                state.money += Math.floor(earn); state.karma -= 50; state.stress += 50;
                game.log(`æŠ¼ã—å…¥ã£ã¦${Math.floor(earn)}å††å¥ªã£ãŸï¼`, "bad");
            }
        }
        else if(act === 'work_sales') {
            state.money += 2000; state.hp -= 10; game.gainXp(5);
            game.log("è·ç‰©ã‚’ç½®ã„ãŸã€‚+2000å††");
        }

        // --- äº¤ç•ª ---
        else if(act === 'koban_consult') {
            state.flags.policeGuard = 100; // 100æ­©å®ˆã‚‰ã‚Œã‚‹
            game.log("ãŠå·¡ã‚Šã•ã‚“ãŒãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å¼·åŒ–ã—ã¦ãã‚ŒãŸï¼", "good");
        }
        else if(act === 'koban_lost') {
            if(Math.random() < 0.2) {
                let found = 1000 + Math.floor(Math.random()*5000);
                state.money += found;
                game.log(`è½ã¨ã—ä¸»ã‹ã‚‰è¬ç¤¼${found}å††ã‚’ã‚‚ã‚‰ã£ãŸï¼`, "good");
            } else {
                game.log("ç‰¹ã«ä½•ã‚‚å±Šã„ã¦ã„ãªã‹ã£ãŸã€‚");
            }
        }

        // --- ãã®ä»– ---
        else if(act === 'pray') {
            if(param > 0 && state.money>=100) { state.money-=100; state.karma = Math.max(0, state.karma+10); game.log("å¿ƒãŒæ´—ã‚ã‚ŒãŸã€‚"); }
            else if(param < 0) { state.money+=500; state.karma-=30; game.log("ãƒãƒå½“ãŸã‚Šã‚ï¼", "bad"); }
        }
        else if(act === 'buy_house') {
            if(state.money < 1000000) return alert("100ä¸‡å††å¿…è¦ã§ã™ã€‚");
            if(confirm("æœ¬å½“ã«100ä¸‡å††ã§ãƒã‚¤ãƒ›ãƒ¼ãƒ ã‚’è²·ã„ã¾ã™ã‹ï¼Ÿ")) {
                state.money -= 1000000;
                state.flags.myHome = true;
                game.log("å¤¢ã®ãƒã‚¤ãƒ›ãƒ¼ãƒ ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼ï¼ï¼", "good");
            }
        }
        else if(act === 'marry_check') {
            // çµå©šåˆ¤å®š
            if(state.job !== 'regular') return alert("ç›¸æ‰‹ã®è¦ªã€Œæ­£è¦ç¤¾å“¡ã˜ã‚ƒãªã„ã¨å¨˜ã¯ã‚„ã‚‰ã‚“ï¼ã€");
            if(state.lv < 15) return alert("ç›¸æ‰‹ã€Œã‚‚ã†å°‘ã—é ¼ã‚ŠãŒã„ï¼ˆLv15ä»¥ä¸Šï¼‰ãŒæ¬²ã—ã„ã‚ã€");
            if((state.skills.mote || 0) < 3) return alert("ç›¸æ‰‹ã€Œè©±ãŒã¤ã¾ã‚‰ãªã„ã‚ï¼ˆãƒ¢ãƒ†ã‚¹ã‚­ãƒ«Lv3å¿…è¦ï¼‰ã€");
            if(state.money < 300000) return alert("çµå©šè³‡é‡‘ï¼ˆ30ä¸‡å††ï¼‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
            
            if(confirm("30ä¸‡å††æ”¯æ‰•ã£ã¦çµå©šã—ã¾ã™ã‹ï¼Ÿ")) {
                state.money -= 300000;
                state.flags.married = true;
                game.log("ãŠã‚ã§ã¨ã†ï¼çµå©šã—ã¾ã—ãŸï¼å¹¸ã›ãªå®¶åº­ã‚’ç¯‰ã“ã†ã€‚", "good");
            }
        }

        if(success) this.closeAll();
        ui.update();
        game.checkGameOver();
    }
};

// ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‡¦ç†
function fitScreen() {
    const gameBoy = document.getElementById('game-boy');
    const wrapper = document.getElementById('scaler');
    gameBoy.style.transform = 'none';
    const scale = Math.min(wrapper.clientHeight / (gameBoy.offsetHeight + 20), wrapper.clientWidth / (gameBoy.offsetWidth + 20));
    gameBoy.style.transform = `scale(${Math.min(scale, 1)})`;
}
window.addEventListener('load', fitScreen);
window.addEventListener('resize', fitScreen);

// æ“ä½œ
window.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowUp') game.move(0, -1);
    if(e.key === 'ArrowDown') game.move(0, 1);
    if(e.key === 'ArrowLeft') game.move(-1, 0);
    if(e.key === 'ArrowRight') game.move(1, 0);
    if(e.key === 'z' || e.key === 'Enter') game.interact();
});

game.init();
</script>
</body>
</html>
