<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ã»ã†ã›ã„RPG 3.7 ã€œåŠ´åƒã¨ã‚¢ã‚¸ãƒˆã€œ</title>
<style>
    :root {
        --bg-color: #202020;
        --screen-bg: #e0f0e0;
        --ui-bg: #333;
        --text-color: #fff;
        --accent: #4caf50;
        --danger: #ff5252;
        --tile-size: 32px;
        --view-w: 416px; /* 13 * 32 */
        --view-h: 224px; /* 7 * 32 */
    }
    
    * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
    
    body {
        background: var(--bg-color);
        color: var(--text-color);
        font-family: 'Courier New', monospace;
        margin: 0;
        height: 100dvh; 
        width: 100vw;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    #scaler {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }

    #game-boy {
        width: 100%;
        max-width: 460px;
        display: flex;
        flex-direction: column;
        background: #444;
        border: 2px solid #666;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    #screen-area {
        background: var(--screen-bg);
        border: 4px solid #222;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
        height: 320px; 
    }

    #status-bar {
        background: #222;
        color: #fff;
        padding: 4px 8px;
        font-size: 11px;
        display: flex;
        justify-content: space-between;
        z-index: 10;
        border-bottom: 2px solid #000;
        height: 24px;
        flex-shrink: 0;
    }

    #viewport {
        position: relative;
        overflow: hidden;
        background: #333;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: var(--view-h);
        flex-shrink: 0;
    }

    #flash-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        pointer-events: none;
        z-index: 20;
        opacity: 0;
        transition: opacity 0.1s;
    }

    #map-container {
        position: relative;
        width: var(--view-w);
        height: var(--view-h);
    }

    .tile {
        position: absolute;
        width: var(--tile-size);
        height: var(--tile-size);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        line-height: 1;
    }
    
    #player-sprite {
        position: absolute;
        width: var(--tile-size);
        height: var(--tile-size);
        font-size: 24px;
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 1;
        text-shadow: 0 0 5px white;
        transition: top 0.1s, left 0.1s;
    }

    .popup-text {
        position: absolute;
        font-weight: bold;
        font-size: 14px;
        text-shadow: 1px 1px 0 #000;
        pointer-events: none;
        z-index: 100;
        animation: floatUp 1s forwards;
        width: 150px;
        text-align: center;
        margin-left: -59px;
    }
    @keyframes floatUp {
        0% { transform: translateY(0); opacity: 1; }
        100% { transform: translateY(-30px); opacity: 0; }
    }

    #log-window {
        flex-grow: 1;
        background: rgba(0,0,0,0.9);
        color: #fff;
        font-size: 12px;
        padding: 5px;
        overflow-y: auto;
        border-top: 2px solid #fff;
        font-family: 'Courier New', sans-serif;
    }
    .log-entry { margin-bottom: 2px; border-bottom: 1px solid #333; padding-bottom: 1px; }
    .log-sys { color: #aaa; }
    .log-warn { color: #ffeb3b; }
    .log-bad { color: #ff5252; }
    .log-good { color: #69f0ae; }

    #controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        padding: 5px;
        flex-shrink: 0;
    }

    .d-pad {
        display: grid;
        grid-template-columns: 45px 45px 45px;
        grid-template-rows: 45px 45px 45px;
        gap: 2px;
        align-self: center;
        justify-self: center;
    }
    
    .btn-pad {
        background: #222;
        border-radius: 6px;
        border: 2px solid #111;
        box-shadow: 0 3px 0 #000;
        cursor: pointer;
        color: #555;
        font-size: 18px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
    }
    .btn-pad:active { transform: translateY(3px); box-shadow: none; background: #333; }
    
    .action-pad {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 8px;
    }

    .menu-btn {
        width: 100%;
        max-width: 130px;
        padding: 12px;
        background: #555;
        color: white;
        border: 2px solid #fff;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        box-shadow: 0 3px 0 #222;
        -webkit-tap-highlight-color: transparent;
    }
    .menu-btn:active { transform: translateY(3px); box-shadow: none; }

    .modal {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
        color: white;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(2px);
    }
    .modal-content {
        width: 100%;
        max-width: 500px;
        background: #333;
        border: 2px solid #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .modal-header { font-size: 1.2rem; border-bottom: 2px solid var(--accent); margin-bottom: 10px; padding-bottom: 5px; font-weight: bold;}
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; font-size: 0.9rem; }
    .skill-item, .job-item { background: #444; border: 1px solid #666; padding: 10px; margin-bottom: 6px; cursor: pointer; border-radius: 5px; font-size: 0.9rem; position: relative; }
    .skill-owned { background: #2e7d32; border-color: #4caf50; }
    .btn-close { margin-top: 10px; padding: 12px; width: 100%; background: var(--danger); border: none; color: white; font-weight: bold; border-radius: 6px; cursor: pointer; }
    .event-btn { width: 100%; padding: 12px; margin-bottom: 8px; background: #eee; color: #000; border: none; border-radius: 5px; font-size: 1rem; text-align: left; cursor: pointer; border-left: 5px solid #ccc; transition: all 0.1s;}
    .event-btn:hover { background: #fff; border-left-color: var(--accent); padding-left: 15px; }
    .event-btn:active { background: #ccc; transform: scale(0.98); }
    .important-text { color: #ffeb3b; font-weight: bold; background: rgba(255,0,0,0.2); padding: 5px; border-radius: 4px; }
    
    .job-badge { background: #2196f3; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }
</style>
</head>
<body>

<div id="scaler">
    <div id="game-boy">
        <div id="screen-area">
            <div id="status-bar">
                <span>LV:<span id="ui-lv">1</span></span>
                <span>HP:<span id="ui-hp">100</span></span>
                <span>Â¥:<span id="ui-money">0</span></span>
                <span><span id="ui-job">ãƒ‹ãƒ¼ãƒˆ</span></span>
            </div>
            
            <div id="viewport">
                <div id="map-container">
                    <div id="map-layer"></div>
                    <div id="player-sprite">ğŸ˜</div>
                </div>
                <div id="flash-overlay"></div>
            </div>
            
            <div id="log-window">
                <div class="log-entry">ã‚¢ã‚¸ãƒˆã¨è·å ´ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚</div>
            </div>
        </div>

        <div id="controls">
            <div class="d-pad">
                <div></div><button class="btn-pad" onclick="game.move(0, -1)">â–²</button><div></div>
                <button class="btn-pad" onclick="game.move(-1, 0)">â—€</button>
                <button class="btn-pad" onclick="game.interact()" style="background:#e91e63; color:white; border-color:#c2185b;">A</button>
                <button class="btn-pad" onclick="game.move(1, 0)">â–¶</button>
                <div></div><button class="btn-pad" onclick="game.move(0, 1)">â–¼</button><div></div>
            </div>
            <div class="action-pad">
                <button class="menu-btn" onclick="ui.openMenu()">ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
                <button class="menu-btn" onclick="ui.openSkill()">âš¡ ã‚¹ã‚­ãƒ«</button>
                <button class="menu-btn" style="background:#4caf50; border-color:#388e3c" onclick="game.saveGame()">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-menu" class="modal">
    <div class="modal-content">
        <div class="modal-header">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
        <div class="stat-grid">
            <div>è·æ¥­: <span id="st-job">ãƒ‹ãƒ¼ãƒˆ</span></div>
            <div>å½¹è·: <span id="st-rank">å¹³ç¤¾å“¡</span></div>
            <div>Lv: <span id="st-lv">1</span></div>
            <div>Exp: <span id="st-xp">0</span> / <span id="st-next">30</span></div>
            <div>æ‰€æŒé‡‘: <span id="st-money">0</span>å††</div>
            <div>ã‚¹ãƒˆãƒ¬ã‚¹: <span id="st-stress">0</span>%</div>
            <div>ä½“åŠ›: <span id="st-hp">100</span></div>
            <div>ã‚«ãƒ«ãƒ: <span id="st-karma">0</span></div>
        </div>
        <div>æ‰€æŒå“: <span id="st-items">ãªã—</span></div>
        <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
        <button class="save-btn" onclick="game.loadGame()" style="width:100%; margin-top:10px; padding:10px; background:#ff9800; border:none; border-radius:6px; color:white; cursor:pointer;">ãƒ­ãƒ¼ãƒ‰</button>
    </div>
</div>

<div id="modal-skill" class="modal">
    <div class="modal-content">
        <div class="modal-header">ã‚¹ã‚­ãƒ«ç¿’å¾— (SP: <span id="sk-sp">0</span>)</div>
        <div id="skill-list"></div>
        <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="modal-event" class="modal">
    <div class="modal-content">
        <div class="modal-header" id="ev-title">ã‚¤ãƒ™ãƒ³ãƒˆ</div>
        <div id="ev-body" style="margin-bottom: 15px; font-size: 0.95rem; line-height: 1.4;"></div>
        <div id="ev-actions"></div>
        <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
// --- Config ---
const TILE_SIZE = 32;
const VIEW_W = 13; 
const VIEW_H = 7;
const MAP_W = 40;  
const MAP_H = 40;  

const TERRAIN = {
    GRASS: { id: 0, icon: '', bg: '#8bc34a', walk: true },
    FOREST: { id: 1, icon: 'ğŸŒ²', bg: '#2e7d32', walk: true, cost: 2 },
    WATER:  { id: 2, icon: 'ğŸŒŠ', bg: '#2196f3', walk: false },
    MOUNTAIN:{ id: 3, icon: 'â›°ï¸', bg: '#795548', walk: true, cost: 3 },
    CITY:   { id: 4, icon: '', bg: '#bdbdbd', walk: true },
    WALL:   { id: 5, icon: 'ğŸ§±', bg: '#555', walk: false },
    // Spots
    HOME:   { id: 10, icon: 'ğŸ ', bg: '#ffeb3b', type: 'spot', name: 'å®Ÿå®¶' },
    WORK:   { id: 11, icon: 'ğŸ’¼', bg: '#607d8b', type: 'spot', name: 'ãƒãƒ­ãƒ¯' },
    SHOP:   { id: 12, icon: 'ğŸª', bg: '#ff9800', type: 'spot', name: 'ã‚³ãƒ³ãƒ“ãƒ‹' },
    SLUM:   { id: 13, icon: 'ğŸšï¸', bg: '#3e2723', type: 'spot', name: 'ã‚¹ãƒ©ãƒ ' },
    SHRINE: { id: 14, icon: 'â›©ï¸', bg: '#e91e63', type: 'spot', name: 'ç¥ç¤¾' },
    OFFICE: { id: 15, icon: 'ğŸ¢', bg: '#90caf9', type: 'spot', name: 'ã‚ªãƒ•ã‚£ã‚¹' },
    KOBAN:  { id: 16, icon: 'ğŸ‘®', bg: '#fff', type: 'spot', name: 'äº¤ç•ª' },
    HOUSE:  { id: 17, icon: 'ğŸ˜ï¸', bg: '#a1887f', type: 'spot', name: 'æ°‘å®¶' },
    HIDEOUT:{ id: 18, icon: 'ğŸ´', bg: '#424242', type: 'spot', name: 'ã‚¢ã‚¸ãƒˆ' } // è¿½åŠ 
};

const JOBS = {
    neet: { name: "ãƒ‹ãƒ¼ãƒˆ", req: ()=>true, desc: "å…¨ã¦ã®å§‹ã¾ã‚Šã€‚" },
    homeless: { name: "ãƒ›ãƒ¼ãƒ ãƒ¬ã‚¹", req: ()=>true, desc: "å®Ÿå®¶ã‚’è¿½ã„å‡ºã•ã‚ŒãŸå§¿ã€‚ã‚µãƒã‚¤ãƒãƒ«ãƒ»æ ¹æ€§åŠ¹ç‡UPã€‚" },
    parttime: { name: "åº—å“¡", req: (s)=>s.skills.smile>=1, desc: "è¦:å–¶æ¥­ã‚¹ãƒã‚¤ãƒ«Lv1ã€‚ã‚³ãƒ³ãƒ“ãƒ‹ã§åƒãã€‚" },
    yamibaito: { name: "é—‡ãƒã‚¤ãƒˆ", req: ()=>true, desc: "ã€å±é™ºã€‘å³æ¡ç”¨ãƒ»é«˜åå…¥ãƒ»é€®æ•æœ‰" },
    apology: { name: "è¬ç½ªä»£è¡Œ", req: (s)=>s.skills.smile>=2 && s.skills.guts>=2, desc: "è¦:ã‚¹ãƒã‚¤ãƒ«2/æ ¹æ€§2ã€‚æ°‘å®¶ã§è¬ç½ªã™ã‚‹ã€‚" },
    fighter: { name: "æˆ¦é—˜å“¡", req: (s)=>s.skills.guts>=3 && s.lv>=5, desc: "è¦:æ ¹æ€§3/Lv5ã€‚ã‚¢ã‚¸ãƒˆã§åƒãã€‚" },
    scammer: { name: "å—ã‘å­", req: (s)=>s.skills.criminal>=1 && s.lv>=5, desc: "è¦:è£ã®çŸ¥è­˜/Lv5ã€‚ã‚¢ã‚¸ãƒˆã§åƒãã€‚" },
    regular: { name: "æ­£è¦ç¤¾å“¡", req: (s)=>s.skills.society>=3 && s.lv>=10 && s.items.includes('suit'), desc: "è¦:ç¤¾ä¼šäººLv3/Lv10/ã‚¹ãƒ¼ãƒ„ã€‚ã‚ªãƒ•ã‚£ã‚¹ã§åƒãã€‚" }
};

const SKILLS = {
    survival: { name: "ã‚µãƒã‚¤ãƒãƒ«", cost: 1, max: 5, desc: "é‡å®¿ãƒ»ç§»å‹•åŠ¹ç‡UP" },
    smile: { name: "å–¶æ¥­ã‚¹ãƒã‚¤ãƒ«", cost: 1, max: 3, desc: "æ¥å®¢ãƒ»è¬ç½ªã«å¿…é ˆ" },
    typing: { name: "ã‚¿ã‚¤ãƒ”ãƒ³ã‚°", cost: 2, max: 5, desc: "äº‹å‹™ä½œæ¥­åŠ¹ç‡UP" },
    guts: { name: "æ ¹æ€§", cost: 3, max: 5, desc: "HP/ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§UP" },
    charm: { name: "é­…åŠ›", cost: 3, max: 5, desc: "äº¤æ¸‰ãƒ»è©æ¬ºæˆåŠŸç‡UP" },
    society: { name: "ç¤¾ä¼šäººã¨ã—ã¦ã®å…¨ã¦", cost: 4, max: 5, desc: "æ­£è¦ç¤¾å“¡ã«å¿…é ˆã€‚ãƒãƒŠãƒ¼ãƒ»å¸¸è­˜ã€‚" },
    mote: { name: "ãƒ¢ãƒ†ã‚‹ãŸã‚ã®å…¨ã¦", cost: 4, max: 5, desc: "çµå©šã«å¿…é ˆã€‚å¤–è¦‹ã¨ãƒˆãƒ¼ã‚¯ã€‚" },
    criminal: { name: "è£ã®çŸ¥è­˜", cost: 5, max: 1, desc: "ã‚¹ãƒ©ãƒ è¡—ã§ä¸Šç´šè·" }
};

// --- State ---
let state = {
    x: 20, y: 20,
    lv: 1, xp: 0, nextXp: 30, sp: 0,
    hp: 100, maxHp: 100,
    money: 1000,
    stress: 0,
    karma: 0,
    job: 'neet',
    skills: {},
    items: [],
    flags: {
        married: false,
        myHome: false,
        policeGuard: 0,
        officeRank: 0 // 0:å¹³ç¤¾å“¡ 1:èª²é•· 2:éƒ¨é•·
    },
    mapData: []
};

// --- Game Logic ---
const game = {
    init: function() {
        this.generateMap();
        this.renderMap();
        ui.update();
        setTimeout(fitScreen, 100);
    },

    generateMap: function() {
        state.mapData = [];
        for(let y=0; y<MAP_H; y++){
            let row = [];
            for(let x=0; x<MAP_W; x++){
                let type = TERRAIN.GRASS.id;
                let dist = Math.sqrt((x-20)**2 + (y-20)**2);
                
                let noise = Math.sin(x/5) + Math.cos(y/5) + Math.random()*0.5;
                if (noise > 1.5) type = TERRAIN.MOUNTAIN.id;
                else if (noise > 0.8) type = TERRAIN.FOREST.id;
                else if (noise < -1.0) type = TERRAIN.WATER.id;
                
                if(dist < 10) type = TERRAIN.CITY.id;
                row.push(type);
            }
            state.mapData.push(row);
        }

        // æ–½è¨­é…ç½®
        const set = (x, y, id) => state.mapData[y][x] = id;
        
        set(20, 20, TERRAIN.HOME.id);
        set(20, 19, TERRAIN.WORK.id);
        set(21, 20, TERRAIN.SHOP.id);
        set(22, 19, TERRAIN.OFFICE.id); 
        set(19, 21, TERRAIN.KOBAN.id);  

        set(10, 30, TERRAIN.SLUM.id);
        set(8, 32, TERRAIN.HIDEOUT.id); // ã‚¢ã‚¸ãƒˆ
        set(30, 10, TERRAIN.SHRINE.id);

        set(18, 18, TERRAIN.HOUSE.id);
        set(22, 22, TERRAIN.HOUSE.id);
        set(24, 18, TERRAIN.HOUSE.id);
        set(16, 22, TERRAIN.HOUSE.id);
    },

    getTile: function(x, y) {
        if(x<0 || x>=MAP_W || y<0 || y>=MAP_H) return TERRAIN.WALL;
        return Object.values(TERRAIN).find(t => t.id === state.mapData[y][x]) || TERRAIN.GRASS;
    },

    move: function(dx, dy) {
        if(ui.isModalOpen) return;
        let nx = state.x + dx;
        let ny = state.y + dy;
        let tile = this.getTile(nx, ny);
        if(!tile.walk && tile.type !== 'spot') return;
        
        let cost = tile.cost || 1;
        if(state.skills.survival) cost = Math.max(1, cost - state.skills.survival);
        state.hp -= cost;
        state.x = nx; state.y = ny;

        this.gainXp(2);
        if(state.job === 'homeless' && tile.id === TERRAIN.FOREST.id) this.gainXp(3); 

        this.checkFraudEvent(tile);
        if(Math.random() < 0.05) this.randomEncounter(tile);
        
        if(state.flags.policeGuard > 0) state.flags.policeGuard--;

        this.renderMap();
        ui.update();
        this.checkGameOver();
    },

    interact: function() {
        if(ui.isModalOpen) return;
        let tile = this.getTile(state.x, state.y);
        
        if(tile.id === TERRAIN.HOME.id) this.eventHome();
        else if(tile.id === TERRAIN.WORK.id) this.eventHelloWork();
        else if(tile.id === TERRAIN.SHOP.id) this.eventShop();
        else if(tile.id === TERRAIN.SLUM.id) this.eventSlum();
        else if(tile.id === TERRAIN.HIDEOUT.id) this.eventHideout();
        else if(tile.id === TERRAIN.SHRINE.id) this.eventShrine();
        else if(tile.id === TERRAIN.OFFICE.id) this.eventOffice();
        else if(tile.id === TERRAIN.KOBAN.id) this.eventKoban();
        else if(tile.id === TERRAIN.HOUSE.id) this.eventGenericHouse();
        else game.log("ç‰¹ã«ä½•ã‚‚ãªã„ã€‚");
    },

    gainXp: function(amount) {
        state.xp += amount;
        if(state.xp >= state.nextXp) {
            state.lv++;
            state.xp -= state.nextXp;
            state.nextXp = Math.floor(state.nextXp * 1.5);
            state.sp += 3;
            state.maxHp += 10;
            state.hp = state.maxHp;
            ui.showPopup("LEVEL UP!", "#ffeb3b");
            game.log(`Lv${state.lv}ã«ä¸ŠãŒã£ãŸï¼SP+3`, "good");
        }
    },

    checkFraudEvent: function(tile) {
        if(tile.id === TERRAIN.CITY.id && state.money >= 100000 && Math.random() < 0.03) {
            if(state.flags.policeGuard > 0) {
                game.log("è©æ¬ºå¸«ãŒè¿‘å¯„ã£ã¦ããŸãŒã€è­¦å®˜ã®å§¿ã‚’è¦‹ã¦é€ƒã’ãŸã€‚", "good");
            } else if(state.skills.society >= 3) {
                game.log("è©æ¬ºå¸«ã®å£è»Šã‚’è¦‹æŠœã„ã¦è¿½ã„æ‰•ã£ãŸï¼(ç¤¾ä¼šäººã‚¹ã‚­ãƒ«)", "good");
            } else {
                let loss = Math.floor(state.money * 0.3);
                state.money -= loss;
                state.stress += 50;
                ui.showPopup(`-${loss}å††`, "#ff5252");
                ui.flash('red');
                ui.showEvent("è©æ¬ºè¢«å®³ï¼ï¼", `
                    <p class="important-text">ã€Œã‚ªãƒ¬ã‚ªãƒ¬ï¼äº‹æ•…ã£ã¡ã‚ƒã£ã¦â€¦ã€</p>
                    <p>æ°—ã¥ã„ãŸæ™‚ã«ã¯é‡‘ãŒãªã‹ã£ãŸã€‚</p>
                    <p>-${loss}å††</p>
                `);
            }
        }
    },

    eventHome: function() {
        let houseName = state.flags.myHome ? "ãƒã‚¤ãƒ›ãƒ¼ãƒ " : "å®Ÿå®¶";
        if(state.job === 'homeless' && !state.flags.myHome) {
            ui.showEvent("å®Ÿå®¶", "<p>éµãŒå¤‰ãˆã‚‰ã‚Œã¦ã„ã‚‹â€¦</p>");
            return;
        }
        let html = `<p>${houseName}ã€‚å®‰ã‚‰ãã®å ´æ‰€ã€‚</p>
        <button class="event-btn" onclick="ui.doAction('sleep')">ğŸ›Œ å¯ã‚‹ (å…¨å›å¾©)</button>
        <button class="event-btn" onclick="ui.doAction('study')">ğŸ“š è³‡æ ¼å‹‰å¼· (XP+10)</button>`;
        
        if(state.flags.married) html += `<button class="event-btn" onclick="ui.doAction('love')">ğŸ’• æ„›ã‚’è‚²ã‚€ (ã‚¹ãƒˆãƒ¬ã‚¹è¶…å›å¾©)</button>`;
        else html += `<button class="event-btn" onclick="ui.doAction('pc')">ğŸ’» ãƒãƒƒãƒˆ (ã‚¹ãƒˆãƒ¬ã‚¹-40)</button>`;
        ui.showEvent(houseName, html);
    },

    eventGenericHouse: function() {
        let html = "<p>æ™®é€šã®æ°‘å®¶ã ã€‚</p>";
        if(state.job === 'apology') html += `<button class="event-btn" onclick="ui.doAction('work_apology')">ğŸ™‡ è¬ç½ªä»£è¡Œã™ã‚‹</button>`;
        if(state.job === 'yamibaito' || state.job === 'fighter') html += `<button class="event-btn" onclick="ui.doAction('work_crime')">ğŸ”¨ æŠ¼ã—è¾¼ã¿å¼·ç›—ã™ã‚‹</button>`;
        if(state.job === 'parttime') html += `<button class="event-btn" onclick="ui.doAction('work_sales')">ğŸ“¦ ç½®ãé…ãƒã‚¤ãƒˆ</button>`;
        ui.showEvent("æ°‘å®¶", html);
    },

    eventKoban: function() {
        ui.showEvent("äº¤ç•ª", `
            <p>è¡—ã®å®‰å…¨ã‚’å®ˆã‚‹ã€‚</p>
            <button class="event-btn" onclick="ui.doAction('koban_consult')">ğŸ‘® é˜²çŠ¯ç™»éŒ² (ç„¡æ–™)</button>
            <button class="event-btn" onclick="ui.doAction('koban_lost')">ğŸ˜­ è½ã¨ã—ç‰©å±Š</button>
        `);
    },

    eventOffice: function() {
        let rankName = ["å¹³ç¤¾å“¡", "èª²é•·", "éƒ¨é•·"][state.flags.officeRank || 0];
        let html = `<p>é«˜å±¤ã‚ªãƒ•ã‚£ã‚¹ãƒ“ãƒ«ã€‚<br>ç¾åœ¨ã®å½¹è·: <b>${rankName}</b></p>`;
        
        if(state.job === 'regular') {
            html += `<button class="event-btn" onclick="ui.doAction('work_office')">ğŸ’¼ å‡ºç¤¾ã—ã¦åƒã (å®‰å®šåå…¥)</button>`;
            
            // æ˜‡é€²åˆ¤å®š
            if(state.flags.officeRank === 0 && state.lv >= 20 && state.skills.society >= 4) {
                 html += `<button class="event-btn" style="border-color:gold" onclick="ui.doAction('promote')">ğŸŒŸ èª²é•·æ˜‡é€²è©¦é¨“ã‚’å—ã‘ã‚‹</button>`;
            } else if(state.flags.officeRank === 1 && state.lv >= 35 && state.skills.guts >= 4) {
                 html += `<button class="event-btn" style="border-color:gold" onclick="ui.doAction('promote')">ğŸ‘‘ éƒ¨é•·æ˜‡é€²è©¦é¨“ã‚’å—ã‘ã‚‹</button>`;
            }
        } else {
            html += `<p class="log-sys">â€»æ­£è¦ç¤¾å“¡ã®ã¿å…¥é¤¨å¯èƒ½</p>`;
        }
        
        if(!state.flags.myHome) html += `<button class="event-btn" onclick="ui.doAction('buy_house')">ğŸ  ãƒã‚¤ãƒ›ãƒ¼ãƒ è³¼å…¥ (100ä¸‡å††)</button>`;
        ui.showEvent("ã‚ªãƒ•ã‚£ã‚¹", html);
    },

    eventShop: function() {
        let html = `<p>24æ™‚é–“å–¶æ¥­ã€‚</p>`;
        
        // åº—å“¡ï¼ˆparttimeï¼‰ã®ä»•äº‹
        if(state.job === 'parttime') {
            html += `<button class="event-btn" style="background:#e3f2fd; border-color:#2196f3" onclick="ui.doAction('work_shop')">ğŸª ãƒ¬ã‚¸æ‰“ã¡ãƒã‚¤ãƒˆ (+3000å††)</button><hr>`;
        }

        html += `<button class="event-btn" onclick="ui.doAction('buy', 'food')">ğŸ± å¼å½“ (300å††)</button>
            <button class="event-btn" onclick="ui.doAction('buy', 'drink')">ğŸº é…’ (200å††)</button>`;
        if(!state.items.includes('suit')) html += `<button class="event-btn" onclick="ui.doAction('buy', 'suit')">ğŸ‘” ã‚¹ãƒ¼ãƒ„ã‚’è²·ã† (5ä¸‡å††)</button>`;
        ui.showEvent("ã‚³ãƒ³ãƒ“ãƒ‹", html);
    },

    eventHideout: function() {
        let html = "<p>è–„æš—ã„éƒ¨å±‹ã«å¼·é¢ãªç”·ãŸã¡ãŒã„ã‚‹ã€‚</p>";
        
        if(state.job === 'fighter') {
            html += `<p>ã€ŒãŠã…ã€ä»•äº‹ã®æ™‚é–“ã ãã€</p>
            <button class="event-btn" style="background:#ffebee; border-color:#d32f2f" onclick="ui.doAction('work_fight')">ğŸ‘Š å¯¾ç«‹çµ„ç¹”ã¸ã‚«ãƒã‚³ãƒŸ (+2ä¸‡å††/å±é™º)</button>`;
        } else if (state.job === 'scammer') {
            html += `<p>ã€Œåç°¿ã¯ã“ã“ã«ã‚ã‚‹ã€</p>
            <button class="event-btn" style="background:#fff3e0; border-color:#ff9800" onclick="ui.doAction('work_scam')">ğŸ“ ç¾é‡‘å›åã®é›»è©± (+5ä¸‡å††ã€œ/é«˜ãƒªã‚¹ã‚¯)</button>`;
        } else {
            html += `<p>ã€Œé–¢ä¿‚ã­ãˆå¥´ã¯æ¶ˆãˆãªï¼ã€<br>ç¨ã¾ã‚ŒãŸã ã‘ã§é€ƒã’å‡ºã—ãŸã€‚</p>`;
        }
        ui.showEvent("ã‚¢ã‚¸ãƒˆ", html);
    },

    eventHelloWork: function() {
        let html = "<p>è·æ¥­æ–¡æ—‹æ‰€ã€‚</p>";
        for(let key in JOBS) {
            if(['yamibaito','fighter','scammer','apology'].includes(key)) continue; 
            let j = JOBS[key];
            let color = state.job === key ? "#4caf50" : "";
            html += `<div class="job-item" style="border-color:${color}" onclick="ui.doAction('change_job', '${key}')">
                <b>${j.name}</b><br><small>${j.desc}</small>
            </div>`;
        }
        ui.showEvent("ãƒãƒ­ãƒ¼ãƒ¯ãƒ¼ã‚¯", html);
    },

    eventSlum: function() {
        let html = "<p>å±é™ºãªåŒ‚ã„ãŒã™ã‚‹ã‚¨ãƒªã‚¢ã€‚</p>";
        const darkJobs = ['yamibaito', 'apology', 'scammer', 'fighter'];
        darkJobs.forEach(key => {
            let j = JOBS[key];
            html += `<div class="job-item" style="border-color:#ff5252" onclick="ui.doAction('change_job', '${key}')">
                <b>${j.name}</b><br><small>${j.desc}</small>
            </div>`;
        });
        ui.showEvent("ã‚¹ãƒ©ãƒ è¡—", html);
    },
    
    eventShrine: function() {
        let html = `<p>ç¥è–ãªå ´æ‰€ã€‚</p>
            <button class="event-btn" onclick="ui.doAction('pray', 100)">ğŸ™ ç¥ˆã‚‹ (-100å††/ã‚«ãƒ«ãƒæµ„åŒ–)</button>
            <button class="event-btn" onclick="ui.doAction('pray', -100)">ğŸ’° è³½éŠ­æ³¥æ£’ (å±é™º)</button>`;
        if(!state.flags.married) html += `<hr><button class="event-btn" onclick="ui.doAction('marry_check')">ğŸ’ ãƒ—ãƒ­ãƒãƒ¼ã‚ºã™ã‚‹ (è¦:30ä¸‡å††/æ­£è¦ç¤¾å“¡)</button>`;
        ui.showEvent("ç¥ç¤¾", html);
    },

    checkGameOver: function() {
        if(state.hp <= 0) {
            ui.flash('red');
            alert("éåŠ´ã§å€’ã‚Œã¾ã—ãŸâ€¦ç—…é™¢é€ã‚Šã§ã™ã€‚");
            state.hp = state.maxHp;
            state.money = Math.floor(state.money / 2);
            state.x = 20; state.y = 20;
            state.job = 'neet';
            game.renderMap();
        }
        if(state.stress >= 100) {
            ui.flash('red');
            game.log("ã‚¹ãƒˆãƒ¬ã‚¹é™ç•Œï¼ç™ºç‹‚ã—ã¦æ•£è²¡ï¼", "bad");
            state.money = Math.max(0, state.money - 50000);
            state.stress = 0;
            if(state.flags.married) {
                game.log("é…å¶è€…ã«æ„›æƒ³ã‚’å°½ã‹ã•ã‚Œé›¢å©šã—ãŸâ€¦", "bad");
                state.flags.married = false;
            }
        }
    },

    randomEncounter: function(tile) {
        if(tile.id === TERRAIN.CITY.id) { 
             game.log("è¡—ã®é¨’éŸ³ã§é ­ãŒç—›ã„ã€‚", "sys"); state.stress+=2;
        }
    },
    
    saveGame: function() {
        localStorage.setItem('houseiRPG37_save', JSON.stringify(state));
        alert("ã‚»ãƒ¼ãƒ–å®Œäº†");
    },
    
    loadGame: function() {
        let d = localStorage.getItem('houseiRPG37_save');
        if(d) { state = JSON.parse(d); game.generateMap(); game.renderMap(); ui.update(); ui.closeAll(); alert("ãƒ­ãƒ¼ãƒ‰å®Œäº†"); }
    },

    log: function(msg, type='') {
        const win = document.getElementById('log-window');
        const div = document.createElement('div');
        div.className = "log-entry " + (type ? 'log-'+type : '');
        div.innerText = msg;
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    },

    renderMap: function() {
        const layer = document.getElementById('map-layer');
        layer.innerHTML = '';
        
        let startX = state.x - Math.floor(VIEW_W/2);
        let startY = state.y - Math.floor(VIEW_H/2);

        for(let y=0; y<VIEW_H; y++) {
            for(let x=0; x<VIEW_W; x++) {
                let mapX = startX + x;
                let mapY = startY + y;
                let tile = this.getTile(mapX, mapY);
                let div = document.createElement('div');
                div.className = 'tile';
                div.style.left = (x * TILE_SIZE) + 'px';
                div.style.top = (y * TILE_SIZE) + 'px';
                div.innerText = tile.icon;
                div.style.backgroundColor = tile.bg;
                layer.appendChild(div);
            }
        }
        
        let face = "ğŸ˜";
        if(state.job === 'host') face = "ğŸ˜";
        if(['yamibaito','scammer','fighter'].includes(state.job)) face = "ğŸ•¶ï¸";
        if(state.job === 'apology') face = "ğŸ™‡";
        if(state.job === 'regular') face = "ğŸ‘”";
        if(state.stress > 80) face = "ğŸ˜±";
        if(state.hp < 20) face = "ğŸ¤¢";
        if(state.flags.married && state.stress < 20) face = "ğŸ¥°";

        const sprite = document.getElementById('player-sprite');
        sprite.innerText = face;
        sprite.style.left = (Math.floor(VIEW_W/2) * TILE_SIZE) + 'px';
        sprite.style.top = (Math.floor(VIEW_H/2) * TILE_SIZE) + 'px';
    }
};

const ui = {
    isModalOpen: false,

    update: function() {
        document.getElementById('ui-lv').innerText = state.lv;
        document.getElementById('ui-hp').innerText = state.hp;
        document.getElementById('ui-money').innerText = state.money;
        document.getElementById('ui-job').innerText = JOBS[state.job].name;
    },

    showPopup: function(text, color="#fff") {
        const container = document.getElementById('player-sprite');
        const el = document.createElement('div');
        el.className = 'popup-text';
        el.innerText = text;
        el.style.color = color;
        document.getElementById('viewport').appendChild(el);
        
        const sprite = document.getElementById('player-sprite');
        el.style.left = sprite.style.left;
        el.style.top = sprite.style.top;

        setTimeout(() => el.remove(), 1000);
    },

    flash: function(color) {
        const ov = document.getElementById('flash-overlay');
        ov.style.backgroundColor = color;
        ov.style.opacity = 0.5;
        setTimeout(() => ov.style.opacity = 0, 100);
    },

    openMenu: function() {
        this.isModalOpen = true;
        document.getElementById('modal-menu').style.display = 'flex';
        let rankName = ["å¹³ç¤¾å“¡", "èª²é•·", "éƒ¨é•·"][state.flags.officeRank || 0];
        
        document.getElementById('st-job').innerText = JOBS[state.job].name;
        document.getElementById('st-rank').innerText = state.job === 'regular' ? rankName : "-";
        document.getElementById('st-partner').innerText = state.flags.married ? "ã‚ã‚Š(ãƒ©ãƒ–ãƒ©ãƒ–)" : "ãªã—";
        document.getElementById('st-lv').innerText = state.lv;
        document.getElementById('st-xp').innerText = state.xp;
        document.getElementById('st-next').innerText = state.nextXp;
        document.getElementById('st-money').innerText = state.money;
        document.getElementById('st-stress').innerText = state.stress;
        document.getElementById('st-hp').innerText = state.hp + "/" + state.maxHp;
        document.getElementById('st-sp').innerText = state.sp;
        document.getElementById('st-karma').innerText = state.karma;
        
        let items = state.items.map(i => i === 'suit' ? 'ã‚¹ãƒ¼ãƒ„' : i).join(', ');
        document.getElementById('st-items').innerText = items || "ãªã—";
    },

    openSkill: function() {
        this.isModalOpen = true;
        document.getElementById('modal-skill').style.display = 'flex';
        document.getElementById('sk-sp').innerText = state.sp;
        const list = document.getElementById('skill-list');
        list.innerHTML = "";
        for(let key in SKILLS) {
            let s = SKILLS[key];
            let currentLv = state.skills[key] || 0;
            let cls = currentLv > 0 ? "skill-item skill-owned" : "skill-item";
            list.innerHTML += `<div class="${cls}" onclick="ui.learnSkill('${key}')">
                <b>${s.name}</b> (Lv.${currentLv}/${s.max}) SP:${s.cost}<br>
                <small>${s.desc}</small>
            </div>`;
        }
    },

    learnSkill: function(key) {
        let s = SKILLS[key];
        let currentLv = state.skills[key] || 0;
        if(currentLv >= s.max) return alert("æœ€å¤§ãƒ¬ãƒ™ãƒ«ã§ã™");
        if(state.sp < s.cost) return alert("SPãŒè¶³ã‚Šã¾ã›ã‚“");
        if(confirm(`${s.name} ã‚’ç¿’å¾—ã—ã¾ã™ã‹ï¼Ÿ`)) {
            state.sp -= s.cost;
            state.skills[key] = currentLv + 1;
            ui.showPopup("SKILL UP!", "#69f0ae");
            game.log(`${s.name} Lv${currentLv+1} ç¿’å¾—ï¼`, "good");
            this.openSkill();
        }
    },

    showEvent: function(title, html) {
        this.isModalOpen = true;
        document.getElementById('modal-event').style.display = 'flex';
        document.getElementById('ev-title').innerText = title;
        document.getElementById('ev-body').innerHTML = html;
        document.getElementById('ev-actions').innerHTML = "";
    },

    closeAll: function() {
        this.isModalOpen = false;
        document.querySelectorAll('.modal').forEach(e => e.style.display = 'none');
    },

    doAction: function(act, param) {
        let success = true;
        
        // --- ç”Ÿæ´» ---
        if(act === 'sleep') { 
            state.hp = state.maxHp; state.stress = Math.max(0, state.stress - 20); 
            ui.flash('white'); ui.showPopup("HPå…¨å¿«", "#69f0ae"); game.log("ãã£ã™ã‚Šå¯ãŸã€‚"); 
        }
        else if(act === 'study') { 
            state.xp += 10; state.stress += 5; game.gainXp(0); 
            ui.showPopup("XP+10", "#fff"); game.log("å‹‰å¼·ã—ãŸ(XP+10)"); 
        }
        else if(act === 'pc') { 
            state.stress = Math.max(0, state.stress - 40); 
            ui.showPopup("ã‚¹ãƒˆãƒ¬ã‚¹â†“", "#2196f3"); game.log("ãƒãƒƒãƒˆã‚µãƒ¼ãƒ•ã‚£ãƒ³ã—ãŸã€‚"); 
        }
        else if(act === 'love') { 
            state.stress = 0; ui.flash('pink'); ui.showPopup("LOVE!!", "#e91e63"); 
            game.log("å¹¸ã›ãªæ™‚é–“ã‚’éã”ã—ãŸã€‚", "good"); 
        }
        
        // --- è²·ã„ç‰© ---
        else if(act === 'buy') {
            if(param === 'food' && state.money >= 300) { 
                state.money -= 300; state.hp += 50; 
                ui.showPopup("HP+50", "#69f0ae"); game.log("å¼å½“ã‚’é£Ÿã¹ãŸã€‚"); 
            }
            else if(param === 'drink' && state.money >= 200) { 
                state.money -= 200; state.stress -= 30; 
                ui.showPopup("ã‚¹ãƒˆãƒ¬ã‚¹â†“", "#2196f3"); game.log("é…’ã‚’é£²ã‚“ã ã€‚"); 
            }
            else if(param === 'suit') {
                if(state.money < 50000) return alert("é‡‘ãŒè¶³ã‚Šãªã„ï¼");
                state.money -= 50000;
                state.items.push('suit');
                ui.showPopup("-5ä¸‡å††", "#ff5252");
                game.log("ã‚¹ãƒ¼ãƒ„ã‚’è³¼å…¥ã—ãŸï¼å°±è·æ´»å‹•ãŒã§ãã‚‹ï¼", "good");
            }
        }
        
        // --- è»¢è· ---
        else if(act === 'change_job') {
            let j = JOBS[param];
            if(!j.req(state)) { alert("æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“\n" + j.desc); success = false; }
            else { 
                state.job = param; 
                ui.flash('white');
                game.log(`${j.name}ã«è»¢è·ã—ãŸï¼`, "good"); 
            }
        }

        // --- ä»•äº‹ï¼ˆNew!ï¼‰ ---
        
        // åº—å“¡ï¼ˆã‚³ãƒ³ãƒ“ãƒ‹ï¼‰
        else if(act === 'work_shop') {
            state.money += 3000; state.hp -= 15; state.stress += 10; game.gainXp(10);
            ui.showPopup("+3000å††", "#ffeb3b");
            game.log("ã€Œæ¸©ã‚ã¾ã™ã‹ï¼Ÿã€æ©Ÿæ¢°çš„ãªæ¥å®¢ã‚’ã—ãŸã€‚", "good");
        }

        // æ­£è¦ç¤¾å“¡ï¼ˆã‚ªãƒ•ã‚£ã‚¹ï¼‰
        else if(act === 'work_office') {
            let rankBonus = (state.flags.officeRank || 0) * 10000;
            let earn = 15000 + rankBonus + (state.skills.society * 2000) + (state.skills.typing * 1000);
            state.money += earn; state.hp -= 30; state.stress += 25; game.gainXp(25);
            ui.showPopup(`+${earn}å††`, "#ffeb3b");
            game.log(`å®šæ™‚ã¾ã§åƒã„ãŸã€‚(å½¹è·æ‰‹å½“:+${rankBonus})`, "good");
        }
        
        // æ˜‡é€²ï¼ˆã‚ªãƒ•ã‚£ã‚¹ï¼‰
        else if(act === 'promote') {
            state.flags.officeRank = (state.flags.officeRank || 0) + 1;
            ui.flash('gold');
            ui.showPopup("æ˜‡é€²ï¼ï¼", "#ffeb3b");
            game.log("æ˜‡é€²è©¦é¨“ã«åˆæ ¼ã—ãŸï¼çµ¦æ–™ã‚¢ãƒƒãƒ—ï¼", "good");
        }

        // æˆ¦é—˜å“¡ï¼ˆã‚¢ã‚¸ãƒˆï¼‰
        else if(act === 'work_fight') {
            if(Math.random() < 0.1) {
                state.hp = 1; state.money = Math.floor(state.money * 0.8);
                ui.flash('red'); ui.showPopup("è¿”ã‚Šè¨ã¡", "#d32f2f");
                game.log("æ•µå¯¾çµ„ç¹”ã«å›²ã¾ã‚Œãƒœã‚³ãƒœã‚³ã«ã•ã‚ŒãŸâ€¦", "bad");
            } else {
                let earn = 20000 + (Math.random()*10000);
                state.money += Math.floor(earn); state.hp -= 40; state.karma -= 20; game.gainXp(50);
                ui.showPopup(`+${Math.floor(earn)}å††`, "#ffeb3b");
                game.log("æŠ—äº‰ã«å‹åˆ©ã—ãŸï¼", "good");
            }
        }

        // å—ã‘å­ï¼ˆã‚¢ã‚¸ãƒˆï¼‰
        else if(act === 'work_scam') {
             if(Math.random() < 0.2) {
                state.money = 0; state.job = 'neet'; state.stress=100;
                ui.flash('blue');
                game.log("è­¦å¯Ÿã ï¼é€®æ•ï¼å…¨ã¦ã‚’æ²¡åã•ã‚ŒãŸï¼", "bad");
            } else {
                let earn = 50000 + (state.skills.charm * 10000);
                state.money += Math.floor(earn); state.karma -= 50; state.stress += 40; game.gainXp(40);
                ui.showPopup(`+${Math.floor(earn)}å††`, "#ffeb3b");
                game.log("è€äººã‚’é¨™ã—ã¦é‡‘ã‚’å›åã—ãŸâ€¦è‰¯å¿ƒãŒç—›ã‚€ã€‚", "warn");
            }
        }
        
        // --- æ—¢å­˜ã®ä»•äº‹ ---
        else if(act === 'work_apology') { 
            let earn = 8000 + (state.skills.smile * 2000);
            state.money += earn; state.hp -= 20; state.stress += 40; game.gainXp(15);
            ui.flash('purple'); ui.showPopup(`+${earn}å††`, "#ffeb3b");
            game.log(`åœŸä¸‹åº§ã—ã¦${earn}å††å¾—ãŸã€‚`, "warn");
        }
        else if(act === 'work_crime') { 
            if(Math.random() < 0.3) {
                state.money = 0; state.job = 'neet'; state.stress=100;
                ui.flash('red'); game.log("è­¦å¯Ÿã ï¼é€®æ•ï¼", "bad");
            } else {
                let earn = 50000 + (Math.random()*50000);
                state.money += Math.floor(earn); state.karma -= 50; state.stress += 50;
                ui.showPopup(`+${Math.floor(earn)}å††`, "#ffeb3b");
                game.log(`æŠ¼ã—å…¥ã£ã¦${Math.floor(earn)}å††å¥ªã£ãŸï¼`, "bad");
            }
        }
        else if(act === 'work_sales') {
            state.money += 2000; state.hp -= 10; game.gainXp(5);
            ui.showPopup("+2000å††", "#ffeb3b");
            game.log("è·ç‰©ã‚’ç½®ã„ãŸã€‚+2000å††");
        }

        // --- äº¤ç•ª ---
        else if(act === 'koban_consult') {
            state.flags.policeGuard = 100;
            ui.showPopup("é˜²çŠ¯ç™»éŒ²å®Œäº†", "#2196f3");
            game.log("ãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«å¼·åŒ–ï¼", "good");
        }
        else if(act === 'koban_lost') {
            if(Math.random() < 0.2) {
                let found = 1000 + Math.floor(Math.random()*5000);
                state.money += found;
                ui.showPopup(`+${found}å††`, "#ffeb3b");
                game.log(`è¬ç¤¼${found}å††ã‚’ã‚‚ã‚‰ã£ãŸï¼`, "good");
            } else {
                game.log("å±Šã„ã¦ã„ãªã‹ã£ãŸã€‚");
            }
        }

        // --- ãã®ä»– ---
        else if(act === 'pray') {
            if(param > 0 && state.money>=100) { 
                state.money-=100; state.karma = Math.max(0, state.karma+10); 
                ui.flash('white'); game.log("å¿ƒãŒæ´—ã‚ã‚ŒãŸã€‚"); 
            }
            else if(param < 0) { 
                state.money+=500; state.karma-=30; 
                ui.flash('red'); ui.showPopup("ãƒãƒå½“ãŸã‚Š", "#ff5252");
                game.log("è³½éŠ­ã‚’ç›—ã‚“ã â€¦", "bad"); 
            }
        }
        else if(act === 'buy_house') {
            if(state.money < 1000000) return alert("100ä¸‡å††å¿…è¦ã§ã™ã€‚");
            if(confirm("100ä¸‡å††ã§ãƒã‚¤ãƒ›ãƒ¼ãƒ ã‚’è²·ã„ã¾ã™ã‹ï¼Ÿ")) {
                state.money -= 1000000;
                state.flags.myHome = true;
                ui.flash('gold');
                game.log("ãƒã‚¤ãƒ›ãƒ¼ãƒ ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼ï¼ï¼", "good");
            }
        }
        else if(act === 'marry_check') {
            if(state.job !== 'regular') return alert("ã€Œæ­£è¦ç¤¾å“¡ã˜ã‚ƒãªã„ã¨ç„¡ç†ã€");
            if(state.lv < 15) return alert("ã€ŒLv15ä»¥ä¸Šã¯æ¬²ã—ã„ã‚ã€");
            if((state.skills.mote || 0) < 3) return alert("ã€Œè©±ãŒã¤ã¾ã‚‰ãªã„ã‚ï¼ˆãƒ¢ãƒ†Lv3ï¼‰ã€");
            if(state.money < 300000) return alert("è³‡é‡‘ï¼ˆ30ä¸‡å††ï¼‰ä¸è¶³ï¼");
            
            if(confirm("30ä¸‡å††æ”¯æ‰•ã£ã¦çµå©šã—ã¾ã™ã‹ï¼Ÿ")) {
                state.money -= 300000;
                state.flags.married = true;
                ui.flash('pink');
                game.log("çµå©šã—ã¾ã—ãŸï¼", "good");
            }
        }

        if(success) this.closeAll();
        ui.update();
        game.checkGameOver();
    }
};

function fitScreen() {
    const gameBoy = document.getElementById('game-boy');
    const wrapper = document.getElementById('scaler');
    gameBoy.style.transform = 'none';
    const scale = Math.min(wrapper.clientHeight / (gameBoy.offsetHeight + 20), wrapper.clientWidth / (gameBoy.offsetWidth + 20));
    gameBoy.style.transform = `scale(${Math.min(scale, 1)})`;
}
window.addEventListener('load', fitScreen);
window.addEventListener('resize', fitScreen);

window.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowUp') game.move(0, -1);
    if(e.key === 'ArrowDown') game.move(0, 1);
    if(e.key === 'ArrowLeft') game.move(-1, 0);
    if(e.key === 'ArrowRight') game.move(1, 0);
    if(e.key === 'z' || e.key === 'Enter') game.interact();
});

game.init();
</script>
</body>
</html>
