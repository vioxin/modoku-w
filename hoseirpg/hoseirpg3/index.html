<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ã»ã†ã›ã„RPG 3 ã€œå¤§è‡ªç„¶ã¨è³‡æœ¬ä¸»ç¾©ã€œ</title>
<style>
    :root {
        --bg-color: #202020;
        --screen-bg: #e0f0e0;
        --ui-bg: #333;
        --text-color: #fff;
        --accent: #4caf50;
        --danger: #ff5252;
        --tile-size: 32px;
    }
    
    * { box-sizing: border-box; touch-action: manipulation; }
    
    body {
        background: var(--bg-color);
        color: var(--text-color);
        font-family: 'Courier New', monospace;
        margin: 0;
        height: 100dvh; 
        width: 100vw;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    /* ã‚²ãƒ¼ãƒ å…¨ä½“ã‚’åŒ…ã‚€ãƒ©ãƒƒãƒ‘ãƒ¼ */
    #scaler {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }

    #game-boy {
        width: 100%;
        max-width: 450px;
        display: flex;
        flex-direction: column;
        background: #444;
        border: 2px solid #666;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        height: auto;
        transform-origin: center center;
    }

    #screen-area {
        background: var(--screen-bg);
        border: 4px solid #222;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
    }

    #status-bar {
        background: #222;
        color: #fff;
        padding: 4px 8px;
        font-size: 11px;
        display: flex;
        justify-content: space-between;
        z-index: 10;
        border-bottom: 2px solid #000;
    }

    #viewport {
        position: relative;
        overflow: hidden;
        background: #333;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #map-container {
        position: relative;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    .tile {
        position: absolute;
        width: var(--tile-size);
        height: var(--tile-size);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        line-height: 1;
    }
    
    #player-sprite {
        position: absolute;
        width: var(--tile-size);
        height: var(--tile-size);
        font-size: 24px;
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 1;
    }

    #log-window {
        height: 60px;
        background: rgba(0,0,0,0.85);
        color: #fff;
        font-size: 12px;
        padding: 5px;
        overflow-y: auto;
        border-top: 2px solid #fff;
    }
    .log-sys { color: #aaa; }
    .log-warn { color: #ffeb3b; }
    .log-bad { color: #ff5252; }

    #controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        padding: 5px;
    }

    .d-pad {
        display: grid;
        grid-template-columns: 45px 45px 45px;
        grid-template-rows: 45px 45px 45px;
        gap: 2px;
        align-self: center;
        justify-self: center;
    }
    
    .btn-pad {
        background: #222;
        border-radius: 6px;
        border: 2px solid #111;
        box-shadow: 0 3px 0 #000;
        cursor: pointer;
        color: #555;
        font-size: 18px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
    }
    .btn-pad:active { transform: translateY(3px); box-shadow: none; background: #333; }
    
    .action-pad {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 8px;
    }

    .menu-btn {
        width: 100%;
        max-width: 130px;
        padding: 10px;
        background: #555;
        color: white;
        border: 2px solid #fff;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        box-shadow: 0 3px 0 #222;
        -webkit-tap-highlight-color: transparent;
    }
    .menu-btn:active { transform: translateY(3px); box-shadow: none; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 1000;
        color: white;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        width: 100%;
        max-width: 500px;
        background: #333;
        border: 2px solid #fff;
        padding: 15px;
        border-radius: 8px;
    }
    .modal-header { font-size: 1.2rem; border-bottom: 2px solid var(--accent); margin-bottom: 10px; padding-bottom: 5px; font-weight: bold;}
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; font-size: 0.9rem; }
    .skill-item, .job-item { background: #444; border: 1px solid #666; padding: 8px; margin-bottom: 6px; cursor: pointer; border-radius: 5px; font-size: 0.9rem;}
    .btn-close { margin-top: 10px; padding: 10px; width: 100%; background: var(--danger); border: none; color: white; font-weight: bold; border-radius: 6px; }
    .save-area { display: flex; gap: 10px; margin-top: 10px; }
    .save-btn { flex: 1; padding: 10px; background: #2196f3; color: white; border: none; border-radius: 6px; font-weight: bold; }
    .event-btn { width: 100%; padding: 10px; margin-bottom: 6px; background: #eee; color: #000; border: none; border-radius: 5px; font-size: 0.9rem; text-align: left; }
</style>
</head>
<body>

<div id="scaler">
    <div id="game-boy">
        <div id="screen-area">
            <div id="status-bar">
                <span>LV:<span id="ui-lv">1</span></span>
                <span>HP:<span id="ui-hp">100</span></span>
                <span>Â¥:<span id="ui-money">0</span></span>
                <span><span id="ui-job">ãƒ‹ãƒ¼ãƒˆ</span></span>
            </div>
            <div id="viewport">
                <div id="map-container">
                    <div id="map-layer"></div>
                    <div id="player-sprite">ğŸ˜</div>
                </div>
            </div>
            <div id="log-window">
                <div>ã‚ˆã†ã“ãã€‚å®Ÿå®¶ã§å‹‰å¼·ã—ã¦Lvã‚’ä¸Šã’ã‚ˆã†ã€‚</div>
            </div>
        </div>

        <div id="controls">
            <div class="d-pad">
                <div></div><button class="btn-pad" onclick="game.move(0, -1)">â–²</button><div></div>
                <button class="btn-pad" onclick="game.move(-1, 0)">â—€</button>
                <button class="btn-pad" onclick="game.interact()" style="background:#e91e63; color:white; border-color:#c2185b;">A</button>
                <button class="btn-pad" onclick="game.move(1, 0)">â–¶</button>
                <div></div><button class="btn-pad" onclick="game.move(0, 1)">â–¼</button><div></div>
            </div>
            <div class="action-pad">
                <button class="menu-btn" onclick="ui.openMenu()">ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
                <button class="menu-btn" onclick="ui.openSkill()">âš¡ ã‚¹ã‚­ãƒ«</button>
                <button class="menu-btn" style="background:#4caf50; border-color:#388e3c" onclick="game.saveGame()">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-menu" class="modal">
    <div class="modal-content">
        <div class="modal-header">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
        <div class="stat-grid">
            <div>åå‰: ã»ã†ã›ã„</div>
            <div>è·æ¥­: <span id="st-job">ãƒ‹ãƒ¼ãƒˆ</span></div>
            <div>ãƒ¬ãƒ™ãƒ«: <span id="st-lv">1</span></div>
            <div>çµŒé¨“å€¤: <span id="st-xp">0</span> / <span id="st-next">30</span></div>
            <div>æ‰€æŒé‡‘: <span id="st-money">0</span>å††</div>
            <div>ã‚¹ãƒˆãƒ¬ã‚¹: <span id="st-stress">0</span>%</div>
            <div>ä½“åŠ›: <span id="st-hp">100</span> / <span id="st-maxhp">100</span></div>
            <div>ã‚¹ã‚­ãƒ«P: <span id="st-sp">0</span></div>
            <div>ã‚«ãƒ«ãƒ: <span id="st-karma">0</span></div>
        </div>
        <div class="save-area">
            <button class="save-btn" onclick="game.saveGame()">ã‚»ãƒ¼ãƒ–</button>
            <button class="save-btn" onclick="game.loadGame()" style="background:#ff9800">ãƒ­ãƒ¼ãƒ‰</button>
        </div>
        <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="modal-skill" class="modal">
    <div class="modal-content">
        <div class="modal-header">ã‚¹ã‚­ãƒ«ç¿’å¾— (SP: <span id="sk-sp">0</span>)</div>
        <div id="skill-list"></div>
        <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="modal-event" class="modal">
    <div class="modal-content">
        <div class="modal-header" id="ev-title">ã‚¤ãƒ™ãƒ³ãƒˆ</div>
        <div id="ev-body" style="margin-bottom: 15px; font-size: 0.95rem; line-height: 1.4;">å†…å®¹</div>
        <div id="ev-actions"></div>
        <button class="btn-close" onclick="ui.closeAll()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
/**
 * ã»ã†ã›ã„RPG 3 - Easy Start Edition
 */

// ç”»é¢ã‚µã‚¤ã‚ºè¨­å®š
const TILE_SIZE = 32;
const VIEW_W = 13; 
const VIEW_H = 7;
const MAP_W = 40;  
const MAP_H = 40;  

const mapContainer = document.getElementById('map-container');
mapContainer.style.width = (VIEW_W * TILE_SIZE) + 'px';
mapContainer.style.height = (VIEW_H * TILE_SIZE) + 'px';

// --- è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‡¦ç† ---
function fitScreen() {
    const gameBoy = document.getElementById('game-boy');
    const wrapper = document.getElementById('scaler');
    gameBoy.style.transform = 'none';
    const wrapperH = wrapper.clientHeight;
    const wrapperW = wrapper.clientWidth;
    const gameH = gameBoy.offsetHeight;
    const gameW = gameBoy.offsetWidth;
    const scaleH = wrapperH / (gameH + 20);
    const scaleW = wrapperW / (gameW + 20);
    let scale = Math.min(scaleH, scaleW);
    if(scale > 1) scale = 1; 
    gameBoy.style.transform = `scale(${scale})`;
}
window.addEventListener('load', fitScreen);
window.addEventListener('resize', fitScreen);


// --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---
const TERRAIN = {
    GRASS: { id: 0, icon: '', bg: '#8bc34a', name: 'è‰åŸ', walk: true },
    FOREST: { id: 1, icon: 'ğŸŒ²', bg: '#2e7d32', name: 'æ£®', walk: true, cost: 2 },
    WATER:  { id: 2, icon: 'ğŸŒŠ', bg: '#2196f3', name: 'å·', walk: false },
    MOUNTAIN:{ id: 3, icon: 'â›°ï¸', bg: '#795548', name: 'å±±', walk: true, cost: 3 },
    CITY:   { id: 4, icon: '', bg: '#9e9e9e', name: 'å¸‚è¡—åœ°', walk: true },
    WALL:   { id: 5, icon: 'ğŸ§±', bg: '#555', name: 'å£', walk: false },
    HOME:   { id: 10, icon: 'ğŸ ', bg: '#ffeb3b', name: 'å®Ÿå®¶', type: 'spot' },
    WORK:   { id: 11, icon: 'ğŸ¢', bg: '#607d8b', name: 'ãƒãƒ­ãƒ¯', type: 'spot' },
    SHOP:   { id: 12, icon: 'ğŸª', bg: '#ff9800', name: 'ã‚³ãƒ³ãƒ“ãƒ‹', type: 'spot' },
    SLUM:   { id: 13, icon: 'ğŸšï¸', bg: '#3e2723', name: 'ã‚¹ãƒ©ãƒ ', type: 'spot' },
    SHRINE: { id: 14, icon: 'â›©ï¸', bg: '#e91e63', name: 'ç¥ç¤¾', type: 'spot' }
};

const JOBS = {
    neet: { name: "ãƒ‹ãƒ¼ãƒˆ", reqLv: 0, skill: null, desc: "åŸºæœ¬è·ã€‚ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§ä½ã€‚" },
    parttime: { name: "åº—å“¡", reqLv: 1, skill: "smile", desc: "ä½è³ƒé‡‘ã ãŒå®‰å®šã€‚" },
    can: { name: "ç©ºãç¼¶", reqLv: 2, skill: "survival", desc: "ä½“åŠ›ã‚’ä½¿ã†ãŒè‡ªç”±ã€‚" },
    writer: { name: "ãƒ©ã‚¤ã‚¿ãƒ¼", reqLv: 5, skill: "typing", desc: "ã‚¹ã‚­ãƒ«ã€Œã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã€å¿…é ˆã€‚" },
    host: { name: "ãƒ›ã‚¹ãƒˆ", reqLv: 8, skill: "charm", desc: "è¦ã€Œé­…åŠ›ã€ã€‚é«˜åå…¥ã€‚" },
    yamibaito: { name: "é—‡ãƒã‚¤ãƒˆ", reqLv: 1, skill: null, desc: "ã€å±é™ºã€‘é«˜é¡å ±é…¬ã ãŒâ€¦é€®æ•ãƒªã‚¹ã‚¯æœ‰" },
    scammer: { name: "å—ã‘å­", reqLv: 5, skill: "criminal", desc: "ã€é—‡ã€‘ãƒ—ãƒ­ã®çŠ¯ç½ªè€…ã€‚" },
};

const SKILLS = {
    survival: { name: "ã‚µãƒã‚¤ãƒãƒ«", cost: 1, max: 5, desc: "æ£®ãƒ»å±±ã®ç§»å‹•ã‚³ã‚¹ãƒˆæ¸›" },
    smile: { name: "å–¶æ¥­ã‚¹ãƒã‚¤ãƒ«", cost: 1, max: 3, desc: "ãƒã‚¤ãƒˆåå…¥UP" },
    typing: { name: "ã‚¿ã‚¤ãƒ”ãƒ³ã‚°", cost: 2, max: 5, desc: "ãƒ‡ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚¯åŠ¹ç‡UP" },
    guts: { name: "æ ¹æ€§", cost: 3, max: 5, desc: "æœ€å¤§HPãƒ»ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§UP" },
    charm: { name: "é­…åŠ›", cost: 3, max: 5, desc: "ã‚¢ã‚¤ãƒ†ãƒ å…¥æ‰‹ç‡UP" },
    negotiation: { name: "äº¤æ¸‰è¡“", cost: 4, max: 3, desc: "å ±é…¬UP" },
    criminal: { name: "è£ã®çŸ¥è­˜", cost: 5, max: 1, desc: "ã‚¹ãƒ©ãƒ è¡—ã§ä¸Šç´šè·" }
};

let state = {
    x: 20, y: 20,
    lv: 1, xp: 0, nextXp: 30, // åˆæœŸãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‚’30ã«ç·©å’Œ
    sp: 0,
    hp: 100, maxHp: 100,
    money: 1000,
    stress: 0,
    karma: 0,
    job: 'neet',
    skills: {},
    flags: {},
    mapData: []
};

const game = {
    init: function() {
        this.generateMap();
        this.renderMap();
        ui.update();
        game.log("é–‹å§‹ã€‚å®Ÿå®¶ã‚’èª¿ã¹ã‚ˆã†ã€‚");
        setTimeout(fitScreen, 100);
    },

    generateMap: function() {
        state.mapData = [];
        for(let y=0; y<MAP_H; y++){
            let row = [];
            for(let x=0; x<MAP_W; x++){
                let noise = Math.sin(x/5) + Math.cos(y/5) + Math.random()*0.5;
                let type = TERRAIN.GRASS.id;
                if (noise > 1.5) type = TERRAIN.MOUNTAIN.id;
                else if (noise > 0.8) type = TERRAIN.FOREST.id;
                else if (noise < -1.0) type = TERRAIN.WATER.id;
                
                let dist = Math.sqrt((x-20)**2 + (y-20)**2);
                if(dist < 8) type = TERRAIN.CITY.id;
                row.push(type);
            }
            state.mapData.push(row);
        }
        this.setTile(20, 20, TERRAIN.HOME.id);
        this.setTile(20, 19, TERRAIN.WORK.id);
        this.setTile(21, 20, TERRAIN.SHOP.id);
        this.setTile(10, 30, TERRAIN.SLUM.id);
        this.setTile(30, 10, TERRAIN.SHRINE.id);
    },

    setTile: function(x, y, id) {
        if(x>=0 && x<MAP_W && y>=0 && y<MAP_H) state.mapData[y][x] = id;
    },

    getTile: function(x, y) {
        if(x<0 || x>=MAP_W || y<0 || y>=MAP_H) return TERRAIN.WALL;
        let id = state.mapData[y][x];
        return Object.values(TERRAIN).find(t => t.id === id) || TERRAIN.GRASS;
    },

    move: function(dx, dy) {
        if(ui.isModalOpen) return;
        let nx = state.x + dx;
        let ny = state.y + dy;
        let tile = this.getTile(nx, ny);
        if(!tile.walk && tile.type !== 'spot') return;
        
        let cost = tile.cost || 1;
        let survivalLv = state.skills.survival || 0;
        if(tile.id === TERRAIN.FOREST.id || tile.id === TERRAIN.MOUNTAIN.id) {
            cost = Math.max(1, cost - survivalLv);
        }
        state.hp -= cost;
        state.x = nx;
        state.y = ny;
        this.gainXp(2); // æ­©ãã ã‘ã§2XPã‚²ãƒƒãƒˆï¼ˆç·©å’Œï¼‰
        if(Math.random() < 0.05) this.randomEncounter(tile);
        this.renderMap();
        ui.update();
        this.checkGameOver();
    },

    interact: function() {
        if(ui.isModalOpen) return;
        let tile = this.getTile(state.x, state.y);
        if(tile.type === 'spot') {
            if(tile.id === TERRAIN.HOME.id) this.eventHome();
            else if(tile.id === TERRAIN.WORK.id) this.eventHelloWork();
            else if(tile.id === TERRAIN.SHOP.id) this.eventShop();
            else if(tile.id === TERRAIN.SLUM.id) this.eventSlum();
            else if(tile.id === TERRAIN.SHRINE.id) this.eventShrine();
        } else {
            game.log("ç‰¹ã«ä½•ã‚‚ãªã„ã€‚");
        }
    },

    gainXp: function(amount) {
        state.xp += amount;
        if(state.xp >= state.nextXp) {
            state.lv++;
            state.xp -= state.nextXp;
            state.nextXp = Math.floor(state.nextXp * 1.5); // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å¹…ã‚’å°‘ã—èª¿æ•´
            state.sp += 3;
            state.maxHp += 10;
            state.hp = state.maxHp;
            game.log(`Lv${state.lv}ã«ãªã£ãŸï¼SP+3`, "warn");
        }
    },

    checkGameOver: function() {
        if(state.hp <= 0) {
            alert("ä½“åŠ›ãŒå°½ãã¾ã—ãŸ...");
            state.hp = state.maxHp;
            state.money = Math.floor(state.money / 2);
            state.x = 20; state.y = 20;
            game.log("ç—…é™¢ã§ç›®è¦šã‚ãŸã€‚é‡‘åŠæ¸›ã€‚", "bad");
            this.renderMap();
        }
        if(state.stress >= 100) {
            game.log("ã‚¹ãƒˆãƒ¬ã‚¹é™ç•Œï¼æ•£è²¡ã—ãŸï¼", "bad");
            state.money = Math.max(0, state.money - 30000);
            state.stress = 0;
        }
        if(state.money >= 1000000) { alert("ã€GOOD ENDã€‘100ä¸‡å††è²¯ã‚ãŸï¼"); this.reset(); }
    },

    reset: function() {
        localStorage.removeItem('houseiRPG3_save');
        location.reload();
    },

    renderMap: function() {
        const layer = document.getElementById('map-layer');
        layer.innerHTML = '';
        
        let startX = state.x - Math.floor(VIEW_W/2);
        let startY = state.y - Math.floor(VIEW_H/2);

        for(let y=0; y<VIEW_H; y++) {
            for(let x=0; x<VIEW_W; x++) {
                let mapX = startX + x;
                let mapY = startY + y;
                let tile = this.getTile(mapX, mapY);
                let div = document.createElement('div');
                div.className = 'tile';
                div.style.left = (x * TILE_SIZE) + 'px';
                div.style.top = (y * TILE_SIZE) + 'px';
                div.innerText = tile.icon;
                div.style.backgroundColor = tile.bg;
                layer.appendChild(div);
            }
        }
        
        let face = "ğŸ˜";
        if(state.job === 'host') face = "ğŸ˜";
        if(state.job === 'yamibaito' || state.job === 'scammer') face = "ğŸ•¶ï¸";
        if(state.stress > 80) face = "ğŸ˜±";
        if(state.hp < 20) face = "ğŸ¤¢";
        document.getElementById('player-sprite').innerText = face;
        
        const sprite = document.getElementById('player-sprite');
        sprite.style.left = (Math.floor(VIEW_W/2) * TILE_SIZE) + 'px';
        sprite.style.top = (Math.floor(VIEW_H/2) * TILE_SIZE) + 'px';
    },

    log: function(msg, type) {
        const box = document.getElementById('log-window');
        const div = document.createElement('div');
        div.innerText = msg;
        if(type) div.className = 'log-' + type;
        box.insertBefore(div, box.firstChild);
    },

    saveGame: function() {
        localStorage.setItem('houseiRPG3_save', JSON.stringify(state));
        alert("ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼");
    },

    loadGame: function() {
        const data = localStorage.getItem('houseiRPG3_save');
        if(data) {
            state = JSON.parse(data);
            this.renderMap();
            ui.update();
            ui.closeAll();
            alert("ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
        } else {
            alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        }
    },

    randomEncounter: function(tile) {
        if(tile.id === TERRAIN.CITY.id) { game.log("ã‚­ãƒ£ãƒƒãƒã‚’ç„¡è¦–ã€‚", "sys"); state.stress += 5; }
        else if(tile.id === TERRAIN.FOREST.id) { game.log("èŠ±ã‚’è¦‹ã¦ç™’ã‚„ã•ã‚ŒãŸã€‚", "sys"); state.stress = Math.max(0, state.stress - 10); }
        else if(tile.id === TERRAIN.SLUM.id) { game.log("å°éŠ­ã‚’ç›—ã¾ã‚ŒãŸï¼", "bad"); state.money = Math.max(0, state.money - 500); }
    },

    eventHome: function() {
        ui.showEvent("å®Ÿå®¶", `
            <p>å®‰æ¯ã®åœ°ã€‚</p>
            <button class="event-btn" onclick="ui.doAction('study')">ğŸ“š è³‡æ ¼å‹‰å¼· (XP+10 / ã‚¹ãƒˆãƒ¬ã‚¹+5)</button>
            <button class="event-btn" onclick="ui.doAction('sleep')">ğŸ›Œ å¯ã‚‹ (HPå…¨å›å¾©)</button>
            <button class="event-btn" onclick="ui.doAction('pc')">ğŸ’» ãƒãƒƒãƒˆ (ã‚¹ãƒˆãƒ¬ã‚¹è§£æ¶ˆ)</button>
        `);
    },

    eventHelloWork: function() {
        let html = "<p>è·æ¥­ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>";
        for(let key in JOBS) {
            let j = JOBS[key];
            if(key === 'yamibaito' || key === 'scammer') continue; 
            html += `<div class="job-item" onclick="ui.doAction('job', '${key}')">
                <b>${j.name}</b> (Lv${j.reqLv}ã€œ)<br>${j.desc}
            </div>`;
        }
        ui.showEvent("ãƒãƒ­ãƒ¼ãƒ¯ãƒ¼ã‚¯", html);
    },

    eventShop: function() {
        ui.showEvent("ã‚³ãƒ³ãƒ“ãƒ‹", `
            <button class="event-btn" onclick="ui.doAction('buy', 'food')">ğŸ± å¼å½“ (300å††/HP+50)</button>
            <button class="event-btn" onclick="ui.doAction('buy', 'drink')">ğŸº é…’ (200å††/ã‚¹ãƒˆãƒ¬ã‚¹-30)</button>
            <button class="event-btn" onclick="ui.doAction('work_parttime')">ğŸ’° ãƒã‚¤ãƒˆ (3æ™‚é–“)</button>
        `);
    },

    eventSlum: function() {
        let html = `<p>æ€ªã—ã„ç”·ãŒç«‹ã£ã¦ã„ã‚‹...<br>ã€Œé‡‘ãŒæ¬²ã—ã„ã®ã‹ï¼Ÿã„ã„ä»•äº‹ãŒã‚ã‚‹ãã€</p>
            <button class="event-btn" onclick="ui.doAction('job', 'yamibaito')">ğŸ˜ˆ é—‡ãƒã‚¤ãƒˆã«å¿œå‹Ÿ (èª°ã§ã‚‚å¯)</button>`;
            
        if(state.skills.criminal >= 1) {
             html += `<button class="event-btn" onclick="ui.doAction('job', 'scammer')">ğŸ’¼ å—ã‘å­ (è¦ã‚¹ã‚­ãƒ«)</button>`;
        }
        ui.showEvent("ã‚¹ãƒ©ãƒ è¡—", html);
    },
    
    eventShrine: function() {
        ui.showEvent("ç¥ç¤¾", `
            <button class="event-btn" onclick="ui.doAction('pray', 100)">ğŸ™ ç¥ˆã‚‹ (-100å††)</button>
            <button class="event-btn" onclick="ui.doAction('pray', -100)">ğŸ’° ç›—ã‚€ (+500å††/ã‚«ãƒ«ãƒâ†“)</button>
        `);
    }
};

const ui = {
    isModalOpen: false,

    update: function() {
        document.getElementById('ui-lv').innerText = state.lv;
        document.getElementById('ui-hp').innerText = state.hp;
        document.getElementById('ui-money').innerText = state.money;
        document.getElementById('ui-job').innerText = JOBS[state.job].name;
    },

    openMenu: function() {
        this.isModalOpen = true;
        document.getElementById('modal-menu').style.display = 'flex';
        document.getElementById('st-job').innerText = JOBS[state.job].name;
        document.getElementById('st-lv').innerText = state.lv;
        document.getElementById('st-xp').innerText = state.xp;
        document.getElementById('st-next').innerText = state.nextXp;
        document.getElementById('st-money').innerText = state.money;
        document.getElementById('st-stress').innerText = state.stress;
        document.getElementById('st-hp').innerText = state.hp;
        document.getElementById('st-maxhp').innerText = state.maxHp;
        document.getElementById('st-sp').innerText = state.sp;
        document.getElementById('st-karma').innerText = state.karma;
    },

    openSkill: function() {
        this.isModalOpen = true;
        document.getElementById('modal-skill').style.display = 'flex';
        document.getElementById('sk-sp').innerText = state.sp;
        const list = document.getElementById('skill-list');
        list.innerHTML = "";
        for(let key in SKILLS) {
            let s = SKILLS[key];
            let currentLv = state.skills[key] || 0;
            let cls = currentLv > 0 ? "skill-item skill-owned" : "skill-item";
            list.innerHTML += `<div class="${cls}" onclick="ui.learnSkill('${key}')"><b>${s.name}</b> (Lv.${currentLv}/${s.max}) SP:${s.cost}</div>`;
        }
    },

    learnSkill: function(key) {
        let s = SKILLS[key];
        let currentLv = state.skills[key] || 0;
        if(currentLv >= s.max) return alert("æœ€å¤§ã§ã™");
        if(state.sp < s.cost) return alert("SPä¸è¶³");
        if(confirm(`ç¿’å¾—ã—ã¾ã™ã‹ï¼Ÿ`)) {
            state.sp -= s.cost;
            state.skills[key] = currentLv + 1;
            game.log(`${s.name}ç¿’å¾—ï¼`, "warn");
            this.openSkill();
        }
    },

    showEvent: function(title, html) {
        this.isModalOpen = true;
        document.getElementById('modal-event').style.display = 'flex';
        document.getElementById('ev-title').innerText = title;
        document.getElementById('ev-body').innerHTML = html;
    },

    closeAll: function() {
        this.isModalOpen = false;
        document.querySelectorAll('.modal').forEach(e => e.style.display = 'none');
    },

    doAction: function(act, param) {
        let success = true;
        if(act === 'study') { 
            state.xp += 10; 
            state.stress += 5; 
            game.log("å‹‰å¼·ã—ãŸ(XP+10)");
            game.gainXp(0); // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
        }
        else if(act === 'sleep') { state.hp = state.maxHp; state.stress = Math.max(0, state.stress - 20); game.log("å¯ãŸã€‚"); }
        else if(act === 'pc') { state.stress = Math.max(0, state.stress - 40); game.log("ãƒ¬ã‚¹ãƒã—ãŸã€‚"); }
        else if(act === 'buy') {
            if(param === 'food' && state.money >= 300) { state.money -= 300; state.hp += 50; game.log("å¼å½“é£Ÿã£ãŸã€‚"); }
            else if(param === 'drink' && state.money >= 200) { state.money -= 200; state.stress -= 30; game.log("é£²ã‚“ã ã€‚"); }
            else { alert("é‡‘ä¸è¶³ï¼"); success = false; }
        }
        else if(act === 'job') {
            let j = JOBS[param];
            if(state.lv < j.reqLv) { alert("ãƒ¬ãƒ™ãƒ«ä¸è¶³"); success = false; }
            else if(j.skill && !state.skills[j.skill]) { alert("ã‚¹ã‚­ãƒ«ä¸è¶³"); success = false; }
            else { 
                state.job = param; 
                game.log(param==='yamibaito'?"é—‡ã«æ‰‹ã‚’æŸ“ã‚ãŸ...":"è»¢è·ï¼", "warn"); 
                if(param==='yamibaito' || param==='scammer') state.karma-=50; 
            }
        }
        else if(act === 'work_parttime') {
            if(state.job === 'neet') { alert("ãƒ‹ãƒ¼ãƒˆã¯ä¸å¯"); success = false; }
            else {
                if(state.job === 'yamibaito') {
                    if(Math.random() < 0.3) { 
                        state.money = 0;
                        state.stress = 100;
                        state.job = 'neet';
                        game.log("è­¦å¯Ÿã ï¼ï¼é€®æ•ã•ã‚ŒãŸï¼å…¨è²¡ç”£æ²¡åï¼†ã‚¯ãƒ“ï¼", "bad");
                    } else {
                        let earn = 30000 + Math.floor(Math.random() * 20000); 
                        state.money += earn; state.stress += 50; state.karma -= 30;
                        game.log(`ãƒ¤ãƒã„ä»•äº‹ã§${earn}å††ç¨¼ã„ã ...`, "warn");
                    }
                } else {
                    let earn = (state.job==='host'?10000:state.job==='scammer'?50000:1000) + (state.skills.smile?500*state.skills.smile:0);
                    if(state.job==='scammer' && Math.random()<0.1) { earn=0; game.log("è­¦å¯Ÿã ï¼é€ƒã’ãŸï¼", "bad"); }
                    state.money += earn; state.stress += 10; state.hp -= 20; game.gainXp(10);
                    game.log(`${earn}å††ç¨¼ã„ã ã€‚`);
                }
            }
        }
        else if(act === 'pray') {
            if(param > 0 && state.money>=100) { state.money-=100; state.karma+=10; game.log("ç¥ˆã£ãŸã€‚"); }
            else if(param < 0) { state.money+=500; state.karma-=20; game.log("ç›—ã‚“ã ï¼", "bad"); }
        }
        if(success) this.closeAll();
        this.update();
        game.checkGameOver();
    }
};

window.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowUp') game.move(0, -1);
    if(e.key === 'ArrowDown') game.move(0, 1);
    if(e.key === 'ArrowLeft') game.move(-1, 0);
    if(e.key === 'ArrowRight') game.move(1, 0);
    if(e.key === 'z' || e.key === 'Enter') game.interact();
});

game.init();
</script>
</body>
</html>
