<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ - modoku-w</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* è¿½åŠ ã®ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ */
        .plan-status-box {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid #334155;
        }
        .pro-active {
            border: 1px solid #fbbf24;
            background: linear-gradient(145deg, #1e293b, #2d1b4e);
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 14px;
            margin-top: 10px;
        }
        .badge-free { background: #475569; color: white; }
        .badge-pro { background: #fbbf24; color: #000; box-shadow: 0 0 10px #fbbf24; }
        
        .token-section {
            background: #111827;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .token-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #000;
            border: 1px solid #334155;
            color: #fff;
            box-sizing: border-box;
        }
        .token-btn {
            background: #d946ef;
            color: white;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <h1>My Page</h1>
    </header>

    <div class="container">
        <section>
            <h2 id="welcomeMsg">ã‚ˆã†ã“ãï¼</h2>
            
            <div id="statusCard" class="plan-status-box">
                <div style="color: #94a3b8; font-size: 14px;">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³</div>
                <div id="planBadge" class="badge badge-free">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="expiryLabel" style="margin-top: 10px; font-size: 13px; color: #fbbf24;"></div>
            </div>

            <div class="btn-group">
                <button onclick="location.href='index.html'" class="nav-btn">æ²ç¤ºæ¿ã¸æˆ»ã‚‹</button>
                <button onclick="logout()" class="reload-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </section>

        <section class="token-section">
            <h2 style="font-size: 18px;">ğŸ« ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é©ç”¨ã™ã‚‹</h2>
            <p style="font-size: 12px; color: #aaa;">ç™ºè¡Œã•ã‚ŒãŸProãƒ—ãƒ©ãƒ³ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <input type="text" id="tokenInput" class="token-input" placeholder="PRO-XXXX-XXXX">
            <button onclick="redeemToken()" id="tokenBtn" class="token-btn">é©ç”¨ã—ã¦Proã«ãªã‚‹</button>
        </section>

        <section class="profile-section">
            <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å¤‰æ›´</h2>
            <div class="input-group">
                <input type="text" id="newName" placeholder="æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
                <input type="password" id="newPass" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ã™ã‚‹å ´åˆã®ã¿ï¼‰">
                <button onclick="updateProfile()" id="updateBtn">æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹</button>
            </div>
            <p id="updateMsg"></p>
        </section>
    </div>

    <script>
        // --- URLè¨­å®š ---
        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ›´æ–°ç”¨ï¼‰
        const USER_API_URL = "https://script.google.com/macros/s/AKfycbzzdPk8BxStCsLa0iyhkHeLp3AGnbcvn5FtMrFjRSIvO2aNXQZMdvlsdC44Mrmn6MZ7/exec";
        // 2. ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ï¼ˆãƒ—ãƒ©ãƒ³ç¢ºèªãƒ»ãƒˆãƒ¼ã‚¯ãƒ³é©ç”¨ç”¨ï¼‰
        const TOKEN_API_URL = "https://script.google.com/macros/s/AKfycbzGt1f97bwGpUhfmwKfxrrhryT9g76myvC0x4jwfxGYjJM3b2aGnTjs2aA5QxOOepo/exec";
        
        const userId = localStorage.getItem("userId");
        const userName = localStorage.getItem("userName");

        if (!userId) {
            alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
            location.href = "login.html";
        } else {
            document.getElementById("welcomeMsg").innerText = `ã‚ˆã†ã“ãã€${userName} ã•ã‚“ï¼`;
            document.getElementById("newName").value = userName;
            fetchUserStatus(); // ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’å–å¾—
        }

        // ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’GASã‹ã‚‰å–å¾—ã—ã¦è¡¨ç¤º
        async function fetchUserStatus() {
            try {
                const res = await fetch(`${TOKEN_API_URL}?action=getUserStatus&userId=${userId}`);
                const data = await res.json();
                const card = document.getElementById("statusCard");
                const badge = document.getElementById("planBadge");
                const expiry = document.getElementById("expiryLabel");

                if (data.isPro) {
                    card.classList.add("pro-active");
                    badge.innerText = "PRO PLAN";
                    badge.className = "badge badge-pro";
                    expiry.innerText = "æœ‰åŠ¹æœŸé™: " + data.expireDate;
                } else {
                    card.classList.remove("pro-active");
                    badge.innerText = "FREE PLAN";
                    badge.className = "badge badge-free";
                    expiry.innerText = "æœŸé™ãªã—";
                }
            } catch (e) {
                document.getElementById("planBadge").innerText = "å–å¾—ã‚¨ãƒ©ãƒ¼";
            }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é©ç”¨ã—ã¦ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—
        async function redeemToken() {
            const token = document.getElementById("tokenInput").value;
            const btn = document.getElementById("tokenBtn");
            if (!token) return alert("ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            btn.disabled = true;
            btn.innerText = "æ¤œè¨¼ä¸­...";

            try {
                const res = await fetch(TOKEN_API_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "redeem_token", userId: userId, token: token })
                });
                const result = await res.json();

                if (result.success) {
                    alert(`æˆåŠŸï¼${result.addedDays}æ—¥é–“ProãŒé©ç”¨ã•ã‚Œã¾ã—ãŸã€‚`);
                    location.reload();
                } else {
                    alert("å¤±æ•—: " + result.msg);
                }
            } catch (e) {
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            } finally {
                btn.disabled = false;
                btn.innerText = "é©ç”¨ã—ã¦Proã«ãªã‚‹";
            }
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
        async function updateProfile() {
            const newName = document.getElementById("newName").value;
            const newPass = document.getElementById("newPass").value;
            const btn = document.getElementById("updateBtn");

            if (!newName) return alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ç©ºã«ã§ãã¾ã›ã‚“");

            btn.disabled = true;
            btn.innerText = "æ›´æ–°ä¸­...";

            try {
                const res = await fetch(USER_API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "update",
                        currentId: userId,
                        newName: newName,
                        newPassword: newPass
                    })
                });
                const result = await res.json();
                if (result.success) {
                    localStorage.setItem("userName", result.newName);
                    alert("æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
                    location.reload();
                }
            } catch (e) {
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            } finally {
                btn.disabled = false;
                btn.innerText = "æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹";
            }
        }

        function logout() {
            if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem("userId");
                localStorage.removeItem("userName");
                location.href = "index.html";
            }
        }
    </script>
</body>
</html>
