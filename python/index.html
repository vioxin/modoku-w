<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PyScript Cyber Lab</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        /* --- Cyberpunk UI Styles --- */
        body {
            background-color: #020202;
            color: #0ff;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            background-image: 
                linear-gradient(rgba(0, 20, 20, 0.9), rgba(0, 10, 10, 0.95)),
                repeating-linear-gradient(0deg, transparent, transparent 2px, #0ff 3px, transparent 4px);
            background-size: 100% 100%, 100% 4px;
        }

        h1, h2 { text-transform: uppercase; letter-spacing: 4px; text-shadow: 0 0 10px #0ff; margin: 0; }
        h1 { border-bottom: 2px solid #0ff; padding-bottom: 10px; margin-bottom: 20px; }
        
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .panel {
            background: rgba(0, 20, 20, 0.8);
            border: 1px solid #0ff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            padding: 20px;
            border-radius: 5px;
            position: relative;
        }

        .panel::after {
            content: "SYSTEM_READY";
            position: absolute;
            top: 5px; right: 10px;
            font-size: 10px;
            opacity: 0.7;
        }

        /* Controls */
        .controls { margin-bottom: 15px; border-bottom: 1px dashed #055; padding-bottom: 10px; }
        label { display: block; margin-top: 10px; font-size: 0.9em; color: #8ff; }
        input[type="range"] { width: 100%; accent-color: #0ff; }
        input[type="text"] {
            width: 95%; background: #000; border: 1px solid #0ff; color: #f0f;
            font-family: monospace; padding: 5px; font-size: 1.1em;
        }
        button {
            background: #003333; border: 1px solid #0ff; color: #0ff;
            padding: 8px 16px; cursor: pointer; margin-top: 10px; text-transform: uppercase;
            transition: 0.3s;
        }
        button:hover { background: #0ff; color: #000; box-shadow: 0 0 15px #0ff; }

        /* Output Areas */
        .output-area {
            display: flex; justify-content: center; align-items: center;
            min-height: 400px; background: #000; border: 1px solid #333;
        }

        .loading { color: #f0f; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        @media (max-width: 900px) { .grid-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <h1>>> PY_SCRIPT_CORE // EXECUTION_MODE</h1>

    <div class="grid-container">
        <div class="panel">
            <h2>1. Cyber Wave Surface</h2>
            <div class="controls">
                <label>Wave Speed (Time Lapse): <span id="val-speed">0.2</span></label>
                <input type="range" id="speed" min="0" max="0.5" step="0.01" value="0.2">
                
                <label>Mesh Density (Complexity): <span id="val-mesh">20</span></label>
                <input type="range" id="mesh-size" min="10" max="40" step="5" value="20">
            </div>
            <div id="plot-wave" class="output-area"><div class="loading">INITIALIZING PYTHON RUNTIME...</div></div>
        </div>

        <div class="panel">
            <h2>2. Complex Fractal Engine</h2>
            <div class="controls">
                <label>Complex Function (Python Syntax): <br>Ex: <code>z**2 + c</code> or <code>np.sin(z) * c</code></label>
                <input type="text" id="fractal-eq" value="z**2 + c">
                
                <label>Constant 'c' (Real / Imaginary):</label>
                <div style="display:flex; gap:10px;">
                    <input type="range" id="c-real" min="-2" max="2" step="0.01" value="-0.8">
                    <input type="range" id="c-imag" min="-2" max="2" step="0.01" value="0.156">
                </div>
                <div style="font-size:0.8em; color:#f0f; margin-top:5px;">
                    c = <span id="c-val-display">-0.8 + 0.156j</span>
                </div>
                
                <button id="render-btn" py-click="render_fractal">COMPILE FRACTAL</button>
            </div>
            <div id="plot-fractal" class="output-area"></div>
        </div>
    </div>

    <py-config>
        packages = ["matplotlib", "numpy"]
    </py-config>

    <script type="py">
        import matplotlib.pyplot as plt
        import numpy as np
        import asyncio
        from pyscript import display, document

        # ------------------------------------------------
        # MODULE 1: 3D WAVE ANIMATION LOOP
        # ------------------------------------------------
        plt.style.use('dark_background')
        
        async def wave_loop():
            # Figure setup (Create once, update data)
            fig = plt.figure(figsize=(5, 4))
            fig.patch.set_facecolor('#000000')
            ax = fig.add_subplot(111, projection='3d')
            
            t = 0
            
            while True:
                # 1. Read Inputs
                try:
                    speed = float(document.querySelector("#speed").value)
                    mesh_n = int(document.querySelector("#mesh-size").value)
                    
                    # Update UI Text
                    document.querySelector("#val-speed").innerText = str(speed)
                    document.querySelector("#val-mesh").innerText = str(mesh_n)
                except:
                    speed = 0.1
                    mesh_n = 20

                # 2. Compute Wave
                x = np.linspace(-3, 3, mesh_n)
                y = np.linspace(-3, 3, mesh_n)
                X, Y = np.meshgrid(x, y)
                R = np.sqrt(X**2 + Y**2)
                
                # Dynamic math
                Z = np.sin(R - t) + 0.5 * np.cos(X * 0.5 + t)

                # 3. Render
                ax.clear()
                ax.plot_wireframe(X, Y, Z, rstride=1, cstride=1, color='#00ffff', linewidth=0.6, alpha=0.7)
                
                # Cyber aesthetics
                ax.set_axis_off()
                ax.set_zlim(-2, 2)
                ax.set_title("REALTIME_WAVE_MONITOR", color='#00ffff', fontsize=8)
                
                display(fig, target="plot-wave", append=False)

                t += speed
                await asyncio.sleep(0.05) # Prevent browser freeze

        # Start the wave loop
        asyncio.ensure_future(wave_loop())


        # ------------------------------------------------
        # MODULE 2: INTERACTIVE FRACTAL RENDERER
        # ------------------------------------------------
        def render_fractal(event=None):
            # 1. Get Inputs
            eq_str = document.querySelector("#fractal-eq").value
            c_r = float(document.querySelector("#c-real").value)
            c_i = float(document.querySelector("#c-imag").value)
            
            # Show current C value
            c_disp = f"{c_r} + {c_i}j" if c_i >= 0 else f"{c_r} - {abs(c_i)}j"
            document.querySelector("#c-val-display").innerText = c_disp

            # 2. Python Complex Number Calculation
            # Create a complex grid
            h, w = 200, 200
            y, x = np.ogrid[-1.5:1.5:h*1j, -1.5:1.5:w*1j]
            z = x + y*1j
            c = c_r + c_i*1j

            # Array to store divergence speed
            div_time = np.zeros(z.shape, dtype=int)
            max_iter = 20

            # 3. Dynamic Evaluation (Python Magic)
            # Evaluate user string safely-ish
            try:
                for i in range(max_iter):
                    # Python's 'eval' allows executing mathematical strings
                    # We limit the scope to numpy functions and variables
                    local_scope = {"z": z, "c": c, "np": np}
                    
                    # Execute: z = <user_formula>
                    # Note: We use a mask to only calculate points that haven't diverged
                    mask = np.abs(z) < 10
                    if not np.any(mask): break
                    
                    # Apply formula only to bounded points to avoid overflow
                    z[mask] = eval(eq_str, {"__builtins__": {}}, local_scope)[mask]
                    
                    div_time[mask] += 1
            except Exception as e:
                document.querySelector("#plot-fractal").innerText = f"SYNTAX ERROR: {e}"
                return

            # 4. Render Image
            fig2 = plt.figure(figsize=(5, 4))
            fig2.patch.set_facecolor('#000000')
            ax2 = fig2.add_subplot(111)
            
            # Use 'magma' or 'twilight' for cyber feel
            ax2.imshow(div_time, extent=[-1.5, 1.5, -1.5, 1.5], cmap='twilight_shifted')
            ax2.axis('off')
            ax2.set_title(f"FRACTAL: z = {eq_str}", color='#f0f', fontsize=8)

            display(fig2, target="plot-fractal", append=False)
            plt.close(fig2)

        # Initial render
        render_fractal()
        
        # Bind sliders to re-render for fractal (optional, adds interactivity)
        # Using simple event listener proxy
        from pyodide.ffi import create_proxy
        
        def on_slider_change(event):
            render_fractal()

        slider_proxy = create_proxy(on_slider_change)
        document.querySelector("#c-real").addEventListener("input", slider_proxy)
        document.querySelector("#c-imag").addEventListener("input", slider_proxy)

    </script>
</body>
</html>
