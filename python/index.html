<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyScript Cyber Visualizer</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        /* サイバーパンクなスタイル定義 */
        body {
            background-color: #050505;
            color: #0ff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* 走査線エフェクト（CRTモニター風） */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        h1 {
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
            font-size: 1.5rem;
            margin-bottom: 5px;
            letter-spacing: 3px;
            z-index: 3;
        }

        .status {
            font-size: 0.8rem;
            color: #f0f;
            text-shadow: 0 0 5px #f0f;
            margin-bottom: 20px;
            z-index: 3;
        }

        /* グラフコンテナ */
        #plot-container {
            border: 1px solid #0ff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            background: rgba(0, 20, 20, 0.8);
            padding: 10px;
            border-radius: 4px;
            z-index: 1;
            width: 600px;
            height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ローディングアニメーション */
        .loader {
            border: 4px solid #333;
            border-top: 4px solid #0ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <h1>SYSTEM: PYTHON_CORE_ACTIVE</h1>
    <div class="status" id="status-text">INITIALIZING QUANTUM MESH...</div>

    <div id="plot-container">
        <div id="loading" class="loader"></div>
        <div id="plot-target"></div>
    </div>

    <py-config>
        packages = ["matplotlib", "numpy"]
    </py-config>

    <script type="py">
        import matplotlib.pyplot as plt
        import numpy as np
        import asyncio
        from pyscript import display, document

        # サイバーなMatplotlibスタイル設定
        plt.style.use('dark_background')
        
        # グローバル変数
        running = True
        
        async def main():
            # ローディング要素を削除
            loader = document.querySelector("#loading")
            if loader:
                loader.style.display = "none"
                
            document.querySelector("#status-text").innerText = ">> REALTIME DATA PROCESSING START"

            # グラフの初期設定（パフォーマンスのためにFigureは使い回す）
            fig = plt.figure(figsize=(6, 4.5), dpi=100)
            # 背景色をHTMLと合わせる
            fig.patch.set_facecolor('#050505') 
            ax = fig.add_subplot(111, projection='3d')

            # 計算グリッド（30x30）: 高速化のために解像度を調整
            x = np.linspace(-3, 3, 30)
            y = np.linspace(-3, 3, 30)
            X, Y = np.meshgrid(x, y)
            R = np.sqrt(X**2 + Y**2)

            t = 0
            
            while running:
                # 1. NumPyによる高速計算 (波の方程式)
                # 時間 t を使って波を動かす
                Z = np.sin(R - t) + 0.5 * np.cos(X * 0.5 + t)

                # 2. 描画クリアと再描画
                ax.clear()
                
                # ワイヤーフレーム描画（サイバー感のある色：シアン〜マゼンタ）
                # rstride, cstride で線の間隔を調整
                ax.plot_wireframe(X, Y, Z, rstride=1, cstride=1, 
                                  color='#00ffff', linewidth=0.8, alpha=0.8)

                # 軸の装飾を消して「データ空間」っぽくする
                ax.set_axis_off()
                ax.set_zlim(-2, 2)
                
                # アングルを少しずつ回転させる
                ax.view_init(elev=30, azim=t * 10)

                # 3. 画面への出力
                # display() は target の内容を書き換える
                display(fig, target="plot-target", append=False)

                # 時間を進める
                t += 0.15
                
                # 非同期処理でブラウザのフリーズを防ぐ（重要）
                await asyncio.sleep(0.01)

        # 非同期関数の実行
        asyncio.ensure_future(main())
    </script>
</body>
</html>
