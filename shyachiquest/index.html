<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç¤¾ç•œã‚¯ã‚¨ã‚¹ãƒˆ ã€œãƒ–ãƒ©ãƒƒã‚¯ä¼æ¥­ã‹ã‚‰ã®è„±å‡ºã€œ</title>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
<style>
    :root { --bg-color: #0d0d12; --neon-blue: #00f0ff; --neon-pink: #ff0055; --win-bg: rgba(10, 20, 30, 0.95); --win-border: #ccc; }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background-color: var(--bg-color); color: #e0e0e0; font-family: 'Noto Sans JP', sans-serif; overflow-x: hidden; touch-action: none; user-select: none; -webkit-user-select: none; }
    .pixel-font { font-family: 'DotGothic16', sans-serif; }

    /* --- ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ (LP) é ˜åŸŸ --- */
    #lp-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; background-image: linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px); background-size: 30px 30px; z-index: 200; transition: opacity 0.5s; }
    .hero { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
    .title { font-size: 5rem; font-weight: 900; line-height: 1.1; margin-bottom: 10px; background: linear-gradient(45deg, #fff, var(--neon-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 20px rgba(0,240,255,0.4)); }
    .subtitle { font-size: 2rem; color: #aaa; margin-bottom: 40px; }
    .btn-play { padding: 15px 40px; font-size: 1.5rem; font-weight: 900; color: #000; background: var(--neon-blue); border: none; cursor: pointer; text-transform: uppercase; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%); transition: 0.3s; box-shadow: 0 0 20px rgba(0,240,255,0.4); margin: 10px; }
    .btn-play:hover { background: var(--neon-pink); color: #fff; box-shadow: 0 0 30px rgba(255,0,85,0.6); transform: translateY(-3px); }
    .btn-continue { background: #ffaa00; box-shadow: 0 0 20px rgba(255,170,0,0.4); display: none; }
    .btn-continue:hover { background: #fff; color: #ffaa00; box-shadow: 0 0 30px rgba(255,170,0,0.6); }

    /* --- ã‚²ãƒ¼ãƒ æœ¬ç·¨ é ˜åŸŸ --- */
    #game-wrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; justify-content: center; align-items: center; background: #111; overflow: hidden; }
    canvas { display: block; image-rendering: pixelated; max-width: 100%; max-height: 100%; object-fit: contain; }

    /* ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ»UI */
    .rpg-window { background: var(--win-bg); border: 3px solid var(--win-border); border-radius: 2px; box-shadow: inset 0 0 0 2px #000, 4px 4px 0 rgba(0,0,0,0.5); padding: 10px; z-index: 10; font-family: 'DotGothic16', sans-serif; }
    .btn { background: #333; border: 2px solid #ccc; color: #fff; font-family: 'DotGothic16', sans-serif; font-size: 16px; padding: 8px 12px; cursor: pointer; transition: 0.1s; }
    .btn:active { background: #fff; color: #000; }
    .btn:disabled { border-color: #555; color: #555; background: #111; pointer-events: none; }

    /* ã‚­ãƒ£ãƒªã‚¢é¸æŠ */
    #job-select { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 150; font-family: 'DotGothic16', sans-serif;}
    .job-cards { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
    .job-card { width: 160px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; padding: 15px; }
    .job-card:hover { border-color: var(--neon-blue); background: rgba(0,50,100,0.8); }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; font-family: 'DotGothic16', sans-serif;}
    .status-bar { position: absolute; top: 10px; left: 10px; display: flex; flex-wrap: wrap; gap: 10px; font-size: 16px; width: calc(100% - 100px); text-shadow: 1px 1px 0 #000; }
    .status-bar span { background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 3px; border: 1px solid #555; }
    .menu-btn { position: absolute; top: 10px; right: 10px; pointer-events: auto; }

    .msg-box { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; min-height: 80px; font-size: 18px; line-height: 1.5; display: none; white-space: pre-wrap; pointer-events: auto; }
    .choices { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; margin-top: 15px; }

    /* ãƒãƒˆãƒ«ç”»é¢ */
    #battle-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; pointer-events: auto; z-index: 50; font-family: 'DotGothic16', sans-serif;}
    #enemy-sprite { transform: scale(5); margin-bottom: 40px; image-rendering: pixelated; }
    #enemy-name { font-size: 24px; color: #ff5555; margin-bottom: 20px; border-bottom: 2px solid #555; padding-bottom: 5px; }
    #battle-msg { width: 90%; max-width: 500px; height: 100px; margin-bottom: 20px; font-size: 18px; text-align: center; }
    .battle-commands { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; max-width: 90%; }

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ */
    #controls-layer { position: absolute; bottom: 20px; left: 20px; right: 20px; height: 140px; pointer-events: auto; display: none; justify-content: space-between; align-items: flex-end; z-index: 20; max-width: 800px; margin: 0 auto; }
    #joystick-zone { position: relative; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); touch-action: none; }
    #joystick-knob { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255,255,255,0.8); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
    .action-btn { width: 80px; height: 80px; background: rgba(100,150,255,0.6); border: 3px solid rgba(150,200,255,0.8); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; font-weight: bold; cursor: pointer; }
    .action-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.8); }

    #fade-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; opacity: 0; pointer-events: none; transition: opacity 0.5s; z-index: 100; }
    
    @media (max-width: 768px) { .title { font-size: 3rem; } .status-bar { font-size: 12px; gap: 5px; } .btn { font-size: 14px; padding: 6px 10px; } }
</style>
</head>
<body>

<div id="lp-screen">
    <section class="hero">
        <h1 class="title pixel-font">ç¤¾ç•œã‚¯ã‚¨ã‚¹ãƒˆ</h1>
        <h2 class="subtitle pixel-font">ã€œãƒ–ãƒ©ãƒƒã‚¯ä¼æ¥­ã‹ã‚‰ã®è„±å‡ºã€œ</h2>
        <div>
            <button class="btn-play pixel-font" onclick="showJobSelect()">New Game</button>
            <button id="btn-load" class="btn-play btn-continue pixel-font" onclick="loadGame()">Continue</button>
        </div>
        <p style="margin-top: 30px; font-size: 0.9rem; color: #888;">æ­©è¡Œï¼šç”»é¢å·¦ä¸‹ã‚’ã‚¹ãƒ¯ã‚¤ãƒ— / PCæ“ä½œãƒ»èª¿ã¹ã‚‹ï¼šå³ä¸‹ãƒœã‚¿ãƒ³</p>
    </section>
</div>

<div id="game-wrapper">
    <div id="job-select">
        <h2 style="color:var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue);">ã‚­ãƒ£ãƒªã‚¢ï¼ˆè·æ¥­ï¼‰ã‚’é¸æŠ</h2>
        <div class="job-cards">
            <div class="rpg-window job-card" onclick="startGame('shinsotsu')">
                <h3 style="color:#5cf; margin:0;">æ–°å…¥ç¤¾å“¡</h3>
                <span style="font-size:12px; text-align:center;">ä½“åŠ›ãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«æ¨™æº–<br>ã‚¹ã‚­ãƒ«: æ„›æƒ³ç¬‘ã„</span>
            </div>
            <div class="rpg-window job-card" onclick="startGame('veteran')">
                <h3 style="color:#f55; margin:0;">ãƒ™ãƒ†ãƒ©ãƒ³ç¤¾ç•œ</h3>
                <span style="font-size:12px; text-align:center;">é«˜ä½“åŠ›/ä½ãƒ¡ãƒ³ã‚¿ãƒ«<br>ã‚¹ã‚­ãƒ«: è²¬ä»»è»¢å«</span>
            </div>
            <div class="rpg-window job-card" onclick="startGame('freelance')">
                <h3 style="color:#5f5; margin:0;">ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹</h3>
                <span style="font-size:12px; text-align:center;">é«˜æ”»æ’ƒåŠ›/ç´™é˜²å¾¡<br>ã‚¹ã‚­ãƒ«: å¾¹å¤œä½œæ¥­</span>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div id="ui-layer">
        <div class="status-bar">
            <span>ğŸ’» Lv <span id="ui-lv">1</span></span>
            <span style="color:#f88;">â¤ HP <span id="ui-hp">20</span></span>
            <span style="color:#8df;">ğŸ’§ MP <span id="ui-mp">10</span></span>
            <span style="color:#fe3;">Â¥ <span id="ui-gold">0</span></span>
        </div>
        <button class="rpg-window menu-btn btn" onclick="toggleStatus()">è©³ç´°/è¨­å®š</button>

        <div id="msg-box" class="rpg-window msg-box">
            <div id="msg-text"></div>
            <div id="msg-choices" class="choices"></div>
        </div>

        <div id="status-modal" class="rpg-window" style="position:absolute; top:10%; left:50%; transform:translateX(-50%); width:280px; display:none; flex-direction:column; gap:8px; pointer-events:auto;">
            <h2 style="margin:0; text-align:center; color:#fff; border-bottom: 1px solid #555; padding-bottom:5px;" id="st-jobname">å±¥æ­´æ›¸</h2>
            <div style="display:flex; justify-content:space-between;"><span>æ¥­å‹™ã‚¹ã‚­ãƒ«(Lv)</span><span id="st-lv">1</span></div>
            <div style="display:flex; justify-content:space-between;"><span>ä½“åŠ›(HP)</span><span id="st-hp">20/20</span></div>
            <div style="display:flex; justify-content:space-between;"><span>ï¾’ï¾ï¾€ï¾™(MP)</span><span id="st-mp">10/10</span></div>
            <div style="display:flex; justify-content:space-between;"><span>å‡¦ç†èƒ½åŠ›(ATK)</span><span id="st-atk">5</span></div>
            <div style="display:flex; justify-content:space-between;"><span>ã‚¹ãƒ«ãƒ¼ã‚¹ã‚­ãƒ«(DEF)</span><span id="st-def">2</span></div>
            <div style="display:flex; justify-content:space-between;"><span>è©•ä¾¡(EXP)</span><span id="st-exp">0 / 10</span></div>
            <div style="color:#aef; font-size:14px; border-top:1px dashed #555; padding-top:5px;">æ ªä¾¡: <span id="st-stock-price">1000</span>å†† / ä¿æœ‰: <span id="st-shares">0</span>æ ª</div>
            <div style="color:#ccc; font-size:14px; border-bottom:1px solid #555; padding-bottom:5px;">è£…å‚™: <span id="st-wpn" style="color:#fe3;">å®‰ç‰©ã®ã‚¹ãƒ¼ãƒ„</span></div>
            <div style="display:flex; gap: 10px; margin-top:5px;">
                <button class="btn" style="flex:1; background:#148;" onclick="saveGame()">ï½¾ï½°ï¾Œï¾</button>
                <button class="btn" style="flex:1;" onclick="toggleStatus()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="battle-screen">
        <h2 id="enemy-name">ç´æœŸ</h2>
        <canvas id="enemy-sprite" width="48" height="48"></canvas>
        <div id="battle-msg" class="rpg-window"></div>
        <div class="battle-commands" id="battle-cmds"></div>
    </div>

    <div id="controls-layer">
        <div id="joystick-zone"><div id="joystick-knob"></div></div>
        <div class="action-btn" onpointerdown="input.setAction()" onpointerup="input.stopAction()">A</div>
    </div>
    <div id="fade-layer"></div>
</div>

<script>
/* --- ã‚¨ãƒ³ã‚¸ãƒ³ãƒ»ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯è¨­å®š --- */
const CFG = { TILE_SIZE: 48, SCREEN_W: 800, SCREEN_H: 600, SPEED: 5, ENCOUNTER_RATE: 0.02 };
const T = { ROAD: {id:0,walk:true}, WALL: {id:1,walk:false}, FLOOR: {id:2,walk:true}, BED: {id:10,walk:false}, PC: {id:11,walk:false}, CONBINI: {id:20,walk:false}, DOOR: {id:21,walk:true}, CASINO: {id:22,walk:false}, DESK: {id:30,walk:false}, BOSS_DESK: {id:31,walk:false}, NPC_COWORKER: {id:40,walk:false} };
const JOBS = {
    shinsotsu: { name: 'æ–°å…¥ç¤¾å“¡', hp: 30, mp: 30, atk: 5, def: 3, skills: [{id:'work', name:'æ¥­å‹™ã“ãªã™', mp:0}, {id:'smile', name:'æ„›æƒ³ç¬‘ã„(MP2)', mp:2}] },
    veteran:   { name: 'ãƒ™ãƒ†ãƒ©ãƒ³', hp: 60, mp: 10, atk: 7, def: 5, skills: [{id:'work', name:'æ¥­å‹™ã“ãªã™', mp:0}, {id:'blame', name:'è²¬ä»»è»¢å«(MP3)', mp:3}] },
    freelance: { name: 'ï¾Œï¾˜ï½°ï¾—ï¾ï½½', hp: 20, mp: 40, atk: 10, def: 1, skills: [{id:'work', name:'ç´å“ã™ã‚‹', mp:0}, {id:'allnight', name:'å¾¹å¤œ(MP5/è‡ªå‚·)', mp:5}] }
};

const Sprites = {};
function createPixelSprite(key, w, h, pal, data) {
    const c = document.createElement('canvas'); c.width = w * 4; c.height = h * 4; const ctx = c.getContext('2d');
    for(let y=0; y<h; y++) for(let x=0; x<w; x++) if(data[y][x]!=='0') { ctx.fillStyle = pal[parseInt(data[y][x], 16)]; ctx.fillRect(x*4, y*4, 4, 4); }
    Sprites[key] = c;
}
function initGraphics() {
    const pal = [null,'#111','#fca','#333','#888','#248','#fff','#d33','#642','#4a4','#fd3','#5cf','#f8a','#b3f'];
    createPixelSprite('player', 12,12,pal, ["000000000000","000011110000","000111111000","000122221000","000212212000","000161161000","000117711000","001111111100","001111111100","000333333000","000330033000","001110011100"]);
    createPixelSprite('npc', 12,12,pal, ["000000000000","000088880000","000888888000","000822228000","000212212000","000464464000","00044B444000","004444444400","004444444400","000111111000","000110011000","008880088800"]);
    createPixelSprite('boss', 12,12,pal, ["000000000000","000100001000","000110011000","000122221000","000212212000","001116611100","001117711100","011111111110","011111111110","000333333000","000330033000","001110011100"]);
    createPixelSprite('floor', 12,12,pal, ["444444444444","464646464646","444444444444","646464646464","444444444444","464646464646","444444444444","646464646464","444444444444","464646464646","444444444444","646464646464"]);
    createPixelSprite('road', 12,12,pal, ["333333333333","333333333333","333333333333","333333333333","333333333333","666666666666","333333333333","333333333333","333333333333","333333333333","333333333333","333333333333"]);
    createPixelSprite('wall', 12,12,pal, ["444444444444","411141111114","411141111114","444444444444","411111141114","411111141114","444444444444","411141111114","411141111114","444444444444","444444444444","444444444444"]);
    createPixelSprite('bed', 12,12,pal, ["000000000000","000000000000","000000000000","066666666660","06B666666B60","06BBBBBBBB60","06BBBBBBBB60","06BBBBBBBB60","066666666660","080000000080","080000000080","000000000000"]);
    createPixelSprite('desk', 12,12,pal, ["000000000000","000000000000","000000000000","044444444440","041144411440","041144411440","044444444440","088888888880","088000000880","088000000880","088000000880","000000000000"]);
    createPixelSprite('conbini', 12,12,pal, ["000000000000","055555555550","099999999990","077777777770","066666666660","06B6B6B6B660","066666666660","06C66666A660","066666666660","06B6B6B6B660","066666666660","000000000000"]);
    createPixelSprite('casino', 12,12,pal, ["000000000000","077777777770","07C777777C70","077777777770","011111111110","01D111111D10","011144441110","011141141110","011144441110","088888888880","088888888880","000000000000"]);
    createPixelSprite('deadline', 12,12,pal, ["000000000000","000011110000","000166661000","001661666100","001661666100","001661166100","001666666100","000166661000","000011110000","000000000000","000000000000","000000000000"]);
    createPixelSprite('doc', 12,12,pal, ["000000000000","000666660000","000611160000","000666660000","000611160000","000666660000","000611160000","000666660000","000000000000","000000000000","000000000000","000000000000"]);
}

// --- ã‚¹ãƒ†ãƒ¼ãƒˆãƒ»ãƒãƒƒãƒ—ç®¡ç† ---
let state = {
    mapId: 'home', job: null, wpnName: 'å®‰ç‰©ã®ã‚¹ãƒ¼ãƒ„', marketPrice: 1000,
    p: { x:4*48, y:4*48, dir:2, moving:false, anim:0, lv:1, hp:0, maxHp:0, mp:0, maxMp:0, atk:0, def:0, gold:0, shares:0, exp:0, nextExp:15, stepsOutside: 0, walkDist: 0 },
    cam: { x:0, y:0 }, msgActive: false, battleActive: false
};
const maps = { home: {w:8,h:8,data:[]}, city: {w:20,h:15,data:[]}, office: {w:15,h:20,data:[]} };

function generateMaps() {
    for(let y=0; y<8; y++) { let row=[]; for(let x=0; x<8; x++) { if(x===0||x===7||y===0||y===7) row.push(T.WALL.id); else row.push(T.FLOOR.id); } maps.home.data.push(row); }
    maps.home.data[7][3] = maps.home.data[7][4] = T.DOOR.id; maps.home.data[2][2] = T.BED.id; maps.home.data[2][5] = T.PC.id;
    for(let y=0; y<15; y++) { let row=[]; for(let x=0; x<20; x++) { if(y<3||y>11||x<2||x>17) row.push(T.WALL.id); else row.push(T.ROAD.id); } maps.city.data.push(row); }
    maps.city.data[3][10] = T.DOOR.id; maps.city.data[6][5] = T.CONBINI.id; maps.city.data[11][15] = T.DOOR.id;
    maps.city.data[3][16] = T.CASINO.id; 
    
    for(let y=0; y<20; y++) { let row=[]; for(let x=0; x<15; x++) { if(x===0||x===14||y===0||y===19) row.push(T.WALL.id); else row.push(T.FLOOR.id); } maps.office.data.push(row); }
    maps.office.data[19][7] = T.DOOR.id; maps.office.data[8][5] = T.NPC_COWORKER.id; maps.office.data[2][7] = T.BOSS_DESK.id;
    for(let y=5; y<15; y+=3) { for(let x=3; x<12; x+=4) { maps.office.data[y][x] = T.DESK.id; maps.office.data[y][x+1] = T.DESK.id; } }
}

// --- ã‚·ã‚¹ãƒ†ãƒ  (ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰ãƒ»LPé·ç§») ---
window.addEventListener('DOMContentLoaded', () => {
    initGraphics(); generateMaps();
    if(localStorage.getItem('shachiku_save')) document.getElementById('btn-load').style.display = 'inline-block';
});

function showJobSelect() { document.getElementById('lp-screen').style.opacity = 0; setTimeout(() => { document.getElementById('lp-screen').style.display = 'none'; document.getElementById('game-wrapper').style.display = 'flex'; document.getElementById('job-select').style.display = 'flex'; }, 500); }

function startGame(jobId) {
    state.job = JOBS[jobId]; Object.assign(state.p, state.job); state.p.maxHp = state.p.hp; state.p.maxMp = state.p.mp;
    state.p.stepsOutside = 0; state.p.walkDist = 0; 
    setupGameUI();
    showMsg(`ã€${state.job.name}ã€‘ã¨ã—ã¦ç¤¾ä¼šã«å‡ºãŸï¼\nã¾ãšã¯å‡ºç¤¾ã—ã¦ç¨¼ãã‹ã€\nPCã§ã€Œå‰¯æ¥­ã€ã‚„ã€Œæ ªã€ã«æ‰‹ã‚’å‡ºãã†ï¼`);
}

function saveGame() {
    const saveData = { p: state.p, job: state.job, marketPrice: state.marketPrice, wpnName: state.wpnName, mapId: state.mapId };
    localStorage.setItem('shachiku_save', JSON.stringify(saveData));
    showMsg("é€²è¡ŒçŠ¶æ³ã‚’ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸã€‚\nï¼ˆâ€»ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰");
    updateUI();
}

function loadGame() {
    const data = JSON.parse(localStorage.getItem('shachiku_save'));
    if(!data) return;
    state.p = data.p; state.job = data.job; state.marketPrice = data.marketPrice; state.wpnName = data.wpnName; state.mapId = data.mapId;
    state.p.stepsOutside = state.p.stepsOutside || 0; state.p.walkDist = state.p.walkDist || 0; 
    
    document.getElementById('lp-screen').style.opacity = 0;
    setTimeout(() => { document.getElementById('lp-screen').style.display = 'none'; document.getElementById('game-wrapper').style.display = 'flex'; setupGameUI(); showMsg("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚\nåŠ´åƒã‚’å†é–‹ã—ã¾ã™ã€‚"); }, 500);
}

function setupGameUI() {
    document.getElementById('job-select').style.display = 'none'; document.getElementById('ui-layer').style.display = 'block'; document.getElementById('controls-layer').style.display = 'flex';
    document.getElementById('st-jobname').innerText = state.job.name;
    const cmdBox = document.getElementById('battle-cmds'); cmdBox.innerHTML = '';
    state.job.skills.forEach(sk => { let btn = document.createElement('button'); btn.className = 'btn'; btn.innerText = sk.name; btn.onclick = () => battleAction(sk); cmdBox.appendChild(btn); });
    let runBtn = document.createElement('button'); runBtn.className = 'btn'; runBtn.innerText = 'ãƒˆã‚¤ãƒ¬ã«é€ƒã’ã‚‹'; runBtn.onclick = () => battleAction({id:'run'}); cmdBox.appendChild(runBtn);
    updateUI(); loop();
}

// --- å…¥åŠ›ãƒ»UI ---
const input = {
    dir: -1, action: false,
    setDir: function(d) { if(!state.msgActive && !state.battleActive) this.dir = d; }, stopDir: function() { this.dir = -1; },
    setAction: function() { if(state.battleActive) return; if(state.msgActive) { closeMsg(); return; } this.action = true; }, stopAction: function() { this.action = false; }
};
const joy = {
    z: document.getElementById('joystick-zone'), k: document.getElementById('joystick-knob'), act: false, ox: 0, oy: 0,
    init: function() {
        this.z.addEventListener('pointerdown', e => { this.act = true; this.ox = e.clientX; this.oy = e.clientY; this.k.style.transition = 'none'; this.z.setPointerCapture(e.pointerId); });
        this.z.addEventListener('pointermove', e => {
            if(!this.act) return; const dx = e.clientX - this.ox, dy = e.clientY - this.oy; const dist = Math.sqrt(dx*dx + dy*dy);
            const mx = dist > 35 ? (dx/dist)*35 : dx, my = dist > 35 ? (dy/dist)*35 : dy; this.k.style.transform = `translate(calc(-50% + ${mx}px), calc(-50% + ${my}px))`;
            if(dist > 15) { const a = Math.atan2(dy, dx) * 180 / Math.PI; if(a >= -45 && a < 45) input.setDir(1); else if(a >= 45 && a < 135) input.setDir(2); else if(a >= -135 && a < -45) input.setDir(0); else input.setDir(3); } else input.stopDir();
        });
        const stop = () => { this.act = false; this.k.style.transition = '0.2s'; this.k.style.transform = 'translate(-50%, -50%)'; input.stopDir(); };
        this.z.addEventListener('pointerup', stop); this.z.addEventListener('pointercancel', stop);
    }
}; joy.init();

window.addEventListener('keydown', e => { if(['ArrowUp','w'].includes(e.key)) input.setDir(0); if(['ArrowDown','s'].includes(e.key)) input.setDir(2); if(['ArrowLeft','a'].includes(e.key)) input.setDir(3); if(['ArrowRight','d'].includes(e.key)) input.setDir(1); if(e.key==='z' || e.key==='Enter') input.setAction(); });
window.addEventListener('keyup', e => { if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d'].includes(e.key)) input.stopDir(); if(e.key==='z' || e.key==='Enter') input.stopAction(); });

function updateUI() { document.getElementById('ui-lv').innerText = state.p.lv; document.getElementById('ui-hp').innerText = state.p.hp; document.getElementById('ui-mp').innerText = state.p.mp; document.getElementById('ui-gold').innerText = state.p.gold; }

function toggleStatus() {
    const m = document.getElementById('status-modal');
    if (m.style.display === 'flex') m.style.display = 'none';
    else { document.getElementById('st-lv').innerText = state.p.lv; document.getElementById('st-hp').innerText = state.p.hp + '/' + state.p.maxHp; document.getElementById('st-mp').innerText = state.p.mp + '/' + state.p.maxMp; document.getElementById('st-atk').innerText = state.p.atk; document.getElementById('st-def').innerText = state.p.def; document.getElementById('st-exp').innerText = state.p.exp + ' / ' + state.p.nextExp; document.getElementById('st-stock-price').innerText = state.marketPrice; document.getElementById('st-shares').innerText = state.p.shares; document.getElementById('st-wpn').innerText = state.wpnName; m.style.display = 'flex'; }
}

let msgCallback = null;
function showMsg(text, choices = null) {
    document.getElementById('msg-text').innerText = text; const cbox = document.getElementById('msg-choices'); cbox.innerHTML = '';
    if(choices) { 
        choices.forEach(c => { 
            let btn = document.createElement('button'); btn.className = 'btn'; btn.innerText = c.text; 
            btn.onclick = (e) => { 
                e.stopPropagation(); 
                document.getElementById('msg-box').style.display = 'none'; 
                state.msgActive = false; input.action = false;
                cbox.innerHTML = ''; 
                c.cb(); 
            }; 
            cbox.appendChild(btn); 
        }); 
    } else msgCallback = null;
    document.getElementById('msg-box').style.display = 'block'; state.msgActive = true; input.stopDir();
}
function closeMsg() { 
    if(!state.msgActive || document.getElementById('msg-choices').innerHTML !== '') return; 
    document.getElementById('msg-box').style.display = 'none'; state.msgActive = false; input.action = false; 
    if(msgCallback) { let cb = msgCallback; msgCallback = null; cb(); } 
}

// --- PCãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ãƒãƒƒãƒˆé€šè²© ---
function openPCMenu() {
    showMsg("PCã‚’ç«‹ã¡ä¸Šã’ãŸã€‚ä½•ã‚’ã™ã‚‹ï¼Ÿ", [
        { text: "å‰¯æ¥­ã‚µã‚¤ãƒˆ", cb: () => openSideJobMenu() },
        { text: "æ ªå–å¼•ã‚¢ãƒ—ãƒª", cb: () => openStockMenu() },
        { text: "é—‡ã®é€šè²©AmaZON", cb: () => openOnlineShop() },
        { text: "ã‚„ã‚ã‚‹", cb: () => {} }
    ]);
}
function openSideJobMenu() {
    showMsg(`ã€å‰¯æ¥­ãƒãƒƒãƒãƒ³ã‚°ã€‘ç¾åœ¨HP:${state.p.hp} MP:${state.p.mp}`, [
        { text: "è¨˜äº‹åŸ·ç­†(HP/MP-5)", cb: () => doSideJob('writer') },
        { text: "å‹•ç”»ç·¨é›†(HP/MP-15)", cb: () => doSideJob('video') },
        { text: "æˆ»ã‚‹", cb: () => openPCMenu() }
    ]);
}
function doSideJob(type) {
    let cost = type === 'writer' ? 5 : 15, reward = type === 'writer' ? 300 + Math.floor(Math.random()*500) : 1000 + Math.floor(Math.random()*1500);
    if(state.p.hp <= cost || state.p.mp <= cost) { showMsg("ä½“åŠ›ãŒãƒ¡ãƒ³ã‚¿ãƒ«ãŒé™ç•Œã â€¦â€¦ã€‚\nã“ã‚Œä»¥ä¸Šç„¡ç†ã™ã‚‹ã¨å€’ã‚Œã¦ã—ã¾ã†ã€‚"); return; }
    state.p.hp -= cost; state.p.mp -= cost; state.p.gold += reward; updateUI(); showMsg(`å‰¯æ¥­ã‚’ã“ãªã—ã€${reward}å†† ã‚’å¾—ãŸãŒã€\nå¿ƒèº«ã«ç–²åŠ´ãŒè“„ç©ã—ãŸâ€¦â€¦ã€‚`);
}
function openStockMenu() {
    showMsg(`ã€ã‚ªãƒ¯ãƒªãƒ»ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã€\nç¾åœ¨æ ªä¾¡: ${state.marketPrice}å†† / ä¿æœ‰: ${state.p.shares}æ ª\nâ€»å£²å´æ™‚ã€ç¨é‡‘20%ãŒå¼•ã‹ã‚Œã¾ã™`, [
        { text: "1æ ªè²·ã†", cb: () => { if(state.p.gold >= state.marketPrice) { state.p.gold -= state.marketPrice; state.p.shares++; updateUI(); openStockMenu(); } else showMsg("è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚"); } },
        { text: "å…¨éƒ¨å£²ã‚‹", cb: () => { 
            if(state.p.shares > 0) { 
                let gross = state.marketPrice * state.p.shares; 
                let tax = Math.floor(gross * 0.2); 
                let rev = gross - tax;
                state.p.gold += rev; 
                let amt = state.p.shares; state.p.shares = 0; updateUI(); 
                showMsg(`${amt}æ ªã‚’å£²å´ã—ãŸï¼\nã—ã‹ã—ç¨é‡‘ã¨ã—ã¦ ${tax}å†† å¼•ã‹ã‚Œã€\næ‰‹å–ã‚Šã¯ ${rev}å†† ã«ãªã£ãŸâ€¦â€¦ã€‚`); 
            } else showMsg("å£²ã‚‹æ ªã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚"); 
        } },
        { text: "æˆ»ã‚‹", cb: () => openPCMenu() }
    ]);
}
function openOnlineShop() {
    showMsg(`ã€é—‡ã®ç¤¾ç•œé€šè²© AmaZONã€‘\næ®‹é«˜: ${state.p.gold}å††`, [
        { text: "ï¾’ï½¶ï¾†ï½¶ï¾™ï½·ï½°ï¾ï¾ï½°ï¾„ï¾(Â¥5ä¸‡/ATK+10)", cb: () => { if(state.p.gold>=50000){ state.p.gold-=50000; state.p.atk+=10; state.wpnName="ãƒ¡ã‚«ãƒ‹ã‚«ãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰"; updateUI(); showMsg("æ‰“éµéŸ³ã§å‘¨ã‚Šã‚’å¨åš‡ã—ã€é€²æ—ã‚’çˆ†ä¸Šã’ã™ã‚‹ï¼\n(æ”»æ’ƒåŠ›+10)"); } else showMsg("æ®‹é«˜ä¸è¶³ã§ã™ã€‚"); } },
        { text: "é«˜ç´šã‚¹ãƒ¼ãƒ„(Â¥10ä¸‡/DEF+10)", cb: () => { if(state.p.gold>=100000){ state.p.gold-=100000; state.p.def+=10; state.wpnName="é«˜ç´šã‚ªãƒ¼ãƒ€ãƒ¼ã‚¹ãƒ¼ãƒ„"; updateUI(); showMsg("ä¸Šå¸ã®å«Œå‘³ã‚’ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ã«å¼¾ãï¼\n(é˜²å¾¡åŠ›+10)"); } else showMsg("æ®‹é«˜ä¸è¶³ã§ã™ã€‚"); } },
        { text: "ã‚¿ãƒ¯ãƒãƒ³æœ€ä¸Šéš(Â¥1000ä¸‡/çœŸã‚¯ãƒªã‚¢)", cb: () => { if(state.p.gold>=10000000){ state.p.gold-=10000000; state.p.maxHp+=999; state.p.maxMp+=999; state.p.hp=state.p.maxHp; state.p.mp=state.p.maxMp; state.wpnName="ã‚¿ãƒ¯ãƒãƒ³ã®æ¨©åˆ©æ›¸"; updateUI(); showMsg("ã€çœŸã®è‡ªç”±ã¸ã€‘\nåœ§å€’çš„ãªè³‡æœ¬ã‚’æ‰‹ã«å…¥ã‚Œã€\nç‰©ç†çš„ã«ã‚‚ç¤¾ä¼šçš„ã«ã‚‚ä¸Šã®éšå±¤ã¸åˆ°é”ã—ãŸã€‚\nã‚‚ã†èª°ã‚‚ã‚ãªãŸã«é€†ã‚‰ãˆãªã„ã€‚\n\nã€œ GAME CLEAR ã€œ"); } else showMsg("å…¨ç„¶è¶³ã‚Šã¾ã›ã‚“ã€‚\nç¾å®Ÿã«å¸°ã£ã¦åŠ´åƒã—ã¦ãã ã•ã„ã€‚"); } },
        { text: "æˆ»ã‚‹", cb: () => openPCMenu() }
    ]);
}

// --- ã‚«ã‚¸ãƒ ---
function openCasinoMenu() {
    showMsg(`ã€åœ°ä¸‹ã‚«ã‚¸ãƒãƒ»æ¬²æœ›ã®æ²¼ã€‘\næ‰€æŒé‡‘: ${state.p.gold}å††\nã€Œä¸ï¼ˆå¶æ•°ï¼‰ã€ã‹ã€ŒåŠï¼ˆå¥‡æ•°ï¼‰ã€ã‹â€¦â€¦`, [
        { text: "1ä¸‡è³­ã‘ã‚‹", cb: () => playGamble(10000) },
        { text: "10ä¸‡è³­ã‘ã‚‹", cb: () => playGamble(100000) },
        { text: "å…¨é¡è³­ã‘ã‚‹", cb: () => playGamble(state.p.gold) },
        { text: "ç«‹ã¡å»ã‚‹", cb: () => {} }
    ]);
}
function playGamble(bet) {
    if(bet <= 0 || state.p.gold < bet) { showMsg("é‡‘ãŒè¶³ã‚Šã­ãˆãªã€‚ã™ã£ã“ã‚“ã§ã‚ã€‚"); return; }
    state.p.gold -= bet; updateUI();
    showMsg(`è³­ã‘é‡‘ ${bet}å†† ã‚’å¼µã£ãŸï¼\nã‚µã‚¤ã‚³ãƒ­ãŒæŒ¯ã‚‰ã‚Œã‚‹â€¦â€¦`, null);
    
    setTimeout(() => {
        let dice = Math.floor(Math.random() * 6) + 1 + Math.floor(Math.random() * 6) + 1;
        let isWin = Math.random() < 0.45; 
        
        document.getElementById('msg-box').style.display = 'none'; state.msgActive = false; 
        if(isWin) {
            let winAmt = bet * 2;
            state.p.gold += winAmt; updateUI();
            showMsg(`å‡ºç›®ã¯ ${dice} ï¼\nè¦‹äº‹çš„ä¸­ã—ã€${winAmt}å†† ã«å€å¢—ã—ãŸï¼\nè„³æ±ãŒæ­¢ã¾ã‚‰ãªã„ï¼`, [{ text: 'ã‚‚ã†ä¸€å‹è² ', cb: () => openCasinoMenu() }, { text: 'ã‚„ã‚ã‚‹', cb: () => {} }]);
        } else {
            updateUI();
            showMsg(`å‡ºç›®ã¯ ${dice} â€¦â€¦ã€‚\nè³­ã‘é‡‘ã¯é—‡ã«æ¶ˆãˆãŸã€‚\nã€Œãƒ’ãƒ’ãƒ’ã€ã¾ãŸæ¥ãªã€`, [{ text: 'ã‚‚ã†ä¸€å‹è² ', cb: () => openCasinoMenu() }, { text: 'ã‚„ã‚ã‚‹', cb: () => {} }]);
        }
    }, 2000);
}

function fadeTransition(cb) { const fade = document.getElementById('fade-layer'); fade.style.opacity = 1; setTimeout(() => { cb(); updateUI(); fade.style.opacity = 0; }, 500); }

// --- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ ---
function checkEvents() {
    const map = maps[state.mapId], tx = Math.floor((state.p.x + 24) / CFG.TILE_SIZE), ty = Math.floor((state.p.y + 36) / CFG.TILE_SIZE);
    if(map.data[ty] !== undefined) {
        const id = map.data[ty][tx];
        if(id === T.DOOR.id) {
            if(state.mapId === 'home') fadeTransition(() => { state.mapId = 'city'; state.p.x = 10*48; state.p.y = 4*48; });
            else if(state.mapId === 'city' && ty < 5) fadeTransition(() => { state.mapId = 'home'; state.p.x = 4*48; state.p.y = 6*48; });
            else if(state.mapId === 'city' && ty > 10) fadeTransition(() => { state.mapId = 'office'; state.p.x = 7*48; state.p.y = 18*48; });
            else if(state.mapId === 'office') fadeTransition(() => { state.mapId = 'city'; state.p.x = 15*48; state.p.y = 10*48; });
        }
    }
}

function interact() {
    const p = state.p; let tx = Math.floor((p.x + 24) / CFG.TILE_SIZE), ty = Math.floor((p.y + 24) / CFG.TILE_SIZE);
    if(p.dir===0) ty--; else if(p.dir===2) ty++; else if(p.dir===3) tx--; else if(p.dir===1) tx++;
    const map = maps[state.mapId]; if(ty<0||ty>=map.h||tx<0||tx>=map.w) return;
    const id = map.data[ty][tx];
    
    if(id === T.BED.id) { showMsg("æ³¥ã®ã‚ˆã†ã«çœ ã‚Šã¾ã™ã‹ï¼Ÿ", [{ text: 'å¯ã‚‹', cb: () => { p.hp = p.maxHp; p.mp = p.maxMp; updateUI(); showMsg("å…¨å›å¾©ã—ãŸã€‚æ˜æ—¥ã‚‚åŠ´åƒã ã€‚"); } }, { text: 'ã‚„ã‚ã‚‹', cb: () => {} }]); }
    else if(id === T.PC.id) { openPCMenu(); }
    else if(id === T.CASINO.id) { openCasinoMenu(); }
    else if(id === T.CONBINI.id) {
        showMsg("ã€ä¸å¤œåŸãƒãƒ¼ãƒˆã€", [
            { text: 'ï½´ï¾…ï¾„ï¾ï¾˜(Â¥500/HPå›å¾©)', cb: () => { if(p.gold>=500) { p.gold-=500; p.hp=Math.min(p.maxHp, p.hp+20); updateUI(); showMsg("ä½“åŠ›ãŒ20å›å¾©ã—ãŸï¼\nå°†æ¥ã®å¯¿å‘½ã‚’å‰å€Ÿã‚Šã—ãŸã€‚"); } else showMsg("æ®‹é«˜ä¸è¶³ã§ã™ã€‚"); } },
            { text: 'ï½½ï¾„ï¾›ï¾ï½¸ï¾ç¼¶(Â¥200/MPå›å¾©)', cb: () => { if(p.gold>=200) { p.gold-=200; p.mp=Math.min(p.maxMp, p.mp+20); p.hp=Math.max(1, p.hp-5); updateUI(); showMsg("ãƒ¡ãƒ³ã‚¿ãƒ«ãŒ20å›å¾©ã—ãŸï¼\nä»£å„Ÿã¨ã—ã¦ä½“èª¿ãŒæ‚ªããªã£ãŸ(HP-5)ã€‚"); } else showMsg("æ®‹é«˜ä¸è¶³ã§ã™ã€‚"); } },
            { text: 'å‡ºã‚‹', cb: () => {} }
        ]);
    } else if(id === T.NPC_COWORKER.id) { showMsg("åŒåƒšã€Œã‚ã€ãŠã¯ã‚ˆã†â€¦â€¦ã€‚\nãŠã‚Œã€ã“ã®æ ªãŒä¸ŠãŒã£ãŸã‚‰ä¼šç¤¾è¾ã‚ã‚‹ã‚“ã â€¦â€¦ã€"); }
    // â–¼ãƒœã‚¹å¼±ä½“åŒ– (HP300->150, ATK30->15, DEF20->10)
    else if(id === T.BOSS_DESK.id) { showMsg("ãƒ–ãƒ©ãƒƒã‚¯ç¤¾é•·ã€ŒãŠã„å›ï¼æ°—åˆã¨æ ¹æ€§ã§è¦‹ã›ã¦ã¿ã‚ï¼ã€", null); setTimeout(()=> { closeMsg(); startBattle({ name: 'ãƒ–ãƒ©ãƒƒã‚¯ç¤¾é•·', hp: 150, maxHp: 150, atk: 15, def: 10, exp: 999, gold: 50000, sprite: 'boss', isBoss: true }); }, 2000); }
}

// --- ãƒãƒˆãƒ« ---
let curEnemy = null;
function startRandomEncounter() {
    if(state.mapId !== 'office') return; let e = {};
    // â–¼æ•µã®åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ¬ãƒ™ãƒ«è£œæ­£ã‚’å¼±ä½“åŒ–
    if(Math.random() < 0.5) { e.name = 'çµ¶å¯¾ä»Šæ—¥ä¸­ã®ç´æœŸ'; e.hp = 15+state.p.lv*2; e.maxHp=e.hp; e.atk = 5+state.p.lv*1; e.def = 2+Math.floor(state.p.lv/3); e.exp = 5; e.gold = 300; e.sprite = 'deadline'; }
    else { e.name = 'ç†ä¸å°½ãªä»•æ§˜å¤‰æ›´'; e.hp = 25+state.p.lv*2; e.maxHp=e.hp; e.atk = 8+state.p.lv*1; e.def = 3+Math.floor(state.p.lv/3); e.exp = 8; e.gold = 500; e.sprite = 'doc'; }
    startBattle(e);
}
function startBattle(enemy) {
    input.stopDir(); state.battleActive = true; curEnemy = enemy;
    document.getElementById('battle-screen').style.display = 'flex'; document.getElementById('enemy-name').innerText = `ã€æ€¥å‹Ÿã€‘${enemy.name} !`;
    const c = document.getElementById('enemy-sprite'), ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); ctx.drawImage(Sprites[enemy.sprite], 0, 0, 48, 48);
    document.getElementById('battle-msg').innerText = "ã©ã†å¯¾å¿œã™ã‚‹ï¼Ÿ"; document.querySelectorAll('#battle-cmds .btn').forEach(b => b.disabled = false);
}
function battleAction(cmd) {
    if(!state.battleActive) return; document.querySelectorAll('#battle-cmds .btn').forEach(b => b.disabled = true);
    if(cmd.id === 'run') { if(curEnemy.isBoss) { document.getElementById('battle-msg').innerText = "ç¤¾é•·å®¤ã‹ã‚‰ã¯é€ƒã’ã‚‰ã‚Œãªã„ï¼"; setTimeout(enemyTurn, 1500); } else { document.getElementById('battle-msg').innerText = "ãƒˆã‚¤ãƒ¬ã«é€ƒã’è¾¼ã‚“ã ï¼"; setTimeout(()=> { state.battleActive = false; document.getElementById('battle-screen').style.display = 'none'; }, 1500); } return; }
    if(state.p.mp < cmd.mp) { document.getElementById('battle-msg').innerText = "ãƒ¡ãƒ³ã‚¿ãƒ«é™ç•Œï¼ã‚¹ã‚­ãƒ«å¤±æ•—ï¼"; setTimeout(()=> document.querySelectorAll('#battle-cmds .btn').forEach(b => b.disabled = false), 1000); return; }
    state.p.mp -= cmd.mp; updateUI();
    let dmg = 0, msg = "";
    if(cmd.id === 'work') { dmg = Math.max(1, state.p.atk - curEnemy.def + Math.floor(Math.random()*3)); msg = `ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’å©ã„ãŸï¼\n${dmg} ã®é€²æ—ã‚’ç”Ÿã‚“ã ï¼`; }
    else if(cmd.id === 'smile') { dmg = 2; state.p.hp = Math.min(state.p.maxHp, state.p.hp + 5); msg = `æ„›æƒ³ç¬‘ã„ã§ã”ã¾ã‹ã—ã€\nä½“åŠ›ã‚’æ¸©å­˜ã—ãŸï¼`; }
    else if(cmd.id === 'blame') { dmg = Math.max(5, state.p.atk * 2 - curEnemy.def); msg = `è²¬ä»»ã‚’å›é¿ã—ã€${dmg} ã®å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`; }
    else if(cmd.id === 'allnight') { dmg = state.p.atk * 3; state.p.hp -= 10; msg = `å¾¹å¤œã§å¼·å¼•ã«çµ‚ã‚ã‚‰ã›ãŸï¼\n${dmg} ã®é€²æ—ï¼(å‘½ã‚’10å‰Šã£ãŸ)`; if(state.p.hp<=0) state.p.hp=1; updateUI(); }
    curEnemy.hp -= dmg; document.getElementById('battle-msg').innerText = msg;
    const scr = document.getElementById('battle-screen'); scr.style.transform = 'translate(10px, 10px)'; setTimeout(()=> scr.style.transform = 'translate(-10px, -10px)', 50); setTimeout(()=> scr.style.transform = 'translate(0, 0)', 100);
    if(curEnemy.hp <= 0) {
        setTimeout(() => {
            document.getElementById('battle-msg').innerText = `ã‚¿ã‚¹ã‚¯å®Œäº†ï¼\nè©•ä¾¡ ${curEnemy.exp} UP / çµ¦æ–™ ${curEnemy.gold}å†† ç²å¾—ï¼`;
            state.p.exp += curEnemy.exp; state.p.gold += curEnemy.gold; updateUI();
            if(curEnemy.isBoss) { setTimeout(() => { showMsg("è¦‹äº‹ã€é€€è·å±Šã‚’å©ãã¤ã‘ãŸï¼\nè‡ªç”±ãªç”Ÿæ´»ã®å§‹ã¾ã‚Šã ï¼\nã€œ ç¥ãƒ»é€€è·(ä¸€å¿œã‚¯ãƒªã‚¢) ã€œ\nâ€»çœŸã®ã‚¯ãƒªã‚¢ã¯ã‚¿ãƒ¯ãƒãƒ³è³¼å…¥ã§ã™"); state.battleActive = false; document.getElementById('battle-screen').style.display = 'none'; }, 2000); }
            else { setTimeout(() => { if(state.p.exp >= state.p.nextExp) { state.p.lv++; state.p.maxHp+=5; state.p.maxMp+=5; state.p.hp=state.p.maxHp; state.p.mp=state.p.maxMp; state.p.atk+=2; state.p.def+=1; state.p.nextExp=Math.floor(state.p.nextExp*1.5); updateUI(); showMsg(`Lv${state.p.lv} ã«ä¸ŠãŒã£ãŸï¼å…¨å›å¾©ï¼`); } state.battleActive = false; document.getElementById('battle-screen').style.display = 'none'; }, 1500); }
        }, 1500);
    } else setTimeout(enemyTurn, 1500);
}
function enemyTurn() {
    let dmg = Math.max(1, curEnemy.atk - state.p.def + Math.floor(Math.random()*3)); state.p.hp -= dmg; updateUI();
    document.getElementById('battle-msg').innerText = `${curEnemy.name} ã®ç†ä¸å°½ãªåœ§è¿«ï¼\n ${dmg} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
    const wrp = document.getElementById('game-wrapper'); wrp.style.transform = 'translate(5px, 0)'; setTimeout(()=> wrp.style.transform = 'translate(-5px, 0)', 50); setTimeout(()=> wrp.style.transform = 'translate(0, 0)', 100);
    if(state.p.hp <= 0) {
        setTimeout(() => {
            state.battleActive = false; document.getElementById('battle-screen').style.display = 'none';
            state.p.hp = state.p.maxHp; state.p.mp = state.p.maxMp; state.p.gold = Math.floor(state.p.gold / 2); updateUI();
            fadeTransition(() => { state.mapId = 'home'; state.p.x = 4*48; state.p.y = 6*48; showMsg("éåŠ´ã§å€’ã‚Œã¦ã—ã¾ã£ãŸâ€¦â€¦ã€‚\nåŒ»ç™‚è²»ã¨ã—ã¦è³‡ç”£ãŒåŠåˆ†é£›ã‚“ã ã€‚"); });
        }, 1500);
    } else setTimeout(() => { document.getElementById('battle-msg').innerText = "ã©ã†å¯¾å¿œã™ã‚‹ï¼Ÿ"; document.querySelectorAll('#battle-cmds .btn').forEach(b => b.disabled = false); }, 1500);
}

// --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
function update() {
    if(state.msgActive || state.battleActive || !state.job) return; if(document.getElementById('status-modal').style.display === 'flex') return;
    const p = state.p, map = maps[state.mapId]; let dx = 0, dy = 0;
    if (input.dir !== -1) { p.dir = input.dir; if(p.dir===0) dy=-CFG.SPEED; if(p.dir===2) dy=CFG.SPEED; if(p.dir===3) dx=-CFG.SPEED; if(p.dir===1) dx=CFG.SPEED; p.moving = true; } else { p.moving = false; p.anim = 0; }
    
    if (dx !== 0 || dy !== 0) {
        const nx = p.x + dx, ny = p.y + dy, ftX = nx + 16, ftR = nx + 32, ftY = ny + 24, ftB = ny + 46;
        const check = (x, y) => { let tx = Math.floor(x / CFG.TILE_SIZE), ty = Math.floor(y / CFG.TILE_SIZE); if(tx<0||tx>=map.w||ty<0||ty>=map.h) return false; return Object.values(T).find(t=>t.id===map.data[ty][tx]).walk; };
        
        if (check(ftX, ftY) && check(ftR, ftY) && check(ftX, ftB) && check(ftR, ftB)) {
            p.x = nx; p.y = ny; if(Math.floor(Date.now()/100)%2===0) p.anim = (p.anim === 0) ? 1 : 0;
            
            // --- ã‚µãƒœã‚Šç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  ---
            if (state.mapId !== 'office') {
                p.walkDist += Math.abs(dx) + Math.abs(dy);
                if (p.walkDist >= CFG.TILE_SIZE) {
                    p.walkDist -= CFG.TILE_SIZE;
                    p.stepsOutside++;
                    
                    if (p.stepsOutside >= 50) {
                        p.stepsOutside = 0;
                        input.stopDir();
                        showMsg("ãƒ–ãƒ©ãƒƒã‚¯ç¤¾é•·\nã€ŒãŠã„ï¼ï¼ï¼ã„ã¤ã¾ã§ã‚µãƒœã£ã¦ã„ã‚‹ï¼ï¼\nãŠå‰ã®ä»£ã‚ã‚Šãªã‚“ã¦ã„ãã‚‰ã§ã‚‚ã„ã‚‹ã‚“ã ãï¼ï¼\nä»Šã™ãå‡ºç¤¾ã—ã‚ï¼ï¼ã€", [
                            { text: 'ã²ãƒãƒï¼ã¯ã„ï¼', cb: () => {
                                fadeTransition(() => {
                                    state.mapId = 'office';
                                    state.p.x = 7 * 48;
                                    state.p.y = 18 * 48;
                                    state.p.hp = Math.max(1, state.p.hp - 5);
                                    state.p.mp = Math.max(1, state.p.mp - 5);
                                    updateUI();
                                    showMsg("é¦–æ ¹ã£ã“ã‚’æ´ã¾ã‚Œã€å¼·åˆ¶çš„ã«å‡ºç¤¾ã•ã›ã‚‰ã‚ŒãŸã€‚\næ¥µåº¦ã®ææ€–ã§ä½“åŠ›ã¨ãƒ¡ãƒ³ã‚¿ãƒ«ãŒå‰Šã‚‰ã‚ŒãŸâ€¦\n(HP/MP -5)");
                                });
                            }}
                        ]);
                        return;
                    }
                }
            } else {
                p.stepsOutside = 0;
                p.walkDist = 0;
            }
            
            // â–¼æ ªä¾¡ã®å¤‰å‹•ã‚¤ãƒ™ãƒ³ãƒˆ (ç™ºç”Ÿç‡ã‚’ 1/6 ã«æ¿€æ¸›ã€å¤‰å‹•å¹…ã‚‚ãƒã‚¤ãƒ«ãƒ‰ã«)
            if(Math.random() < 0.05) { 
                let decay = (1000 - state.marketPrice) * 0.01; 
                state.marketPrice = Math.max(10, Math.floor(state.marketPrice * (1 + (Math.random() * 0.2 - 0.1)) + decay)); 
            }
            if(Math.random() < 0.0005) {  // 0.003 -> 0.0005 ã«ç·©å’Œ
                let rnd = Math.random();
                if(rnd < 0.3) {  // æš´è½ç¢ºç‡ã‚’ 50% -> 30% ã«ä½ä¸‹
                    state.marketPrice = Math.max(10, Math.floor(state.marketPrice * 0.5)); // 0.2å€ -> 0.5å€ ã«ç·©å’Œ
                    showMsg("ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘\nã‚ªãƒ¯ãƒªHDã®æ¥­ç¸¾æ‚ªåŒ–æ‡¸å¿µã€‚\næ ªä¾¡ãŒä¸‹è½ã—ã¾ã—ãŸã€‚"); 
                }
                else if(rnd < 0.95) { // é«˜é¨°ç¢ºç‡ã‚’å¤§å¹…å¢—åŠ 
                    state.marketPrice = Math.floor(state.marketPrice * 1.5); 
                    showMsg("ã€å·å¤–é€Ÿå ±ã€‘\nã‚ªãƒ¯ãƒªHDãŒæ–°ã‚µãƒ¼ãƒ“ã‚¹ç™ºè¡¨ï¼\næ ªä¾¡ãŒæ€¥é¨°ã—ã¾ã—ãŸï¼"); 
                }
                else { // ä¸Šå ´å»ƒæ­¢ï¼ˆç´™ããšåŒ–ï¼‰ã¯æ¥µã‚ã¦ç¨€ã«
                    state.marketPrice = 10;
                    if(state.p.shares > 0) {
                        state.p.shares = 0; updateUI();
                        showMsg("ã€çµ¶æœ›ã€‘\nã‚ªãƒ¯ãƒªHDãŒä¸Šå ´å»ƒæ­¢ï¼ï¼\nä¿æœ‰ã—ã¦ã„ãŸæ ªã¯å…¨ã¦ç´™ããšã«ãªã£ãŸâ€¦");
                    } else {
                        showMsg("ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‘\nã‚ªãƒ¯ãƒªHDãŒä¸Šå ´å»ƒæ­¢ï¼ï¼\næ ªã‚’æŒã£ã¦ã„ãªãã¦åŠ©ã‹ã£ãŸâ€¦ã€‚");
                    }
                }
            }
            if(state.mapId === 'office' && Math.random() < CFG.ENCOUNTER_RATE) startRandomEncounter();
        }
    }
    checkEvents(); if(input.action) { interact(); input.action = false; }
    state.cam.x = Math.max(0, Math.min(p.x - CFG.SCREEN_W/2 + 24, map.w * CFG.TILE_SIZE - CFG.SCREEN_W)); state.cam.y = Math.max(0, Math.min(p.y - CFG.SCREEN_H/2 + 24, map.h * CFG.TILE_SIZE - CFG.SCREEN_H));
    if(map.w * CFG.TILE_SIZE < CFG.SCREEN_W) state.cam.x = -(CFG.SCREEN_W - map.w * CFG.TILE_SIZE)/2; if(map.h * CFG.TILE_SIZE < CFG.SCREEN_H) state.cam.y = -(CFG.SCREEN_H - map.h * CFG.TILE_SIZE)/2;
}

const ctx = document.getElementById('gameCanvas').getContext('2d'); ctx.imageSmoothingEnabled = false;
function draw() {
    if(!state.job) return; ctx.fillStyle = state.mapId==='city'?'#333':'#111'; ctx.fillRect(0,0,CFG.SCREEN_W, CFG.SCREEN_H);
    const map = maps[state.mapId], sx = Math.max(0, Math.floor(state.cam.x/CFG.TILE_SIZE)), ex = Math.min(map.w-1, sx+(CFG.SCREEN_W/CFG.TILE_SIZE)+1), sy = Math.max(0, Math.floor(state.cam.y/CFG.TILE_SIZE)), ey = Math.min(map.h-1, sy+(CFG.SCREEN_H/CFG.TILE_SIZE)+1);
    for(let y=sy; y<=ey; y++) {
        for(let x=sx; x<=ex; x++) {
            let id = map.data[y][x], px = x * CFG.TILE_SIZE - state.cam.x, py = y * CFG.TILE_SIZE - state.cam.y;
            if(id === T.ROAD.id) ctx.drawImage(Sprites.road, px, py, 48, 48);
            if(id === T.FLOOR.id) ctx.drawImage(Sprites.floor, px, py, 48, 48);
            if(id === T.WALL.id) ctx.drawImage(Sprites.wall, px, py, 48, 48);
            if(id === T.BED.id) ctx.drawImage(Sprites.bed, px, py, 48, 48);
            if(id === T.PC.id||id === T.DESK.id||id === T.BOSS_DESK.id) ctx.drawImage(Sprites.desk, px, py, 48, 48);
            if(id === T.CONBINI.id) ctx.drawImage(Sprites.conbini, px, py, 48, 48);
            if(id === T.CASINO.id) ctx.drawImage(Sprites.casino, px, py, 48, 48);
            if(id === T.NPC_COWORKER.id) ctx.drawImage(Sprites.npc, px, py, 48, 48);
            if(id === T.BOSS_DESK.id) ctx.drawImage(Sprites.boss, px, py-10, 48, 48);
            if(id === T.DOOR.id) { ctx.fillStyle = 'rgba(100,200,255,0.3)'; ctx.fillRect(px,py,48,48); }
        }
    }
    const px = state.p.x - state.cam.x, py = state.p.y - state.cam.y, bob = state.p.anim === 1 ? -2 : 0;
    ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(px+24, py+40, 16, 6, 0, 0, Math.PI*2); ctx.fill();
    ctx.drawImage(Sprites.player, px, py+bob, 48, 48);
}
function loop() { update(); draw(); requestAnimationFrame(loop); }
</script>
</body>
</html>
