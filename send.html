<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PyScript リモートコントローラー</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #2c3e50; color: white; }
        .card { background: #34495e; padding: 20px; border-radius: 8px; width: 300px; }
        input, button { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
        button { background: #e74c3c; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { background: #c0392b; }
        #response { color: #2ecc71; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>⚡ コントロールパネル</h2>
    <label>指令内容:</label>
    <input type="text" id="instruction-input" value="システム再起動">
    
    <button id="send-btn">指令を送信 (EXECUTE)</button>

    <p>サーバーからの応答:</p>
    <div id="response">待機中...</div>
</div>

<script type="py">
import json
from pyodide.ffi import create_proxy
from pyodide.http import pyfetch
from js import document

async def send_command(event):
    btn = document.getElementById("send-btn")
    res_div = document.getElementById("response")
    instruction_text = document.getElementById("instruction-input").value
    
    btn.disabled = True
    res_div.innerText = "送信中..."

    # 送信するデータを辞書で作る（PythonバックエンドのCommandクラスと合わせる）
    payload = {
        "instruction": instruction_text,
        "target_id": 1
    }

    try:
        # バックエンド (FastAPI) に対してPOSTリクエストを送信
        # ※バックエンドが別のPCにある場合は、localhostをそのPCのIPアドレスに変える
        response = await pyfetch(
            "http://localhost:8000/api/command",
            method="POST",
            headers={"Content-Type": "application/json"},
            body=json.dumps(payload)
        )

        if response.ok:
            data = await response.json()
            res_div.innerText = data["message"]
        else:
            res_div.innerText = f"通信エラー: {response.status}"
            res_div.style.color = "#e74c3c"
            
    except Exception as e:
        res_div.innerText = "エラー: サーバーに接続できません。\n(サーバーが起動しているか確認してください)"
        res_div.style.color = "#e74c3c"
        print(e)
        
    finally:
        btn.disabled = False

# ボタンにイベントを登録
document.getElementById("send-btn").addEventListener("click", create_proxy(send_command))
</script>

</body>
</html>
