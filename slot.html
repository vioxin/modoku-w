<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚‚ã†ã©ãã‚¹ãƒ­ãƒƒãƒˆ â˜£ï¸</title>
    <style>
        body {
            background-color: #000;
            color: #39ff14;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .casino-frame {
            border: 5px double #39ff14;
            padding: 40px;
            background: rgba(0, 20, 0, 0.9);
            box-shadow: 0 0 20px #39ff14;
            text-align: center;
            border-radius: 20px;
        }
        .reels {
            display: flex;
            gap: 20px;
            font-size: 80px;
            margin: 30px 0;
            background: #111;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff00ff;
        }
        .point-display {
            font-size: 24px;
            margin-bottom: 10px;
        }
        button {
            background: #39ff14;
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 #1b8a0a;
        }
        button:active { transform: translateY(5px); box-shadow: none; }
        button:disabled { background: #555; cursor: not-allowed; }
        #status-msg { margin-top: 20px; height: 24px; color: #ff00ff; }
    </style>
</head>
<body>

<div class="casino-frame">
    <h1>â˜£ï¸ MOU-DOKU SLOT â˜£ï¸</h1>
    <div class="point-display">æ‰€æŒé‡‘: <span id="pt-val">---</span> pt</div>
    
    <div class="reels">
        <div id="r1">ğŸ’€</div>
        <div id="r2">ğŸ’€</div>
        <div id="r3">ğŸ’€</div>
    </div>

    <button id="spinBtn" onclick="runSlot()">SPIN (100pt)</button>
    <div id="status-msg"></div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyCNH7nojIIXwwDqmnRBf6YTMdVAohZG14KShr0Bnms-fYo5GukyJ5l2XuztOU7BZF7/exec";
    const userId = localStorage.getItem("userId"); 
    const symbols = ['ğŸ’€', 'â˜£ï¸', 'ğŸ§ª', 'ğŸ©¸', 'ğŸ’', '7ï¸âƒ£'];

    // --- 1. ãƒã‚¤ãƒ³ãƒˆã ã‘ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•° ---
    async function loadPoints() {
        if (!userId) {
            document.getElementById('status-msg').innerText = "ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãœã€‚";
            return;
        }
        try {
            // GASå´ã«ãƒã‚¤ãƒ³ãƒˆç¢ºèªç”¨ã®actionï¼ˆcheckPlanã‚„getUserDataãªã©ï¼‰ãŒã‚ã‚‹æƒ³å®š
            // ãªã‘ã‚Œã°ä»Šå›ã®slotSpinã®å¼•æ•°èª¿æ•´ãªã©ã§å¯¾å¿œå¯èƒ½
            const res = await fetch(`${GAS_URL}?action=checkPlan&name=${userId}`);
            const data = await res.json();
            // GASå´ã‹ã‚‰ã€Œpointã€ã¨ã„ã†åå‰ã§è¿”ã£ã¦ãã‚‹æƒ³å®š
            if (data.point !== undefined) {
                document.getElementById('pt-val').innerText = data.point;
            } else if (data.newPoint !== undefined) {
                document.getElementById('pt-val').innerText = data.newPoint;
            }
        } catch (e) {
            console.error("ãƒã‚¤ãƒ³ãƒˆãƒ­ãƒ¼ãƒ‰å¤±æ•—:", e);
        }
    }

    // --- 2. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ ---
    window.onload = loadPoints;

    async function runSlot() {
        const btn = document.getElementById('spinBtn');
        const msg = document.getElementById('status-msg');
        btn.disabled = true;
        msg.innerText = "é€šä¿¡ä¸­...";

        try {
            const res = await fetch(`${GAS_URL}?action=slotSpin&name=${userId}`);
            const data = await res.json();

            if (!data.success) {
                msg.innerText = data.msg;
                btn.disabled = false;
                return;
            }

            // æ¼”å‡ºé–‹å§‹
            let count = 0;
            const timer = setInterval(() => {
                document.getElementById('r1').innerText = symbols[Math.floor(Math.random()*symbols.length)];
                document.getElementById('r2').innerText = symbols[Math.floor(Math.random()*symbols.length)];
                document.getElementById('r3').innerText = symbols[Math.floor(Math.random()*symbols.length)];
                count++;

                if (count > 20) {
                    clearInterval(timer);
                    // çµæœåæ˜ 
                    const resultSym = data.win ? (data.item === '777' ? '7ï¸âƒ£' : 'ğŸ’') : 'ğŸ’€';
                    document.getElementById('r1').innerText = resultSym;
                    document.getElementById('r2').innerText = resultSym;
                    document.getElementById('r3').innerText = data.win ? resultSym : 'ğŸ§ª';
                    
                    // --- 3. ã‚¹ãƒ­ãƒƒãƒˆçµ‚äº†æ™‚ã«æœ€æ–°ãƒã‚¤ãƒ³ãƒˆã‚’åæ˜  ---
                    document.getElementById('pt-val').innerText = data.newPoint;
                    msg.innerText = data.win ? `ğŸ‰ å½“ãŸã‚Šï¼ ${data.payout}ptç²å¾—ï¼` : "ãƒã‚ºãƒ¬...";
                    btn.disabled = false;
                    
                    // å¿µã®ãŸã‚å°‘ã—å¾Œã«å…¨ä½“ãƒ­ãƒ¼ãƒ‰ã‚‚ã‹ã‘ã¦åŒæœŸã‚’ç¢ºå®Ÿã«ã™ã‚‹
                    setTimeout(loadPoints, 1000);
                }
            }, 50);

        } catch (e) {
            msg.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãœã€‚";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
