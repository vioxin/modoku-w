<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Discord ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡</title>
    <style>
        body { font-family: sans-serif; background: #2c2f33; color: white; padding: 20px; }
        #chat-box { background: #36393f; padding: 15px; height: 400px; overflow-y: auto; border-radius: 8px; margin-bottom: 15px;}
        .message { margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .author { font-weight: bold; color: #7289da; }
        .bot-tag { background: #5865f2; color: white; font-size: 0.7em; padding: 2px 5px; border-radius: 3px; margin-left: 5px; vertical-align: middle;}
        
        /* ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œè€…ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .interaction { font-size: 0.85em; color: #b9bbbe; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .interaction strong { color: #7289da; cursor: pointer; }
        
        /* åŸ‹ã‚è¾¼ã¿(Embed)ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .embed { border-left: 4px solid #202225; background: #2f3136; padding: 10px; margin-top: 5px; border-radius: 4px; max-width: 400px; }
        .embed-title { font-weight: bold; margin-bottom: 5px; }
        .embed-desc { font-size: 0.9em; margin-bottom: 5px; white-space: pre-wrap; }
        .embed-image img { max-width: 100%; border-radius: 4px; margin-top: 5px; }

        .controls { margin-bottom: 15px; display: flex; gap: 10px; }
        input[type="text"] { flex-grow: 1; padding: 10px; border-radius: 5px; border: none; background: #40444b; color: white; }
        button { padding: 10px 15px; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .send-btn { background: #5865f2; }
        .send-btn:hover { background: #4752c4; }
        .reload-btn { background: #43b581; } 
        .reload-btn:hover { background: #3ca374; }
        .empty-msg { color: #99aab5; font-style: italic; text-align: center; padding-top: 50px; }
    </style>
</head>
<body>

    <h2>ğŸŒ Discord â‡” Web ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ</h2>
    
    <div class="controls">
        <button class="reload-btn" onclick="fetchMessages()">ğŸ”„ æœ€æ–°ã®å±¥æ­´ã‚’æ‰‹å‹•ã§èª­ã¿è¾¼ã‚€</button>
    </div>

    <div id="chat-box">é€šä¿¡ä¸­...</div>

    <div class="controls">
        <input type="text" id="msg-input" placeholder="Discordã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡...">
        <button class="send-btn" onclick="sendMessage()">é€ä¿¡ã™ã‚‹</button>
    </div>

    <script>
        // âš ï¸ ã“ã“ã¯ã‚ãªãŸã®Renderã®URLã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼
        const SERVER_URL = "https://kankun-app.onrender.com/";

        // ğŸ’¡ è¿½åŠ ï¼šå‰å›ã®è¡¨ç¤ºå†…å®¹ã‚’è¨˜æ†¶ã—ã¦ãŠãå¤‰æ•°
        let lastHtml = '';

        async function fetchMessages() {
            try {
                const response = await fetch(`${SERVER_URL}/api/messages`);
                const messages = await response.json();
                
                const chatBox = document.getElementById('chat-box');

                const isScrolledToBottom = chatBox.scrollHeight - chatBox.clientHeight <= chatBox.scrollTop + 50;
                const previousScrollTop = chatBox.scrollTop;
                
                let newHtml = '';
                
                if (messages.length === 0) {
                    newHtml = '<div class="empty-msg">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>Discordã§ä½•ã‹ç™ºè¨€ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼</div>';
                } else {
                    messages.forEach(msg => {
                        let html = `<div class="message">`;
                        
                        if (msg.interaction) {
                            html += `<div class="interaction">
                                        <span>${msg.interaction.user} ã•ã‚“ãŒ <strong>/${msg.interaction.name}</strong> ã‚’ä½¿ç”¨ã—ã¾ã—ãŸ</span>
                                     </div>`;
                        }
                        
                        let botTag = msg.is_bot ? `<span class="bot-tag">ã‚¢ãƒ—ãƒª</span>` : '';
                        html += `<div><span class="author">${msg.author}</span>${botTag}</div>`;
                        
                        if (msg.content) {
                            html += `<div style="margin-top: 5px;">${msg.content}</div>`;
                        }
                        
                        if (msg.embeds && msg.embeds.length > 0) {
                            msg.embeds.forEach(embed => {
                                html += `<div class="embed">`;
                                if (embed.title) html += `<div class="embed-title">${embed.title}</div>`;
                                if (embed.description) html += `<div class="embed-desc">${embed.description}</div>`;
                                if (embed.image) html += `<div class="embed-image"><img src="${embed.image}" alt="åŸ‹ã‚è¾¼ã¿ç”»åƒ"></div>`;
                                html += `</div>`;
                            });
                        }
                        
                        html += `</div>`;
                        newHtml += html;
                    });
                }

                // ğŸ’¡ ã€è¶…é‡è¦ã€‘æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªãã€å‰å›ã¨å…¨ãåŒã˜å†…å®¹ãªã‚‰ã“ã“ã§ã‚¹ãƒˆãƒƒãƒ—ï¼ï¼ˆç”»é¢ã‚’æ›¸ãæ›ãˆãªã„ï¼‰
                if (newHtml === lastHtml) {
                    return; 
                }

                // æ–°ã—ã„å†…å®¹ã ã£ãŸå ´åˆã®ã¿ã€ç”»é¢ã‚’æ›¸ãæ›ãˆã¦è¨˜éŒ²ã‚’æ›´æ–°ã™ã‚‹
                lastHtml = newHtml;
                chatBox.innerHTML = newHtml;
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®å¾©å…ƒ
                if (isScrolledToBottom) {
                    chatBox.scrollTop = chatBox.scrollHeight;
                } else {
                    chatBox.scrollTop = previousScrollTop;
                }

            } catch (error) {
                console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                const errorHtml = '<div class="empty-msg" style="color: #f04747;">ã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡ã§ãã¾ã›ã‚“ã€‚<br>RenderãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒãƒ©ã¤ãã‚’é˜²æ­¢
                if (lastHtml !== errorHtml) {
                    document.getElementById('chat-box').innerHTML = errorHtml;
                    lastHtml = errorHtml;
                }
            }
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value;
            if (!text) return;

            try {
                await fetch(`${SERVER_URL}/api/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                input.value = ''; 
                fetchMessages(); 
            } catch (error) {
                alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼");
            }
        }

        setInterval(fetchMessages, 2000);
        fetchMessages();
    </script>
</body>
</html>
