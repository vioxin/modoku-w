<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Discord ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡</title>
    <style>
        body { font-family: sans-serif; background: #2c2f33; color: white; padding: 20px; }
        #chat-box { background: #36393f; padding: 15px; height: 400px; overflow-y: auto; border-radius: 8px; margin-bottom: 15px;}
        .message { margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .author { font-weight: bold; color: #7289da; }
        .bot-tag { background: #5865f2; color: white; font-size: 0.7em; padding: 2px 5px; border-radius: 3px; margin-left: 5px; vertical-align: middle;}
        
        /* ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œè€…ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .interaction { font-size: 0.85em; color: #b9bbbe; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .interaction strong { color: #7289da; cursor: pointer; }
        
        /* åŸ‹ã‚è¾¼ã¿(Embed)ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .embed { border-left: 4px solid #202225; background: #2f3136; padding: 10px; margin-top: 5px; border-radius: 4px; max-width: 400px; }
        .embed-title { font-weight: bold; margin-bottom: 5px; }
        .embed-desc { font-size: 0.9em; margin-bottom: 5px; white-space: pre-wrap; }
        .embed-image img { max-width: 100%; border-radius: 4px; margin-top: 5px; }

        .controls { margin-bottom: 15px; display: flex; gap: 10px; }
        input[type="text"] { flex-grow: 1; padding: 10px; border-radius: 5px; border: none; background: #40444b; color: white; }
        button { padding: 10px 15px; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .send-btn { background: #5865f2; }
        .send-btn:hover { background: #4752c4; }
        .reload-btn { background: #43b581; } 
        .reload-btn:hover { background: #3ca374; }
        .empty-msg { color: #99aab5; font-style: italic; text-align: center; padding-top: 50px; }
    </style>
</head>
<body>

    <h2>ğŸŒ Discord â‡” Web ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ</h2>
    
    <div class="controls">
        <button class="reload-btn" onclick="fetchMessages()">ğŸ”„ æœ€æ–°ã®å±¥æ­´ã‚’æ‰‹å‹•ã§èª­ã¿è¾¼ã‚€</button>
    </div>

    <div id="chat-box">é€šä¿¡ä¸­...</div>

    <div class="controls">
        <select id="mention-select" style="padding: 10px; border-radius: 5px; background: #40444b; color: white; border: none;">
            <option value="">ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ãªã„</option>
        </select>
        <input type="file" id="image-input" accept="image/*" style="color: white; padding: 10px;">
    </div>

    <div class="controls">
        <input type="text" id="msg-input" placeholder="Discordã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡...">
        <button class="send-btn" onclick="sendMessage()">é€ä¿¡ã™ã‚‹</button>
    </div>

    <script>
        // âš ï¸ ã“ã“ã¯ã‚ãªãŸã®Renderã®URLã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼
        const SERVER_URL = "https://kankun-app.onrender.com/";

        let lastHtml = '';

        // ğŸŒŸè¿½åŠ ï¼šDiscordã®ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«å…¥ã‚Œã‚‹
        async function fetchMembers() {
            try {
                const response = await fetch(`${SERVER_URL}/api/members`);
                const members = await response.json();
                const select = document.getElementById('mention-select');
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = `@${member.name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        async function fetchMessages() {
            try {
                const response = await fetch(`${SERVER_URL}/api/messages`);
                const messages = await response.json();
                
                const chatBox = document.getElementById('chat-box');
                const isScrolledToBottom = chatBox.scrollHeight - chatBox.clientHeight <= chatBox.scrollTop + 50;
                const previousScrollTop = chatBox.scrollTop;
                
                let newHtml = '';
                
                if (messages.length === 0) {
                    newHtml = '<div class="empty-msg">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>Discordã§ä½•ã‹ç™ºè¨€ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼</div>';
                } else {
                    messages.forEach(msg => {
                        let html = `<div class="message">`;
                        
                        if (msg.interaction) {
                            html += `<div class="interaction">
                                        <span>${msg.interaction.user} ã•ã‚“ãŒ <strong>/${msg.interaction.name}</strong> ã‚’ä½¿ç”¨ã—ã¾ã—ãŸ</span>
                                     </div>`;
                        }
                        
                        let botTag = msg.is_bot ? `<span class="bot-tag">ã‚¢ãƒ—ãƒª</span>` : '';
                        html += `<div><span class="author">${msg.author}</span>${botTag}</div>`;
                        
                        if (msg.content) {
                            html += `<div style="margin-top: 5px;">${msg.content}</div>`;
                        }
                        
                        // åŸ‹ã‚è¾¼ã¿ (Embed) ã®è¡¨ç¤ºï¼ˆã“ã‚Œã¾ã§ã®ã‚³ãƒ¼ãƒ‰ï¼‰
                        if (msg.embeds && msg.embeds.length > 0) {
                            msg.embeds.forEach(embed => {
                                html += `<div class="embed">`;
                                if (embed.title) html += `<div class="embed-title">${embed.title}</div>`;
                                if (embed.description) html += `<div class="embed-desc">${embed.description}</div>`;
                                if (embed.image) html += `<div class="embed-image"><img src="${embed.image}" alt="åŸ‹ã‚è¾¼ã¿ç”»åƒ"></div>`;
                                html += `</div>`;
                            });
                        }
                        
                        // ğŸŒŸ ã“ã“ã‹ã‚‰è¿½åŠ ï¼šæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«(Attachments)ã®è¡¨ç¤º
                        if (msg.attachments && msg.attachments.length > 0) {
                            msg.attachments.forEach(att => {
                                // ã‚‚ã—ãƒ•ã‚¡ã‚¤ãƒ«ãŒã€Œç”»åƒ (image)ã€ã ã£ãŸã‚‰
                                if (att.content_type && att.content_type.startsWith('image/')) {
                                    html += `<div class="embed-image"><img src="${att.url}" alt="${att.filename}" style="max-width: 100%; border-radius: 4px; margin-top: 5px;"></div>`;
                                } 
                                // ç”»åƒä»¥å¤–ã®æ™®é€šã®ãƒ•ã‚¡ã‚¤ãƒ« (PDFã€zipã€txtãªã©) ã ã£ãŸã‚‰
                                else {
                                    html += `<div style="margin-top: 5px; background: #2f3136; padding: 10px; border-radius: 5px; display: inline-block;">
                                                ğŸ“ <a href="${att.url}" target="_blank" style="color: #00b0f4; text-decoration: none; font-weight: bold;">${att.filename}</a>
                                             </div>`;
                                }
                            });
                        }
                        // ğŸŒŸ è¿½åŠ ã“ã“ã¾ã§
                        
                        html += `</div>`;
                        newHtml += html;
                    });
                }

                if (newHtml === lastHtml) return; 

                lastHtml = newHtml;
                chatBox.innerHTML = newHtml;
                
                if (isScrolledToBottom) {
                    chatBox.scrollTop = chatBox.scrollHeight;
                } else {
                    chatBox.scrollTop = previousScrollTop;
                }
            } catch (error) {
                console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        // ğŸŒŸå¤‰æ›´ï¼šãƒ†ã‚­ã‚¹ãƒˆãƒ»ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒ»ç”»åƒã‚’ã¾ã¨ã‚ã¦é€ä¿¡ã™ã‚‹
        async function sendMessage() {
            const textInput = document.getElementById('msg-input');
            const text = textInput.value;
            const mentionId = document.getElementById('mention-select').value;
            const imageInput = document.getElementById('image-input');
            const imageFile = imageInput.files[0];

            if (!text && !imageFile) return;

            // ç”»åƒãªã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹ãŸã‚ã®ç‰¹æ®Šãªç®± (FormData)
            const formData = new FormData();
            if (text) formData.append('text', text);
            if (mentionId) formData.append('mention_id', mentionId);
            if (imageFile) formData.append('image', imageFile);

            try {
                // FormData ã‚’é€ã‚‹ã¨ãã¯ headers ã® Content-Type ã¯æ›¸ãã¾ã›ã‚“ï¼ˆè‡ªå‹•ã§è¨­å®šã•ã‚Œã¾ã™ï¼‰
                await fetch(`${SERVER_URL}/api/send`, {
                    method: 'POST',
                    body: formData
                });
                
                // é€ä¿¡å¾Œã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹
                textInput.value = ''; 
                document.getElementById('mention-select').value = '';
                imageInput.value = ''; 
                
                fetchMessages(); 
            } catch (error) {
                alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼");
            }
        }

        setInterval(fetchMessages, 2000);
        fetchMessages();
        fetchMembers(); // ğŸŒŸèµ·å‹•æ™‚ã«ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    </script>
</body>
</html>
